<!DOCTYPE html>
<html lang="de">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Saarcade Admin - Mit Bildupload</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #ecf0f1;
    color: #2c3e50;
    line-height: 1.6;
    min-height: 100vh;
}

/* Sidebar Container */
.page-container {
    display: flex;
    min-height: 100vh;
}

/* Sidebar Navigation */
.sidebar {
    width: 280px;
    background-color: #2c3e50;
    color: white;
    padding: 0;
    box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    overflow-y: auto;
    max-height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 1000;
}

.sidebar-header {
    padding: 20px;
    background-color: rgba(0,0,0,0.2);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.sidebar-header h2 {
    font-size: 1.3em;
    margin-bottom: 5px;
}

.sidebar-header p {
    font-size: 0.85em;
    opacity: 0.8;
}

.nav-menu {
    list-style: none;
    padding: 10px 0;
}

.nav-item {
    margin-bottom: 2px;
}

.nav-link {
    display: block;
    padding: 12px 20px;
    color: white;
    text-decoration: none;
    transition: background-color 0.3s;
    cursor: pointer;
}

.nav-link:hover {
    background-color: rgba(255,255,255,0.1);
}

.nav-link.active {
    background-color: #3498db;
    border-left: 4px solid white;
}

.nav-category {
    padding: 10px 20px;
    font-size: 0.85em;
    text-transform: uppercase;
    opacity: 0.6;
    margin-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.1);
}

/* Main Content Area */
.main-content {
    flex: 1;
    margin-left: 280px;
    padding: 20px;
    overflow-y: auto;
    max-width: calc(100% - 280px);
    width: calc(100% - 280px);
}

.page-content {
    display: none;
    padding: 0;
    width: 100%;
}

.page-content[style*="display: block"] {
    display: block;
}
        
.page-header {
    background: white;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.page-header h1 {
    font-size: 1.8em;
    color: #2c3e50;
    margin: 0;
}

.page-header .breadcrumb {
    color: #7f8c8d;
    font-size: 0.9em;
    margin-top: 5px;
}
        .api-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .api-status.connected {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .api-status.error {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.5);
        }

.container {
    /* Container ist jetzt im main-content, kein max-width mehr n√∂tig */
    padding: 0;
}

.tabs {
    display: none; /* Tabs werden durch Sidebar ersetzt */
}
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            font-size: 0.9em;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 4px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .btn-secondary { background: linear-gradient(135deg, #a0aec0, #718096); }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-top: 15px;
            font-size: 0.9em;
        }

        .data-table th, .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 0.85em;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .data-table tr.selected {
            background: #e6f3ff;
        }

        .checkbox-cell {
            width: 30px;
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

.card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card-header {
    font-size: 1.2em;
    font-weight: 600;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #ecf0f1;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.grid-2-cols {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.grid-3-cols {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}
        
.stock-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}
        
.stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #3498db;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

.stat-value {
    font-size: 2em;
    font-weight: bold;
    color: #2c3e50;
    margin: 10px 0;
}

.stat-label {
    color: #7f8c8d;
    font-size: 0.9em;
}
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            font-size: 0.9em;
        }

        .toolbar {
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .selection-info {
            background: #e6f3ff;
            color: #1a365d;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: auto;
        }

        .alert {
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .alert-success {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #1a202c;
            border-left: 4px solid #38a169;
        }

        .alert-error {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            color: #1a202c;
            border-left: 4px solid #e53e3e;
        }

        .alert-info {
            background: linear-gradient(135deg, #bee3f8, #90cdf4);
            color: #1a202c;
            border-left: 4px solid #3182ce;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ddd;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .photo-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .photo-upload:hover {
            background: #f8f9ff;
            border-color: #5a67d8;
        }

        .photo-upload.dragover {
            background: #e6f3ff;
            border-color: #3182ce;
        }

        .photo-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            object-fit: cover;
            margin: 10px auto;
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-upload-progress {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            display: none;
        }

        .photo-actions {
            margin-top: 10px;
            display: none;
        }

        .photo-preview-container.has-image .photo-actions {
            display: block;
        }

        .product-image-cell {
            width: 60px;
            text-align: center;
            padding: 5px;
        }

        .product-image-preview {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            border: 2px solid #e2e8f0;
        }

        .product-emoji-fallback {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            background: #f7fafc;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
        }

/* Hamburger Menu Button */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1100;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-size: 1.2em;
        }

        .menu-toggle:active {
            transform: scale(0.95);
        }

        /* Sidebar Overlay f√ºr Mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        @media (max-width: 768px) {
            /* Hamburger Menu anzeigen */
            .menu-toggle {
                display: block;
            }

            /* Sidebar standardm√§√üig verstecken */
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            /* Sidebar anzeigen wenn aktiv */
            .sidebar.active {
                transform: translateX(0);
            }

            /* Overlay anzeigen wenn Sidebar aktiv */
            .sidebar-overlay.active {
                display: block;
            }

            /* Main Content auf volle Breite */
            .main-content {
                margin-left: 0;
                padding: 70px 15px 20px 15px;
            }

            /* Page Header anpassen */
            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .page-header h1 {
                font-size: 1.4em;
            }

            /* Dashboard Grid auf 1 Spalte */
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

           /* Alle Grid-Layouts auf 1 Spalte */
            .grid-2-cols,
            .grid-3-cols {
                grid-template-columns: 1fr;
            }
            
            /* Stock Grid auf 1 Spalte */
            .stock-grid {
                grid-template-columns: 1fr;
            }
            
            /* Toolbar vertikal stapeln */
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            /* Form Grid auf 1 Spalte */
            .form-grid {
                grid-template-columns: 1fr;
            }

            /* Container Padding */
            .container {
                padding: 10px;
            }

            /* Tabellen scrollbar machen */
            .table-container {
                overflow-x: auto;
            }

            .data-table {
                min-width: 600px;
            }

            /* Buttons volle Breite auf Mobile */
            .toolbar .btn,
            .form-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
    </style>
</head>
<body>

    <script>
// Login-Schutz f√ºr Admin mit Ablauf-Pr√ºfung
(function() {
    const loginDataStr = localStorage.getItem('adminLogin');
    if (!loginDataStr) {
        window.location.href = '/login-admin.html';
        return;
    }
    
    try {
        const loginData = JSON.parse(loginDataStr);
        
        // Pr√ºfe Ablauf
        if (loginData.expires && Date.now() > loginData.expires) {
            localStorage.removeItem('adminLogin');
            window.location.href = '/login-admin.html';
            return;
        }
        
        const user = loginData.user;
        if (!user || user.role !== 'admin') {
            localStorage.removeItem('adminLogin');
            window.location.href = '/login-admin.html';
        }
    } catch (e) {
        localStorage.removeItem('adminLogin');
        window.location.href = '/login-admin.html';
    }
})();
    </script>v
    
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px; font-weight: 600;">Lade Daten...</p>
        </div>
    </div>

<div class="page-container">
    <!-- Hamburger Menu Button -->
    <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="closeMobileMenu()"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>üéÆ Saarcade Admin</h2>
            <p>Flipper- und Arcademuseum e.V.</p>
            <div class="api-status" id="apiStatus" style="margin-top: 10px; font-size: 0.85em;">üîÑ Verbinde...</div>
        </div>
        <nav>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showTab('dashboard'); return false;">
                        üìä Dashboard
                    </a>
                </li>
                
                <li class="nav-category">Verwaltung</li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('users'); return false;">
                        üë• Mitglieder
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('products'); return false;">
                        üì¶ Produkte
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('clothing'); return false;">
                        üëï Kleidung
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('orders'); return false;">
                        üì¶ Bestellungen
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('stock'); return false;">
                        üìä Bestandsverwaltung
                    </a>
                </li>
                
                <li class="nav-category">Finanzen</li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('transactions'); return false;">
                        üí∞ Transaktionen
                    </a>
                </li>
                
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('billing'); return false;">
                        üìã Abrechnung
                    </a>
                </li>
                
                <li class="nav-category">System</li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showTab('settings'); return false;">
                        ‚öôÔ∏è Einstellungen
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Page (wird zu einem page-content) -->
        <div id="dashboard-page" class="page-content" style="display: block;">
            <div class="page-header">
                <div>
                    <h1>Dashboard</h1>
                    <div class="breadcrumb">√úbersicht / Dashboard</div>
                </div>
                <button onclick="logoutAdmin()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üö™ Logout
                </button>
            </div>

<!-- Dashboard Statistiken -->
<div class="dashboard-grid">
    <div class="stat-card" onclick="showTab('users')" style="border-left-color: #9b59b6; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div class="stat-label">Vereinsmitglieder</div>
        <div class="stat-value" id="memberCount">-</div>
        <div style="color: #666; font-size: 0.85em;">Registriert</div>
    </div>
    <div class="stat-card" onclick="showTab('products')" style="border-left-color: #27ae60; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div class="stat-label">Produkte</div>
        <div class="stat-value" id="productCount">-</div>
        <div style="color: #666; font-size: 0.85em;">Im Sortiment</div>
    </div>
    <div class="stat-card" onclick="showTab('transactions')" style="border-left-color: #f39c12; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div class="stat-label">Offene Transaktionen</div>
        <div class="stat-value" id="transactionCount">-</div>
        <div style="color: #666; font-size: 0.85em;">Nicht abgerechnet</div>
    </div>
    <div class="stat-card" onclick="showTab('billing')" style="border-left-color: #e74c3c; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div class="stat-label">Offener Betrag</div>
        <div class="stat-value"><span id="todayRevenue">-</span> ‚Ç¨</div>
        <div style="color: #666; font-size: 0.85em;">Ausstehend</div>
    </div>
</div>
            
            <!-- Artikelbest√§nde √úbersicht -->
            <div class="card">
<div class="card-header">üì¶ Artikelbest√§nde und Warnungen</div>
<div class="stock-grid">
    <div onclick="showStockDetails('critical')" style="padding: 15px; background: #fff5f5; border-left: 4px solid #e74c3c; border-radius: 4px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
    <div style="font-size: 0.85em; color: #666;">Kritischer Bestand</div>
    <div style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">
        <span id="criticalStock">0</span> Artikel
    </div>
    <div style="font-size: 0.75em; color: #666;">zwischen 1 und 10</div>
</div>
<div onclick="showStockDetails('warning')" style="padding: 15px; background: #fffbeb; border-left: 4px solid #f39c12; border-radius: 4px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
    <div style="font-size: 0.85em; color: #666;">Warnungen</div>
    <div style="font-size: 1.5em; font-weight: bold; color: #f39c12;">
        <span id="warningStock">0</span> Artikel
    </div>
    <div style="font-size: 0.75em; color: #666;">Bestand ‚â§ Mindestbestand</div>
</div>
<div onclick="showStockDetails('other')" style="padding: 15px; background: #f0f9ff; border-left: 4px solid #9b59b6; border-radius: 4px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
    <div style="font-size: 0.85em; color: #666;">Nicht verf√ºgbar</div>
    <div style="font-size: 1.5em; font-weight: bold; color: #9b59b6;">
        <span id="otherStock">0</span> Artikel
    </div>
    <div style="font-size: 0.75em; color: #666;">Bestand ‚â§ 0</div>
                    </div>
                </div>
            </div>
        
        <!-- NEUE DASHBOARD WIDGETS -->
        <div class="grid-2-cols" style="margin-top: 20px;">
            
            <!-- Top 5 Produkte -->
            <div class="card">
                <div class="card-header">üèÜ Top 5 Produkte (30 Tage)</div>
                <div id="topProductsList" style="padding: 10px;">
                    <div style="text-align: center; padding: 20px; color: #666;">Lade Daten...</div>
                </div>
            </div>

            <!-- Offene Kleidungsbestellungen -->
            <div class="card">
                <div class="card-header">üëï Offene Kleidungsbestellungen</div>
                <div id="pendingClothingOrdersList" style="padding: 10px;">
                <div style="text-align: center; padding: 20px; color: #666;">Lade Daten...</div>
            </div>
        </div>
            
            <!-- SEPA Status -->
            <div class="card">
                <div class="card-header">üí≥ SEPA-Status</div>
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #666;">SEPA aktiviert:</span>
                        <strong style="color: #27ae60;"><span id="sepaActiveCount">-</span> Mitglieder</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span style="color: #666;">Ohne SEPA:</span>
                        <strong style="color: #e74c3c;"><span id="sepaInactiveCount">-</span> Mitglieder</strong>
                    </div>
                    <div style="background: #f8fafc; padding: 10px; border-radius: 6px; margin-top: 15px;">
                        <div style="height: 20px; background: #e2e8f0; border-radius: 10px; overflow: hidden;">
                            <div id="sepaProgressBar" style="height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); width: 0%; transition: width 0.5s;"></div>
                        </div>
                        <div style="text-align: center; margin-top: 8px; font-size: 0.9em; color: #666;">
                            <span id="sepaPercentage">0</span>% SEPA-Quote
                        </div>
                    </div>
                </div>
            </div>
                        
            <!-- Top 5 Schuldner -->
            <div class="card">
                <div class="card-header">üí∞ Top 5 Offene Betr√§ge</div>
                <div id="topDebtorsList" style="padding: 10px;">
                    <div style="text-align: center; padding: 20px; color: #666;">Lade Daten...</div>
                    </div>
                </div>
                </div>
            </div>
    <!-- ENDE dashboard-page -->       

<!-- Mitglieder Tab -->
        <div id="users" class="page-content" style="display: none;">
            <div class="page-header">
                <div>
                    <h1>Mitgliederverwaltung</h1>
                    <div class="breadcrumb">Verwaltung / Mitglieder</div>
                </div>
                <button onclick="logoutAdmin()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üö™ Logout
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">üë• Mitglieder</div>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="openUserModal()" id="addUserBtn">
                        ‚ûï Neues Mitglied
                    </button>
                    <button class="btn btn-warning" onclick="editSelectedUser()" id="editUserBtn" disabled>
                        ‚úèÔ∏è Bearbeiten
                    </button>
                    <button class="btn" onclick="openManualBookingModal()" id="manualBookingBtn" disabled style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        üí∞ Manuelle Buchung
                    </button>
                    <button class="btn" onclick="viewUserBillings()" id="viewUserBillingsBtn" disabled>
                        üìã Abrechnungen anzeigen
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelectedUsers()" id="deleteUserBtn" disabled>
                        üóëÔ∏è L√∂schen
                    </button>
                    <button class="btn btn-secondary" onclick="loadUsers()" id="loadUsersBtn">
                        üîÑ Neu laden
                    </button>
                    <div class="selection-info" id="userSelectionInfo">0 ausgew√§hlt</div>
                </div>
                
                <div style="overflow-x: auto;">
<table class="data-table" id="userTable">
    <thead>
        <tr>
            <th class="checkbox-cell">
                <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAll('users')">
            </th>
            <th>Name</th>
            <th>Rolle</th>
            <th>Barcode</th>
            <th>Saldo</th>
            <th>SEPA</th>
            <th>IBAN</th>
            <th>E-Mail</th>
        </tr>
    </thead>
    <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                                    Lade Mitgliederdaten...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

<!-- Produkte Tab -->
        <div id="products" class="page-content" style="display: none;">
            <div class="page-header">
                <div>
                    <h1>Produktverwaltung</h1>
                    <div class="breadcrumb">Verwaltung / Produkte</div>
                </div>
                <button onclick="logoutAdmin()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üö™ Logout
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">üì¶ Produkte mit Bildupload</div>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="openProductModal()" id="addProductBtn">
                        ‚ûï Neues Produkt
                    </button>
                    <button class="btn btn-warning" onclick="editSelectedProduct()" id="editProductBtn" disabled>
                        ‚úèÔ∏è Bearbeiten
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelectedProducts()" id="deleteProductBtn" disabled>
                        üóëÔ∏è L√∂schen
                    </button>
                    <button class="btn btn-secondary" onclick="loadProducts()" id="loadProductsBtn">
                        üîÑ Neu laden
                    </button>
                    <div class="selection-info" id="productSelectionInfo">0 ausgew√§hlt</div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="productTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAllProducts" onchange="toggleSelectAll('products')">
                                </th>
                                <th>Bild</th>
                                <th>Produkt</th>
                                <th>Kategorie</th>
                                <th>Mitgliedspreis</th>
                                <th>Gastpreis</th>
                                <th>Bestand</th>
                                <th>Barcode</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 30px; color: #666;">
                                    Klicke "Neu laden" um Produktdaten zu laden
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

<!-- Bestand Tab -->
        <div id="stock" class="page-content" style="display: none;">
            <div class="page-header">
                <div>
                    <h1>Bestandsverwaltung</h1>
                    <div class="breadcrumb">Verwaltung / Bestand</div>
                </div>
                <button onclick="logoutAdmin()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üö™ Logout
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">üìä Bestandsbewegungen</div>
                <p style="margin-bottom: 15px; color: #666;">
                    Dokumentiere Eink√§ufe, Inventuren und Bestandskorrekturen
                </p>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="openStockMovementModal('purchase')">
                        üì• Beschaffung
                    </button>
                    <button class="btn btn-warning" onclick="openStockMovementModal('correction')" id="addCorrectionBtn">
                        üîß Korrektur
                    </button>
                    <button class="btn" onclick="loadStockMovements()">
                        üîÑ Neu laden
                    </button>
                    <select id="stockFilter" onchange="filterStockMovements()" style="padding: 10px; border-radius: 6px; border: 2px solid #e2e8f0;">
                        <option value="all">Alle Bewegungen</option>
                        <option value="purchase">üì• Beschaffungen</option>
                        <option value="sale">üõí Verk√§ufe</option>
                        <option value="correction">üîß Korrekturen</option>
                        <option value="initial">üéØ Startbest√§nde</option>
                    </select>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table" id="stockMovementTable">
                        <thead>
                            <tr>
                                <th>Datum/Zeit</th>
                                <th>Produkt</th>
                                <th>Typ</th>
                                <th>Menge</th>
                                <th>Bestand vorher</th>
                                <th>Bestand nachher</th>
                                <th>Grund</th>
                                <th>Referenz</th>
                                <th>Erstellt von</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 30px; color: #666;">
                                    Lade Bestandsbewegungen...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
<!-- Transaktionen Tab -->
        <div id="transactions" class="page-content" style="display: none;">
            <div class="page-header">
                <div>
                    <h1>Transaktionsverlauf</h1>
                    <div class="breadcrumb">Finanzen / Transaktionen</div>
                </div>
                <button onclick="logoutAdmin()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üö™ Logout
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">üí∞ Transaktionen</div>
                
                <div class="toolbar">
                    <button class="btn" onclick="loadTransactions()">üîÑ Neu laden</button>
                    <button class="btn btn-success" onclick="exportTransactions()">üìä CSV Export</button>
                    <select id="transactionFilter" onchange="filterTransactions()" style="padding: 10px; border-radius: 6px; border: 2px solid #e2e8f0;">
                        <option value="all">Alle Transaktionen</option>
                        <option value="today">Heute</option>
                        <option value="week">Diese Woche</option>
                        <option value="month">Dieser Monat</option>
                    </select>
                </div>
                
                <table class="data-table" id="transactionTable">
                    <thead>
                        <tr>
                            <th>Datum/Zeit</th>
                            <th>Mitglied</th>
                            <th>Produkt</th>
                            <th>Menge</th>
                            <th>Preis</th>
                            <th>Gesamt</th>
                            <th>Zahlungsart</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 30px; color: #666;">                                Klicke "Neu laden" um Transaktionen zu laden
                                Lade Mitgliederdaten...
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div id="transactionSummary" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 6px; display: none;">
                    <strong>Zusammenfassung:</strong>
                    <div style="margin-top: 10px;">
                        <span id="transactionCountSpan">0</span> Transaktionen | 
                        Gesamtumsatz: <span id="totalRevenue">0.00</span>‚Ç¨
                    </div>
                </div>
            </div>
        </div>

<!-- Einstellungen Tab (vorher Barcodes) -->
        <div id="settings" class="page-content" style="display: none;">
            <div class="page-header">
                <div>
                    <h1>Systemeinstellungen</h1>
                    <div class="breadcrumb">System / Einstellungen</div>
                </div>
                <button onclick="logoutAdmin()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üö™ Logout
                </button>
            </div>
            
            <div class="card">
                <div class="card-header">‚öôÔ∏è Spezial-Barcodes</div>
                <p style="margin-bottom: 15px; color: #666;">Konfiguriere die speziellen System-Barcodes f√ºr das Kassensystem.</p>
                
                <form id="settingsForm" style="max-width: 800px;">
                    <div class="form-group">
                        <label>üõí Checkout-Barcode</label>
                        <input type="text" id="checkoutBarcode" placeholder="CHECKOUT123" value="CHECKOUT123">
                        <small style="color: #666;">Dieser Barcode schlie√üt den Kaufvorgang ab</small>
                    </div>
                    
                    <div class="form-group">
                        <label>‚ùå Abbruch-Barcode</label>
                        <input type="text" id="cancelBarcode" placeholder="CANCEL123" value="CANCEL123">
                        <small style="color: #666;">Leert den Warenkorb</small>
                    </div>
                    
                    <div class="form-group">
                        <label>üîÑ Reset-Barcode</label>
                        <input type="text" id="resetBarcode" placeholder="RESET123" value="RESET123">
                        <small style="color: #666;">Beendet die komplette Session</small>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e2e8f0;">

                    <h3 style="margin-bottom: 15px; color: #667eea;">üí≥ SEPA-Lastschrift Einstellungen</h3>
                    <p style="margin-bottom: 20px;">Diese Daten werden f√ºr den SEPA-XML-Export ben√∂tigt.</p>
                    
                    <div class="form-group">
                        <label>Vereinsname *</label>
                        <input type="text" id="creditorName" placeholder="Saarcade e.V." value="Saarcade e.V." required>
                        <small style="color: #666;">Offizieller Name des Vereins</small>
                    </div>

                    <div class="form-group">
                        <label>Gl√§ubiger-Identifikationsnummer (Creditor ID) *</label>
                        <input type="text" id="creditorId" placeholder="DE98ZZZ09999999999" required>
                        <small style="color: #666;">Eindeutige ID f√ºr SEPA-Lastschriften (erh√§ltlich bei der Bundesbank)</small>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>SEPA-Lastschrift IBAN *</label>
                            <input type="text" id="creditorIban" placeholder="DE89 3704 0044 0532 0130 00" required>
                            <small style="color: #666;">IBAN f√ºr SEPA-Lastschriften (Abbuchungen)</small>
                        </div>
                        
                        <div class="form-group">
                            <label>SEPA-Lastschrift BIC (optional)</label>
                            <input type="text" id="creditorBic" placeholder="COBADEFFXXX">
                            <small style="color: #666;">Bei deutschen IBANs optional</small>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>√úberweisungs-IBAN (optional)</label>
                            <input type="text" id="transferIban" placeholder="DE89 3704 0044 0532 0130 00">
                            <small style="color: #666;">Alternative IBAN f√ºr manuelle √úberweisungen von Mitgliedern</small>
                        </div>
                        
                        <div class="form-group">
                            <label>√úberweisungs-BIC (optional)</label>
                            <input type="text" id="transferBic" placeholder="COBADEFFXXX">
                            <small style="color: #666;">Bei deutschen IBANs optional</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Verwendungszweck (Standard)</label>
                        <input type="text" id="sepaReference" placeholder="Getr√§nkeabrechnung" value="Saarcade Getraenkeabrechnung">
                        <small style="color: #666;">Wird auf dem Kontoauszug angezeigt</small>
                    </div>

                    <div class="form-group">
                        <label>SEPA-Sequenztyp</label>
                        <select id="sepaSequenceType">
                            <option value="RCUR">RCUR - Wiederkehrende Lastschrift</option>
                            <option value="FRST">FRST - Erste Lastschrift</option>
                            <option value="OOFF">OOFF - Einmalige Lastschrift</option>
                            <option value="FNAL">FNAL - Letzte Lastschrift</option>
                        </select>
                        <small style="color: #666;">Standard: RCUR f√ºr wiederkehrende monatliche Abbuchungen</small>
                    </div>

                    <div class="form-group">
                        <label>PayPal Account/Username</label>
                        <input type="text" id="paypalAccount" placeholder="z.B. saarcade oder deine-email@example.com">
                        <small style="color: #666;">F√ºr PayPal.Me Links in der Kleidungsbestellung</small>
                    </div>

                    <div class="form-group">
                        <label>üîí PIN f√ºr Barkeeper (Transaktionen l√∂schen)</label>
                        <input type="text" id="bartenderPin" placeholder="z.B. 0814" maxlength="10">
                        <small style="color: #666;">Diese PIN gilt f√ºr Barkeeper zum L√∂schen von Transaktionen</small>
                    </div>

                    <div class="form-group">
                        <label>üîí PIN f√ºr Mitglieder/G√§ste (Transaktionen l√∂schen)</label>
                        <input type="text" id="memberPin" placeholder="z.B. 1234" maxlength="10">
                        <small style="color: #666;">Diese PIN gilt f√ºr Mitglieder, G√§ste und Admins zum L√∂schen eigener Transaktionen</small>
                    </div>
                    
                    <button type="button" class="btn btn-success" onclick="saveAllSettings()" style="margin-top: 20px;">
                        üíæ Alle Einstellungen speichern
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Abrechnung Tab (vorher SEPA) -->
        <div id="billing" class="page-content" style="display: none;">
            <div class="section">
                <h2>üìã Getr√§nke-Abrechnung</h2>
                <p>W√§hle Mitglieder aus und erstelle monatliche Abrechnungen mit SEPA-Lastschriften oder Rechnungslisten.</p>
                
                <div class="toolbar" style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="createBillingFromSelection()" id="createBillingBtn" disabled>
                        üí≥ Ausgew√§hlte abrechnen (<span id="selectedBillingCount">0</span>)
                    </button>
                    <button class="btn btn-secondary" onclick="loadOpenBalances()">
                        üîÑ Offene Betr√§ge neu laden
                    </button>
                    <button class="btn btn-secondary" onclick="loadBillingHistory()">
                        üìú Abrechnungshistorie anzeigen
                    </button>
                </div>

                <div id="openBalancesSection" style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üìä Offene Betr√§ge (nicht abgerechnet)</h3>
                    
                    <div style="background: #fff5e6; padding: 15px; border-left: 4px solid #ed8936; border-radius: 4px; margin-bottom: 15px;">
                        <strong>Gesamtsumme nicht abgerechnet:</strong> 
                        <span id="totalOpenAmount" style="font-size: 1.2em; color: #e53e3e;">0.00‚Ç¨</span> 
                        (<span id="openUsersCount">0</span> Benutzer mit Schulden)
                        <br>
                        <strong>Ausgew√§hlt:</strong> 
                        <span id="selectedOpenAmount" style="font-size: 1.2em; color: #667eea;">0.00‚Ç¨</span> 
                        (<span id="selectedBillingCount2">0</span> Benutzer)
                    </div>
                    
                    <table class="data-table" id="openBalancesTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAllBilling" onchange="toggleSelectAllBilling()">
                                </th>
                                <th>Name</th>
                                <th>Offener Betrag</th>
                                <th>SEPA</th>
                                <th>E-Mail</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px; color: #666;">
                                    Lade offene Betr√§ge...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e2e8f0;">

                <h3 style="margin-bottom: 15px; color: #667eea;">üìú Abrechnungshistorie</h3>
                <table class="data-table" id="billingHistoryTable">
                    <thead>
                        <tr>
                            <th>Rechnungsnummer</th>
                            <th>Datum</th>
                            <th>Gesamtbetrag</th>
                            <th>SEPA-Nutzer</th>
                            <th>Nicht-SEPA</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                                Noch keine Abrechnungen erstellt
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

<!-- CLOTHING TAB -->
<div id="clothing" class="page-content" style="display: none;">
    <div class="page-header">
        <div>
            <h1>Kleidungsverwaltung</h1>
            <div class="breadcrumb">Verwaltung / Kleidung</div>
        </div>
        <button onclick="logoutAdmin()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
            üö™ Logout
        </button>
    </div>
    
    <div class="card">
        <div class="card-header">üëï Kleidungsartikel</div>
        
        <div class="toolbar">
            <button class="btn btn-success" onclick="openClothingModal()" id="addClothingBtn">
                ‚ûï Neuer Artikel
            </button>
            <button class="btn btn-warning" onclick="editSelectedClothing()" id="editClothingBtn" disabled>
                ‚úèÔ∏è Bearbeiten
            </button>
            <button class="btn btn-danger" onclick="deleteSelectedClothing()" id="deleteClothingBtn" disabled>
                üóëÔ∏è L√∂schen
            </button>
            <button class="btn btn-secondary" onclick="loadClothingItems()" id="loadClothingBtn">
                üîÑ Neu laden
            </button>
            <div class="selection-info" id="clothingSelectionInfo">0 ausgew√§hlt</div>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="data-table" id="clothingTable">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAllClothing" onchange="toggleSelectAll('clothing')">
                        </th>
                        <th>Bild</th>
                        <th>Name</th>
                        <th>Preis</th>
                        <th>Gr√∂√üen</th>
                        <th>Farben</th>
                        <th>Verf√ºgbar</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                            Klicke "Neu laden" um Kleidungsartikel zu laden
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- ENDE Clothing Tab -->

<!-- Bestellungen Tab -->
<div id="orders" class="page-content" style="display: none;">
    <div class="page-header">
        <div>
            <h1>Kleidungsbestellungen</h1>
            <div class="breadcrumb">Verwaltung / Bestellungen</div>
        </div>
        <button onclick="logoutAdmin()" style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
            üö™ Logout
        </button>
    </div>
    
    <div class="card">
        <div class="card-header">üìã Alle Bestellungen</div>
        
        <div class="toolbar">
            <button class="btn btn-success" onclick="markSelectedOrdersAsPaid()" id="markPaidBtn" disabled>
                ‚úÖ Als bezahlt markieren
            </button>
            <button class="btn" onclick="markSelectedOrdersAsShipped()" id="markShippedBtn" disabled style="background: #9b59b6; color: white;">
                üöö Als ausgeliefert markieren
            </button>
            <button class="btn btn-warning" onclick="viewOrderDetails()" id="viewOrderDetailsBtn" disabled>
                üëÅÔ∏è Details anzeigen
            </button>
            <button class="btn btn-danger" onclick="deleteSelectedOrders()" id="deleteOrderBtn" disabled>
                üóëÔ∏è L√∂schen
            </button>
            <button class="btn btn-secondary" onclick="loadOrders()" id="loadOrdersBtn">
                üîÑ Neu laden
            </button>
            <div class="selection-info" id="orderSelectionInfo">0 ausgew√§hlt</div>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="data-table" id="ordersTable">
                <thead>
                    <tr>
                        <th class="checkbox-cell">
                            <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAll('orders')">
                        </th>
                        <th>Bestell-Nr.</th>
                        <th>Datum</th>
                        <th>Mitglied</th>
                        <th>Artikel</th>
                        <th>Betrag</th>
                        <th>Zahlungsart</th>
                        <th>Bezahlt</th>
                        <th>Ausgeliefert</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 30px; color: #666;">
                            Klicke "Neu laden" um Bestellungen zu laden
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
        
</main>
        <!-- Abrechnungs-Details Modal -->
        <div id="billingDetailsModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 id="billingDetailsTitle">Abrechnungs-Details</h3>
                    <span class="close" onclick="closeModal('billingDetailsModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="billingDetailsContent">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Produkt bearbeiten</h3>
                <span class="close" onclick="closeModal('productModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId" value="">
                    <input type="hidden" id="currentImageUrl" value="">
                    <input type="hidden" id="currentImagePath" value="">
                    
                    <div class="form-group">
                        <label>Produktfoto</label>
                        <div class="photo-upload" id="photoUpload" onclick="triggerFileInput()">
                            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                            <div class="photo-preview-container" id="photoPreviewContainer">
                                <div id="photoPlaceholder">
                                    <p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p>
                                    <p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p>
                                </div>
                            </div>
                            <div class="photo-upload-progress" id="uploadProgress">
                                Lade hoch... 0%
                            </div>
                        </div>
                        <div class="photo-actions" id="photoActions">
                            <button type="button" class="btn btn-secondary" onclick="triggerFileInput()">
                                üîÑ Bild √§ndern
                            </button>
                            <button type="button" class="btn btn-danger" onclick="removePhoto()">
                                üóëÔ∏è Entfernen
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Produktname *</label>
                        <input type="text" id="productName" required>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Kategorie</label>
                            <select id="productCategory">
                                <option value="bier">üç∫ Bier</option>
                                <option value="softdrinks">ü•§ Softdrinks</option>
                                <option value="schnaps">ü•É Spirituosen</option>
                                <option value="snacks">üçø Snacks</option>
                                <option value="heissgetraenke">‚òï Hei√ügetr√§nke</option>
                                <option value="sonstiges">üì¶ Sonstiges</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Emoji/Icon (Fallback)</label>
                            <input type="text" id="productEmoji" placeholder="üç∫" maxlength="2">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mitgliedspreis (‚Ç¨) *</label>
                            <input type="number" id="productMemberPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Gastpreis (‚Ç¨) *</label>
                            <input type="number" id="productGuestPrice" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>üì¶ Aktueller Bestand (nur Anzeige)</label>
                            <input type="number" id="productStock" min="0" value="0" readonly style="background: #f0fff4; cursor: not-allowed;">
                            <small style="color: #666;">Wird √ºber "üìä Bestand" Tab verwaltet</small>
                        </div>
                        <div class="form-group">
                            <label>Mindestbestand</label>
                            <input type="number" id="productMinStock" min="0" value="5">
                            <small style="color: #666;">Warnung bei Unterschreitung</small>
                        </div>
                    </div>
                    <div class="form-group" id="stockHistorySection" style="display: none; background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <button type="button" class="btn" onclick="viewProductStockHistory()" id="viewStockHistoryBtn">
                            üìä Bestandshistorie anzeigen
                        </button>
                        <small style="display: block; margin-top: 8px; color: #666;">
                            Zeige alle Bestandsbewegungen f√ºr dieses Produkt
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Barcodes (optional, mit Enter trennen)</label>
                        <textarea id="productBarcodes" rows="3" placeholder="4000417025001&#10;5000112637447"></textarea>
                        <small style="color: #666;">Jeder Barcode in eine neue Zeile</small>
                    </div>                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productAvailable" checked>
                            Verf√ºgbar
                        </label>
                    </div>
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('productModal')">
                            Abbrechen
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveProduct()" id="saveProductBtn">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Mitglied bearbeiten</h3>
                <span class="close" onclick="closeModal('userModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId" value="">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Vorname *</label>
                            <input type="text" id="userFirstName" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Nachname *</label>
                            <input type="text" id="userLastName" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Barcodes * (mit Enter trennen)</label>
                        <textarea id="userBarcodes" rows="3" placeholder="SAAR001&#10;ALT123" required></textarea>
                        <small style="color: #666;">Jeder Barcode in eine neue Zeile</small>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Rolle</label>
                            <select id="userRole">
                                <option value="member">üë• Mitglied</option>
                                <option value="guest">üë§ Gast</option>
                                <option value="bartender">üç∫ Barkeeper</option>
                                <option value="admin">‚öôÔ∏è Administrator</option>
                            </select>
                        </div>
                        
<div class="form-group">
    <label>Aktueller Saldo (‚Ç¨) - nur lesbar</label>
    <input type="number" id="userBalance" step="0.01" readonly style="background: #f0f0f0; cursor: not-allowed;">
    <small style="color: #666;">Der Saldo wird automatisch durch Transaktionen berechnet</small>
</div>
                    </div>
                    
                    <div class="form-group">
                        <label>E-Mail</label>
                        <input type="email" id="userEmail">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="userSepaActive">
                            SEPA-Lastschrift aktiv
                        </label>
                    </div>
                    
                    <div class="form-group" id="ibanGroup" style="display: none;">
                        <label>IBAN</label>
                        <input type="text" id="userIban" placeholder="DE89 3704 0044 0532 0130 00">
                    </div>

                    <div class="form-group" id="pinResetGroup" style="display: none; background: #fff5e6; padding: 15px; border-radius: 8px; border-left: 4px solid #ed8936;">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <span>üîê PIN-Verwaltung</span>
                        </label>
                        <div style="margin-top: 10px;">
                            <div id="pinStatusText" style="margin-bottom: 10px; color: #666;"></div>
                            <button type="button" class="btn btn-warning" onclick="resetUserPin()" id="resetPinBtn">
                                üîì PIN zur√ºcksetzen
                            </button>
                            <small style="display: block; margin-top: 8px; color: #666;">
                                Setzt die PIN auf null. Der Benutzer kann danach eine neue PIN vergeben.
                            </small>
                        </div>
                    </div>

                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">
                            Abbrechen
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveUser()" id="saveUserBtn">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<!-- Manual Booking Modal -->
<div id="manualBookingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üí∞ Manuelle Buchung</h3>
            <span class="close" onclick="closeModal('manualBookingModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="manualBookingForm">
                <input type="hidden" id="bookingUserId" value="">
                
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>Mitglied:</strong> <span id="bookingUserName"></span></p>
                    <p><strong>Aktueller Saldo:</strong> <span id="bookingCurrentBalance" style="font-weight: bold;"></span></p>
                </div>
                
                <div class="form-group">
                    <label>Buchungsart *</label>
                    <select id="bookingType" required onchange="updateBookingPreview()">
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="debit">üî¥ Lastschrift / Verbindlichkeit (Minus)</option>
                        <option value="credit">üü¢ Gutschrift / Guthaben (Plus)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Betrag (‚Ç¨) *</label>
                    <input type="number" id="bookingAmount" step="0.01" min="0.01" required placeholder="0.00" oninput="updateBookingPreview()">
                </div>
                
                <div class="form-group">
                    <label>Beschreibung *</label>
                    <textarea id="bookingDescription" rows="3" required placeholder="z.B. Barzahlung, Korrektur, Gutschrift f√ºr..."></textarea>
                </div>
                
                <div id="bookingPreview" style="display: none; background: #e6f3ff; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <p><strong>Vorschau:</strong></p>
                    <p>Neuer Saldo: <span id="previewNewBalance" style="font-weight: bold; font-size: 1.2em;"></span></p>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('manualBookingModal')">
                        Abbrechen
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveManualBooking()">
                        üíæ Buchung durchf√ºhren
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
    
<!-- Stock Movement Modal -->
    <div id="stockMovementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="stockMovementModalTitle">Bestandsbewegung</h3>
                <span class="close" onclick="closeModal('stockMovementModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="stockMovementForm">
                    <input type="hidden" id="movementType" value="">
                    
                    <div class="form-group">
                        <label>Produkt ausw√§hlen *</label>
                        <select id="movementProductId" required onchange="updateStockInfo()">
                            <option value="">-- Produkt w√§hlen --</option>
                        </select>
                    </div>

                    <div class="form-group" id="currentStockInfo" style="display: none; background: #f8fafc; padding: 12px; border-radius: 6px;">
                        <strong>Aktueller Bestand:</strong> <span id="currentStockValue">-</span> Einheiten
                    </div>
                    
                    <div class="form-group">
                        <label id="quantityLabel">Menge *</label>
                        <input type="number" id="movementQuantity" required min="1" step="1" placeholder="0">
                        <small id="quantityHelp" style="color: #666;"></small>
                    </div>
                    
                    <div class="form-group">
                        <label>Grund / Bemerkung</label>
                        <textarea id="movementReason" rows="3" placeholder="z.B. Wochenmarkt-Einkauf, Inventur-Korrektur"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Referenz (optional)</label>
                        <input type="text" id="movementReference" placeholder="z.B. Lieferschein-Nr., Rechnungs-Nr.">
                    </div>

                    <div id="costFields" style="display: none;">
                        <hr style="margin: 20px 0; border: none; border-top: 2px solid #e2e8f0;">
                        <h4 style="margin-bottom: 15px; color: #667eea;">üí∞ Kosten (optional)</h4>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Preis pro Einheit (‚Ç¨)</label>
                                <input type="number" id="movementCostPerUnit" step="0.01" min="0" placeholder="0.00" onchange="calculateTotalCost()">
                            </div>
                            
                            <div class="form-group">
                                <label>Gesamtkosten (‚Ç¨)</label>
                                <input type="number" id="movementTotalCost" step="0.01" min="0" placeholder="0.00" readonly style="background: #f8fafc;">
                            </div>
                        </div>
                    </div>

                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('stockMovementModal')">
                            Abbrechen
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveStockMovement()" id="saveMovementBtn">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<!-- Clothing Modal -->
<div id="clothingModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="clothingModalTitle">Kleidungsartikel bearbeiten</h3>
            <span class="close" onclick="closeModal('clothingModal')">&times;</span>
        </div>
        <div class="modal-body">
            <form id="clothingForm">
                <input type="hidden" id="clothingId" value="">
                <input type="hidden" id="currentClothingImageUrl" value="">
                <input type="hidden" id="currentClothingImagePath" value="">
                
                <div class="form-group">
                    <label>Artikelfoto</label>
                    <div class="photo-upload" id="clothingPhotoUpload" onclick="triggerClothingFileInput()">
                        <input type="file" id="clothingPhotoInput" accept="image/*" style="display: none;" onchange="handleClothingPhotoUpload(event)">
                        <div class="photo-preview-container" id="clothingPhotoPreviewContainer">
                            <div id="clothingPhotoPlaceholder">
                                <p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p>
                                <p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p>
                            </div>
                        </div>
                        <div class="photo-upload-progress" id="clothingUploadProgress">
                            Lade hoch... 0%
                        </div>
                    </div>
                    <div class="photo-actions" id="clothingPhotoActions">
                        <button type="button" class="btn btn-secondary" onclick="removeClothingPhoto()">
                            üóëÔ∏è Bild entfernen
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="clothingName" required placeholder="z.B. Saarcade Hoodie">
                </div>
                
                <div class="form-group">
                    <label>Emoji (Optional)</label>
                    <input type="text" id="clothingEmoji" placeholder="üëï" maxlength="2">
                    <small style="color: #666;">Wird als Fallback angezeigt, wenn kein Bild vorhanden ist</small>
                </div>
                
                <div class="form-group">
                    <label>Preis (‚Ç¨) *</label>
                    <input type="number" id="clothingPrice" step="0.01" min="0" required placeholder="29.90">
                </div>
                
                <div class="form-group">
                    <label>Gr√∂√üen verf√ºgbar (mit Enter trennen)</label>
                    <textarea id="clothingSizes" rows="3" placeholder="XS&#10;S&#10;M&#10;L&#10;XL&#10;XXL"></textarea>
                    <small style="color: #666;">Jede Gr√∂√üe in eine neue Zeile</small>
                </div>
                
                <div class="form-group">
                    <label>Farben verf√ºgbar (mit Enter trennen)</label>
                    <textarea id="clothingColors" rows="2" placeholder="Schwarz&#10;Navy&#10;Grau"></textarea>
                    <small style="color: #666;">Jede Farbe in eine neue Zeile. Bei nur einer Farbe reicht eine Zeile.</small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="clothingAvailable" checked>
                        Verf√ºgbar f√ºr Bestellungen
                    </label>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('clothingModal')">
                        Abbrechen
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveClothingItem()" id="saveClothingBtn">
                        üíæ Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
    
<script>
// ============ GLOBALE VARIABLEN ============
        let apiConnected = false;
        let users = [];
        let products = [];
        let selectedUsers = [];
        let selectedProducts = [];
        let selectedClothing = [];
        let currentImageFile = null;
        let uploadedImageUrl = null;
        let transactions = [];
        let allTransactions = [];
        let sepaUsers = [];
        let stockMovements = [];
        let allStockMovements = [];
        
        // Tracking welche Tabs bereits geladen wurden
        let loadedTabs = {
            users: false,
            products: false,
            clothing: false,
            orders: false,
            stock: false,
            transactions: false,
            settings: false,
            billing: false
        };
        
        // ============ API FUNCTIONS ============
        
        async function apiCall(endpoint, options = {}) {
            try {
                showLoading(true);
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateApiStatus(true);
                return data;
                
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                updateApiStatus(false, error.message);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // ============ IMAGE UPLOAD FUNCTIONS ============
        
        async function uploadImageToAPI(imageFile, productId) {
            try {
                const base64 = await fileToBase64(imageFile);
                
                const uploadData = {
                    image: base64,
                    fileName: imageFile.name,
                    productId: productId
                };

                const result = await apiCall('/api/upload-image', {
                    method: 'POST',
                    body: JSON.stringify(uploadData)
                });

                return result;
            } catch (error) {
                console.error('Image upload error:', error);
                throw error;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function deleteImageFromAPI(filePath) {
            try {
                await apiCall('/api/delete-image', {
                    method: 'DELETE',
                    body: JSON.stringify({ filePath })
                });
            } catch (error) {
                console.error('Image delete error:', error);
            }
        }

        // ============ PHOTO UPLOAD UI FUNCTIONS ============
        
        function triggerFileInput() {
            try {
                const fileInput = document.getElementById('photoInput');
                if (fileInput) {
                    fileInput.click();
                } else {
                    console.error('Photo input not found');
                }
            } catch (error) {
                console.error('Error triggering file input:', error);
            }
        }

        window.addEventListener('error', function(e) {
            console.error('Global JavaScript error:', e.error);
            
            if (e.error && e.error.message && e.error.message.includes('placeholder')) {
                console.warn('Photo placeholder error detected - this is handled gracefully');
                return;
            }
            
            if (e.error && e.error.message && e.error.message.includes('JSON')) {
                showAlert('Datenfehler aufgetreten - Seite neu laden empfohlen', 'error');
            }
        });

        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showAlert('Datei zu gro√ü. Maximum 2MB erlaubt.', 'error');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showAlert('Nur Bilddateien erlaubt.', 'error');
                return;
            }

            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        showPhotoPreview(e.target.result);
                        console.log('‚úÖ Image preview loaded successfully');
                    } catch (error) {
                        console.error('Error showing preview:', error);
                        showAlert('Fehler beim Anzeigen der Bildvorschau', 'error');
                    }
                };
                reader.onerror = function() {
                    showAlert('Fehler beim Lesen der Bilddatei', 'error');
                };
                reader.readAsDataURL(file);

                currentImageFile = file;
                uploadedImageUrl = null;
                
            } catch (error) {
                console.error('Error in handlePhotoUpload:', error);
                showAlert('Fehler beim Verarbeiten des Bildes', 'error');
            }
        }

        function showPhotoPreview(imageSrc, isUploaded = false) {
            const container = document.getElementById('photoPreviewContainer');
            const actions = document.getElementById('photoActions');
            
            if (!container) {
                console.error('Photo preview container not found');
                return;
            }
            
            container.innerHTML = `
                <img src="${imageSrc}" class="photo-preview" alt="Produktfoto">
                <div id="photoPlaceholder" style="display: none;">
                    <p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p>
                    <p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p>
                </div>
            `;
            
            container.classList.add('has-image');
            
            if (actions) {
                actions.style.display = 'block';
            }

            if (isUploaded) {
                uploadedImageUrl = imageSrc;
            }
            
            console.log('‚úÖ Photo preview shown successfully');
        }

        function removePhoto() {
            const container = document.getElementById('photoPreviewContainer');
            const actions = document.getElementById('photoActions');
            
            if (!container) {
                console.error('Photo preview container not found');
                return;
            }
            
            container.innerHTML = `
                <div id="photoPlaceholder">
                    <p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p>
                    <p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p>
                </div>
            `;
            
            container.classList.remove('has-image');
            
            if (actions) {
                actions.style.display = 'none';
            }
            
            const photoInput = document.getElementById('photoInput');
            if (photoInput) {
                photoInput.value = '';
            }
            
            currentImageFile = null;
            uploadedImageUrl = null;
            
            console.log('‚úÖ Photo removed successfully');
        }

        function resetPhotoPreview() {
            removePhoto();
        }

        // ============ UI FUNCTIONS ============
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function updateApiStatus(connected, errorMsg = '') {
            const statusEl = document.getElementById('apiStatus');
            apiConnected = connected;
            
            if (connected) {
                statusEl.className = 'api-status connected';
                statusEl.textContent = '‚úÖ API verbunden';
            } else {
                statusEl.className = 'api-status error';
                statusEl.textContent = `‚ùå API-Fehler`;
            }
        }

function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
    alertDiv.innerHTML = `<span>${icon}</span><div>${message}</div>`;
    
    // Finde die aktuelle aktive page-content
    const activeContent = document.querySelector('.page-content[style*="display: block"]') || 
                          document.querySelector('.page-content:not([style*="display: none"])') ||
                          document.getElementById('dashboard-page');
    
    if (activeContent && activeContent.firstChild) {
        activeContent.insertBefore(alertDiv, activeContent.firstChild);
    } else {
        // Fallback: zeige in main-content
        const mainContent = document.querySelector('.main-content');
        if (mainContent) {
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
        }
    }
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 4000);
}

// ============ MOBILE MENU ============
function toggleMobileMenu() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
}

function closeMobileMenu() {
    const sidebar = document.querySelector('.sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
}
        
// ============ TAB NAVIGATION ============
function showTab(tabName) {
    // Sidebar Links aktualisieren
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));

     // Mobile: Sidebar schlie√üen nach Tab-Wechsel
    if (window.innerWidth <= 768) {
        closeMobileMenu();
    }
    
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // WICHTIG: Alle page-content ausblenden
    document.querySelectorAll('.page-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // SPEZIALFALL: Dashboard hat eine andere ID
    if (tabName === 'dashboard') {
        const dashboardPage = document.getElementById('dashboard-page');
        if (dashboardPage) {
            dashboardPage.style.display = 'block';
            dashboardPage.scrollIntoView({ behavior: 'instant', block: 'start' });
        }
        return; // Wichtig: hier beenden
    }
    
    // Nur die gew√ºnschte Seite anzeigen
    const targetPage = document.getElementById(tabName + '-page') || document.getElementById(tabName);
    if (targetPage) {
        targetPage.style.display = 'block';
        // Scroll zum Anfang der Seite
        targetPage.scrollIntoView({ behavior: 'instant', block: 'start' });
    }
    
    // Auto-Load beim ersten Aufruf
    if (!loadedTabs[tabName]) {
        loadedTabs[tabName] = true;
        
        switch(tabName) {
            case 'users':
                loadUsers();
                break;
            case 'stock':
                loadStockMovements();
                break;
            case 'transactions':
                loadTransactions();
                break;
            case 'billing':
                if (!loadedTabs.billing) {
                    loadOpenBalances();
                    loadBillingHistory();
                    loadedTabs.billing = true;
            }
            break;
            case 'clothing':
                if (!loadedTabs.clothing) {
                    loadClothingItems();
                    loadedTabs.clothing = true;
            }
            break;
            case 'orders':
                if (!loadedTabs.orders) {
                    loadOrders();
                    loadedTabs.orders = true;
            }
            break;
        }
        }
}
        
        // ============ SELECTION FUNCTIONS ============
        
        function toggleSelectAll(type) {
            const checkbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const isChecked = checkbox.checked;
            
            const checkboxes = document.querySelectorAll(`#${type}Table tbody input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
                toggleRowSelection(cb, type);
            });
            
            updateSelectionInfo(type);
        }

        function toggleRowSelection(checkbox, type) {
            const row = checkbox.closest('tr');
            const id = parseInt(checkbox.value);
            
            if (checkbox.checked) {
                row.classList.add('selected');
                if (type === 'users') {
                    if (!selectedUsers.includes(id)) selectedUsers.push(id);
                } else if (type === 'products') {
                    if (!selectedProducts.includes(id)) selectedProducts.push(id);
                } else if (type === 'clothing' && !selectedClothing.includes(id)) {  // ‚Üê NEU
                    selectedClothing.push(id);
                } else if (type === 'orders') {
                    if (!selectedOrders.includes(id)) {
                    selectedOrders.push(id);
                }
            }
            } else {
                row.classList.remove('selected');
                if (type === 'users') {
                    selectedUsers = selectedUsers.filter(userId => userId !== id);
                } else if (type === 'products') {
                    selectedProducts = selectedProducts.filter(productId => productId !== id);
                } else if (type === 'clothing') {  // ‚Üê NEU
                    selectedClothing = selectedClothing.filter(cid => cid !== id);
                } else if (type === 'orders') {
                    selectedOrders = selectedOrders.filter(oid => oid !== id);
                }
            }
            
            updateSelectionInfo(type);
        }

function updateSelectionInfo(type) {
    let count, buttons;
    
    if (type === 'users') {
        count = selectedUsers.length;
        buttons = ['editUserBtn', 'deleteUserBtn', 'viewUserBillingsBtn'];
        document.getElementById('userSelectionInfo').textContent = `${count} ausgew√§hlt`;
        
        // Bearbeiten und Abrechnungen anzeigen nur bei genau 1 Auswahl
        document.getElementById('editUserBtn').disabled = count !== 1;
        document.getElementById('viewUserBillingsBtn').disabled = count !== 1;
        document.getElementById('deleteUserBtn').disabled = count === 0;
        document.getElementById('manualBookingBtn').disabled = count !== 1;
        
    } else if (type === 'products') {
        count = selectedProducts.length;
        buttons = ['editProductBtn', 'deleteProductBtn'];
        document.getElementById('productSelectionInfo').textContent = `${count} ausgew√§hlt`;
        
        document.getElementById('editProductBtn').disabled = count !== 1;
        document.getElementById('deleteProductBtn').disabled = count === 0;
   
    } else if (type === 'clothing') {
        count = selectedClothing.length;
        buttons = ['editClothingBtn', 'deleteClothingBtn'];
        document.getElementById('clothingSelectionInfo').textContent = `${count} ausgew√§hlt`;
        
        document.getElementById('editClothingBtn').disabled = count !== 1;
        document.getElementById('deleteClothingBtn').disabled = count === 0;
    
    } else if (type === 'orders') {
        count = selectedOrders.length;
        document.getElementById('orderSelectionInfo').textContent = `${count} ausgew√§hlt`;

        document.getElementById('markPaidBtn').disabled = count === 0;
        document.getElementById('markShippedBtn').disabled = count === 0;
        document.getElementById('viewOrderDetailsBtn').disabled = count !== 1;
        document.getElementById('deleteOrderBtn').disabled = count === 0;
    }
}
        // ============ DATA LOADING FUNCTIONS ============
        
async function loadDashboard() {
    try {
        const data = await apiCall('/api/dashboard');
        
        document.getElementById('memberCount').textContent = data.member_count || 0;
        document.getElementById('productCount').textContent = data.available_products || 0;
        document.getElementById('transactionCount').textContent = data.unbilled_transactions || 0;
        document.getElementById('todayRevenue').textContent = `${(data.unbilled_revenue || 0).toFixed(2)}`;
        
        // Bestandsanalyse durchf√ºhren
        await updateStockOverview();
        
        // NEUE DASHBOARD WIDGETS laden
        await loadTopProducts();
        await loadSepaStatus();
        await loadPendingClothingOrders();
        await loadTopDebtors();
        
    } catch (error) {
        console.error('Fehler beim Laden der Dashboard-Daten:', error);
        showAlert('Fehler beim Laden der Dashboard-Daten', 'error');
    }
}
        
        // ============ USER FUNCTIONS ============

        function openUserModal(userId = null) {
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const form = document.getElementById('userForm');
            
            form.reset();
            document.getElementById('userId').value = '';
            
            if (userId) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    title.textContent = 'Mitglied bearbeiten';
                    
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userFirstName').value = user.first_name;
                    document.getElementById('userLastName').value = user.last_name;
                    document.getElementById('userBarcodes').value = (user.barcodes || []).join('\n');
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userBalance').value = user.balance.toFixed(2);
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userSepaActive').checked = user.sepa_active || false;
                    document.getElementById('userIban').value = user.iban || '';
                    
                    toggleIbanField();

                    const pinResetGroup = document.getElementById('pinResetGroup');
                    const pinStatusText = document.getElementById('pinStatusText');
        
                    if (user.user_pin) {
                        pinStatusText.innerHTML = '‚úÖ PIN ist gesetzt (****)';
                    } else {
                        pinStatusText.innerHTML = '‚ùå Keine PIN gesetzt';
                    }
                    pinResetGroup.style.display = 'block';

                }
            } else {
                title.textContent = 'Neues Mitglied hinzuf√ºgen';
                document.getElementById('userBalance').value = '0.00';
                document.getElementById('userRole').value = 'member';
            }
            
            modal.style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('userFirstName').focus();
            }, 150);
        }

        function editSelectedUser() {
            if (selectedUsers.length !== 1) return;
            openUserModal(selectedUsers[0]);
        }

async function saveUser() {
    const saveBtn = document.getElementById('saveUserBtn');
    const userId = document.getElementById('userId').value;
    
    const barcodes = document.getElementById('userBarcodes').value
        .split('\n')
        .map(b => b.trim().toUpperCase())
        .filter(b => b.length > 0);
    
    const sepaActive = document.getElementById('userSepaActive').checked;
    const ibanValue = document.getElementById('userIban').value.trim();
    
    const userData = {
        first_name: document.getElementById('userFirstName').value.trim(),
        last_name: document.getElementById('userLastName').value.trim(),
        barcodes: barcodes,
        role: document.getElementById('userRole').value,
        balance: parseFloat(document.getElementById('userBalance').value) || 0,
        email: document.getElementById('userEmail').value.trim() || null,
        sepa_active: sepaActive,
        iban: ibanValue || null
    };
    
    // Validierung
    if (!userData.first_name || !userData.last_name || barcodes.length === 0) {
        showAlert('Bitte alle Pflichtfelder ausf√ºllen (mind. 1 Barcode)', 'error');
        return;
    }
    
    // SEPA-IBAN-Validierung
    if (sepaActive && !ibanValue) {
        showAlert('‚ö†Ô∏è SEPA ist aktiviert, aber keine IBAN angegeben!', 'error');
        document.getElementById('userIban').focus();
        return;
    }
    
    // IBAN-G√ºltigkeitspr√ºfung
    if (ibanValue && !validateIBAN(ibanValue)) {
        showAlert('‚ö†Ô∏è Die eingegebene IBAN ist ung√ºltig! Bitte √ºberpr√ºfe die Eingabe.', 'error');
        document.getElementById('userIban').focus();
        document.getElementById('userIban').style.borderColor = '#e53e3e';
        return;
    }
    
    // IBAN formatieren und speichern
    if (ibanValue) {
        userData.iban = ibanValue.replace(/\s/g, '').toUpperCase();
    }
    
    try {
        saveBtn.disabled = true;
        saveBtn.textContent = '‚è≥ Speichere...';
        
        if (userId) {
            await apiCall(`/api/users/${userId}`, {
                method: 'PUT',
                body: JSON.stringify(userData)
            });
            showAlert('Mitglied erfolgreich aktualisiert', 'success');
        } else {
            await apiCall('/api/users', {
                method: 'POST',
                body: JSON.stringify(userData)
            });
            showAlert('Neues Mitglied erfolgreich hinzugef√ºgt', 'success');
        }
        
        closeModal('userModal');
        loadUsers();
        loadDashboard();
        
    } catch (error) {
        showAlert(error.message || 'Fehler beim Speichern des Mitglieds', 'error');
        console.error('Save user error:', error);
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Speichern';
        document.getElementById('userIban').style.borderColor = '';
    }
}

// ============ MANUELLE BUCHUNG ============

function openManualBookingModal() {
    if (selectedUsers.length !== 1) return;
    
    const userId = selectedUsers[0];
    const user = users.find(u => u.id === userId);
    
    if (!user) {
        showAlert('Mitglied nicht gefunden', 'error');
        return;
    }
    
    document.getElementById('bookingUserId').value = user.id;
    document.getElementById('bookingUserName').textContent = `${user.first_name} ${user.last_name}`;
    document.getElementById('bookingCurrentBalance').textContent = `${user.balance.toFixed(2)}‚Ç¨`;
    document.getElementById('bookingCurrentBalance').style.color = user.balance >= 0 ? '#38a169' : '#e53e3e';
    
    document.getElementById('manualBookingForm').reset();
    document.getElementById('bookingUserId').value = user.id;
    document.getElementById('bookingPreview').style.display = 'none';
    
    document.getElementById('manualBookingModal').style.display = 'block';
}

function updateBookingPreview() {
    const userId = parseInt(document.getElementById('bookingUserId').value);
    const user = users.find(u => u.id === userId);
    const type = document.getElementById('bookingType').value;
    const amount = parseFloat(document.getElementById('bookingAmount').value);
    
    if (!user || !type || !amount || amount <= 0) {
        document.getElementById('bookingPreview').style.display = 'none';
        return;
    }
    
    const changeAmount = type === 'credit' ? -amount : amount;
    const newBalance = user.balance - changeAmount;
    
    document.getElementById('previewNewBalance').textContent = `${newBalance.toFixed(2)}‚Ç¨`;
    document.getElementById('previewNewBalance').style.color = newBalance >= 0 ? '#38a169' : '#e53e3e';
    document.getElementById('bookingPreview').style.display = 'block';
}

async function saveManualBooking() {
    const userId = parseInt(document.getElementById('bookingUserId').value);
    const type = document.getElementById('bookingType').value;
    const amount = parseFloat(document.getElementById('bookingAmount').value);
    const description = document.getElementById('bookingDescription').value.trim();
    
    if (!userId || !type || !amount || amount <= 0 || !description) {
        showAlert('Bitte f√ºlle alle Felder aus', 'error');
        return;
    }
    
    const user = users.find(u => u.id === userId);
    if (!user) {
        showAlert('Mitglied nicht gefunden', 'error');
        return;
    }
    
    const changeAmount = type === 'credit' ? -amount : amount;
    const newBalance = user.balance - changeAmount;
    
    const confirmMsg = `M√∂chtest du wirklich diese Buchung durchf√ºhren?\n\n` +
                      `Mitglied: ${user.first_name} ${user.last_name}\n` +
                      `Typ: ${type === 'credit' ? 'Gutschrift' : 'Lastschrift'}\n` +
                      `Betrag: ${amount.toFixed(2)}‚Ç¨\n` +
                      `Aktueller Saldo: ${user.balance.toFixed(2)}‚Ç¨\n` +
                      `Neuer Saldo: ${newBalance.toFixed(2)}‚Ç¨\n` +
                      `Beschreibung: ${description}`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        showLoading(true);
        
        // Erstelle eine "manuelle Buchung" Transaktion
        const transaction = {
            userId: userId,
            userName: `${user.first_name} ${user.last_name}`,
            items: [{
                productId: null,
                productName: `Manuelle Buchung: ${description}`,
                quantity: 1,
                price: changeAmount,
                total: changeAmount
            }],
            paymentMethod: 'manual_booking'
        };
        
        await apiCall('/api/transactions', {
            method: 'POST',
            body: JSON.stringify(transaction)
        });
        
        showAlert(`‚úÖ Buchung erfolgreich!\nNeuer Saldo: ${newBalance.toFixed(2)}‚Ç¨`, 'success');
        
        closeModal('manualBookingModal');
        await loadUsers();
        await loadDashboard();
        
    } catch (error) {
        console.error('Fehler bei manueller Buchung:', error);
        showAlert('Fehler beim Durchf√ºhren der Buchung: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}
        
        async function deleteSelectedUsers() {
            if (selectedUsers.length === 0) return;
            
            const userNames = selectedUsers.map(id => {
                const user = users.find(u => u.id === id);
                return user ? `${user.first_name} ${user.last_name}` : 'Unbekannt';
            }).join(', ');
            
            if (confirm(`M√∂chten Sie diese ${selectedUsers.length} Mitglieder wirklich l√∂schen?\n\n${userNames}\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                try {
                    for (const userId of selectedUsers) {
                        await apiCall(`/api/users/${userId}`, { method: 'DELETE' });
                    }
                    showAlert(`${selectedUsers.length} Mitglieder erfolgreich gel√∂scht`, 'success');
                    loadUsers();
                    loadDashboard();
                } catch (error) {
                    showAlert('Fehler beim L√∂schen der Mitglieder', 'error');
                }
            }
        }

        function toggleIbanField() {
            const sepaCheckbox = document.getElementById('userSepaActive');
            const ibanGroup = document.getElementById('ibanGroup');
            
            if (sepaCheckbox.checked) {
                ibanGroup.style.display = 'block';
            } else {
                ibanGroup.style.display = 'none';
            }
        }
        
        async function loadUsers() {
            try {
                const loadBtn = document.getElementById('loadUsersBtn');
                loadBtn.disabled = true;
                loadBtn.textContent = '‚è≥ Lade...';
                
                users = await apiCall('/api/users');
                renderUsers();
                showAlert(`${users.length} Mitglieder erfolgreich geladen`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der Benutzer:', error);
                showAlert('Fehler beim Laden der Mitgliederdaten', 'error');
            } finally {
                const loadBtn = document.getElementById('loadUsersBtn');
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ Neu laden';
            }
        }

function renderUsers() {
    const tbody = document.querySelector('#userTable tbody');
    selectedUsers = [];
    updateSelectionInfo('users');
    
    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">Keine Mitgliederdaten verf√ºgbar</td></tr>';
        return;
    }
    
    tbody.innerHTML = users.map(user => {
        const balanceColor = user.balance >= 0 ? '#38a169' : '#e53e3e';
        const roleIcon = getRoleIcon(user.role);
        const sepaStatus = user.sepa_active ? '‚úÖ' : '‚ùå';
        
        // IBAN formatiert anzeigen oder Platzhalter
        const ibanDisplay = user.iban 
            ? `<code style="font-size: 0.75em;">${formatIBAN(user.iban)}</code>` 
            : '<span style="color: #999;">-</span>';
        
        return `
            <tr>
                <td class="checkbox-cell">
                    <input type="checkbox" value="${user.id}" onchange="toggleRowSelection(this, 'users')">
                </td>
                <td>${user.first_name} ${user.last_name}</td>
                <td>${roleIcon} ${getRoleText(user.role)}</td>
                <td><code style="font-size: 0.8em;">${user.barcodes ? user.barcodes.join(', ') : '-'}</code></td>
                <td style="color: ${balanceColor}; font-weight: bold;">${user.balance.toFixed(2)}‚Ç¨</td>
                <td>${sepaStatus}</td>
                <td>${ibanDisplay}</td>
                <td style="font-size: 0.8em;">${user.email || '-'}</td>
            </tr>
        `;
    }).join('');
}

        // ============ PRODUCT FUNCTIONS ============

        async function loadProducts() {
            try {
                const loadBtn = document.getElementById('loadProductsBtn');
                loadBtn.disabled = true;
                loadBtn.textContent = '‚è≥ Lade...';
                
                products = await apiCall('/api/products');
                renderProducts();
                showAlert(`${products.length} Produkte erfolgreich geladen`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der Produkte:', error);
                showAlert('Fehler beim Laden der Produktdaten', 'error');
            } finally {
                const loadBtn = document.getElementById('loadProductsBtn');
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ Neu laden';
            }
        }

        function renderProducts() {
            const tbody = document.querySelector('#productTable tbody');
            selectedProducts = [];
            updateSelectionInfo('products');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">Keine Produktdaten verf√ºgbar</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => {
                const stockColor = product.stock > 0 ? '#38a169' : '#e53e3e';
                
                let imageHtml;
                if (product.image_url) {
                    imageHtml = `<img src="${product.image_url}" class="product-image-preview" alt="${product.name}" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="product-emoji-fallback" style="display: none;">${product.image || 'üì¶'}</div>`;
                } else if (product.image) {
                    imageHtml = `<div class="product-emoji-fallback">${product.image}</div>`;
                } else {
                    imageHtml = `<div class="product-emoji-fallback">üì¶</div>`;
                }
                
                return `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" value="${product.id}" onchange="toggleRowSelection(this, 'products')">
                        </td>
                        <td class="product-image-cell">${imageHtml}</td>
                        <td>${product.name}</td>
                        <td>${getCategoryText(product.category)}</td>
                        <td>${product.member_price.toFixed(2)}‚Ç¨</td>
                        <td>${product.guest_price.toFixed(2)}‚Ç¨</td>
                        <td style="color: ${stockColor}; font-weight: bold;">${product.stock}</td>
                        <td><code style="font-size: 0.8em;">${product.barcodes ? product.barcodes.join(', ') : '-'}</code></td>
                    </tr>
                `;
            }).join('');
        }

function openProductModal(productId = null) {
            try {
                const modal = document.getElementById('productModal');
                const title = document.getElementById('productModalTitle');
                const form = document.getElementById('productForm');
                const stockHistorySection = document.getElementById('stockHistorySection');
                
                if (!modal || !title || !form) {
                    console.error('Modal-Elemente nicht gefunden');
                    showAlert('Fehler: Modal nicht verf√ºgbar', 'error');
                    return;
                }
                
                form.reset();
                
                // Sichere Initialisierung aller Felder
                const fields = {
                    productId: '',
                    currentImageUrl: '',
                    currentImagePath: '',
                    productName: '',
                    productCategory: 'sonstiges',
                    productEmoji: '',
                    productMemberPrice: '0.00',
                    productGuestPrice: '0.00',
                    productStock: '0',
                    productMinStock: '5',
                    productBarcodes: '',
                    productAvailable: true
                };
                
                Object.keys(fields).forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = fields[fieldId];
                        } else {
                            element.value = fields[fieldId];
                        }
                    }
                });
                
                if (stockHistorySection) {
                    stockHistorySection.style.display = 'none';
                }
                
                try {
                    resetPhotoPreview();
                } catch (resetError) {
                    console.warn('Photo reset warning:', resetError);
                    const container = document.getElementById('photoPreviewContainer');
                    if (container) {
                        container.innerHTML = `
                            <div id="photoPlaceholder">
                                <p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p>
                                <p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p>
                            </div>
                        `;
                        container.classList.remove('has-image');
                    }
                }
                
                if (productId) {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        title.textContent = 'Produkt bearbeiten';
                        if (stockHistorySection) {
                            stockHistorySection.style.display = 'block';
                        }
                        
                        // Setze Werte mit Null-Checks
                        const setField = (id, value) => {
                            const el = document.getElementById(id);
                            if (el) el.value = value;
                        };
                        
                        setField('productId', product.id || '');
                        setField('productName', product.name || '');
                        setField('productCategory', product.category || 'sonstiges');
                        setField('productEmoji', product.image || '');
                        setField('productMemberPrice', (product.member_price || 0).toFixed(2));
                        setField('productGuestPrice', (product.guest_price || 0).toFixed(2));
                        setField('productStock', product.stock || 0);
                        setField('productMinStock', product.min_stock || 5);
                        
                        const barcodesValue = product.barcodes 
                            ? (Array.isArray(product.barcodes) ? product.barcodes : [product.barcodes]) 
                            : (product.barcode ? [product.barcode] : []);
                        setField('productBarcodes', barcodesValue.join('\n'));
                        
                        const availableCheckbox = document.getElementById('productAvailable');
                        if (availableCheckbox) {
                            availableCheckbox.checked = product.available !== false;
                        }
                        
                        if (product.image_url && typeof product.image_url === 'string') {
                            try {
                                setField('currentImageUrl', product.image_url);
                                setField('currentImagePath', product.image_file_path || '');
                                
                                const img = new Image();
                                img.onload = function() {
                                    try {
                                        showPhotoPreview(product.image_url, true);
                                    } catch (showError) {
                                        console.warn('Error showing existing image:', showError);
                                    }
                                };
                                img.onerror = function() {
                                    console.warn('Existing image could not be loaded:', product.image_url);
                                };
                                img.src = product.image_url;
                                
                            } catch (imageError) {
                                console.warn('Fehler beim Verarbeiten des Produktbildes:', imageError);
                            }
                        }
                    } else {
                        console.error('Produkt nicht gefunden:', productId);
                        showAlert('Produkt nicht gefunden', 'error');
                        return;
                    }
                } else {
                    title.textContent = 'Neues Produkt hinzuf√ºgen';
                }
                
                modal.style.display = 'block';
                
                setTimeout(() => {
                    const firstInput = document.getElementById('productName');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 150);
                
                console.log('‚úÖ Product modal opened successfully');
                
            } catch (error) {
                console.error('‚ùå Fehler beim √ñffnen des Produkt-Modals:', error);
                showAlert('Fehler beim √ñffnen des Bearbeiten-Dialogs', 'error');
            }
        }
        
        function editSelectedProduct() {
            if (selectedProducts.length !== 1) return;
            openProductModal(selectedProducts[0]);
        }

        async function saveProduct() {
            const saveBtn = document.getElementById('saveProductBtn');
            const productId = document.getElementById('productId').value;
            
            const barcodes = document.getElementById('productBarcodes').value
                .split('\n')
                .map(b => b.trim())
                .filter(b => b.length > 0);
            
            const productData = {
                name: document.getElementById('productName').value.trim(),
                category: document.getElementById('productCategory').value,
                image: document.getElementById('productEmoji').value.trim() || 'üì¶',
                member_price: parseFloat(document.getElementById('productMemberPrice').value) || 0,
                guest_price: parseFloat(document.getElementById('productGuestPrice').value) || 0,
                stock: parseInt(document.getElementById('productStock').value) || 0,
                min_stock: parseInt(document.getElementById('productMinStock').value) || 0,
                barcodes: barcodes,
                available: document.getElementById('productAvailable').checked
            };
            
            if (!productData.name || productData.member_price <= 0 || productData.guest_price <= 0) {
                showAlert('Bitte alle Pflichtfelder korrekt ausf√ºllen', 'error');
                return;
            }

            try {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Speichere...';

                if (currentImageFile) {
                    showAlert('Lade Produktbild hoch...', 'info');
                    const uploadResult = await uploadImageToAPI(currentImageFile, productId || 'new');
                    productData.image_url = uploadResult.imageUrl;
                    productData.image_file_path = uploadResult.filePath;
                    
                    if (productId && document.getElementById('currentImagePath').value) {
                        productData.deleteOldImage = true;
                    }
                } else if (uploadedImageUrl) {
                    productData.image_url = uploadedImageUrl;
                    productData.image_file_path = document.getElementById('currentImagePath').value;
                }
                
                if (productId) {
                    await apiCall(`/api/products/${productId}`, {
                        method: 'PUT',
                        body: JSON.stringify(productData)
                    });
                    showAlert('Produkt erfolgreich aktualisiert', 'success');
                } else {
                    await apiCall('/api/products', {
                        method: 'POST',
                        body: JSON.stringify(productData)
                    });
                    showAlert('Neues Produkt erfolgreich hinzugef√ºgt', 'success');
                }
                
                closeModal('productModal');
                loadProducts();
                loadDashboard();
                
            } catch (error) {
                showAlert('Fehler beim Speichern des Produkts', 'error');
                console.error('Save product error:', error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Speichern';
            }
        }

        async function deleteSelectedProducts() {
            if (selectedProducts.length === 0) return;
            
            const productNames = selectedProducts.map(id => {
                const product = products.find(p => p.id === id);
                return product ? product.name : 'Unbekannt';
            }).join(', ');
            
            if (confirm(`M√∂chten Sie diese ${selectedProducts.length} Produkte wirklich l√∂schen?\n\n${productNames}\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                try {
                    for (const productId of selectedProducts) {
                        await apiCall(`/api/products/${productId}`, { method: 'DELETE' });
                    }
                    showAlert(`${selectedProducts.length} Produkte erfolgreich gel√∂scht`, 'success');
                    loadProducts();
                    loadDashboard();
                } catch (error) {
                    showAlert('Fehler beim L√∂schen der Produkte', 'error');
                }
            }
        }

// ============ CLOTHING FUNCTIONS ============

let clothingItems = [];

async function loadClothingItems() {
    try {
        const loadBtn = document.getElementById('loadClothingBtn');
        if (loadBtn) {
            loadBtn.disabled = true;
            loadBtn.textContent = '‚è≥ Lade...';
        }
        
        clothingItems = await apiCall('/api/clothing-items');
        renderClothing();
        showAlert(`${clothingItems.length} Kleidungsartikel erfolgreich geladen`, 'success');
        
    } catch (error) {
        console.error('Fehler beim Laden der Kleidungsartikel:', error);
        showAlert('Fehler beim Laden der Kleidungsartikel', 'error');
    } finally {
        const loadBtn = document.getElementById('loadClothingBtn');
        if (loadBtn) {
            loadBtn.disabled = false;
            loadBtn.textContent = 'üîÑ Neu laden';
        }
    }
}

function renderClothing() {
    const tbody = document.querySelector('#clothingTable tbody');
    selectedClothing = [];
    updateSelectionInfo('clothing');
    
    if (clothingItems.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #666;">Keine Kleidungsartikel verf√ºgbar</td></tr>';
        return;
    }
    
    tbody.innerHTML = clothingItems.map(item => {
        const availableIcon = item.available ? '‚úÖ' : '‚ùå';
        const availableColor = item.available ? '#38a169' : '#e53e3e';
        
        // Gr√∂√üen als kommaseparierte Liste
        const sizesDisplay = item.sizes && item.sizes.length > 0 
            ? item.sizes.join(', ') 
            : '-';
        
        // Farben als kommaseparierte Liste
        const colorsDisplay = item.colors && item.colors.length > 0 
            ? item.colors.join(', ') 
            : '-';
        
        // Bild - gleiche Logik wie bei Produkten
        const imageDisplay = item.image_url 
            ? `<img src="${item.image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
               <div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 4px; display: none; align-items: center; justify-content: center; font-size: 24px;">${item.emoji || 'üëï'}</div>` 
            : `<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 24px;">${item.emoji || 'üëï'}</div>`;
        
        return `
            <tr>
                <td class="checkbox-cell">
                    <input type="checkbox" value="${item.id}" onchange="toggleRowSelection(this, 'clothing')">
                </td>
                <td>${imageDisplay}</td>
                <td><strong>${item.name}</strong></td>
                <td><strong>${item.price.toFixed(2)}‚Ç¨</strong></td>
                <td style="font-size: 0.85em;">${sizesDisplay}</td>
                <td style="font-size: 0.85em;">${colorsDisplay}</td>
                <td style="color: ${availableColor}; font-weight: bold;">${availableIcon}</td>
            </tr>
        `;
    }).join('');
}

function openClothingModal(clothingId = null) {
    try {
        const modal = document.getElementById('clothingModal');
        const title = document.getElementById('clothingModalTitle');
        const form = document.getElementById('clothingForm');
        
        if (!modal || !title || !form) {
            console.error('Clothing Modal-Elemente nicht gefunden');
            showAlert('Fehler: Modal nicht verf√ºgbar', 'error');
            return;
        }
        
        form.reset();
        
        // Felder zur√ºcksetzen
        document.getElementById('clothingId').value = '';
        document.getElementById('currentClothingImageUrl').value = '';
        document.getElementById('currentClothingImagePath').value = '';
        document.getElementById('clothingAvailable').checked = true;
        
        // Foto-Bereich zur√ºcksetzen
        const photoPreview = document.getElementById('clothingPhotoPreviewContainer');
        const photoPlaceholder = document.getElementById('clothingPhotoPlaceholder');
        const photoActions = document.getElementById('clothingPhotoActions');
        
        if (photoPreview) photoPreview.innerHTML = '<div id="clothingPhotoPlaceholder"><p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p><p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p></div>';
        if (photoActions) photoActions.style.display = 'none';
        
        currentImageFile = null;
        uploadedImageUrl = null;
        
        if (clothingId) {
            // Bearbeiten
            title.textContent = 'Kleidungsartikel bearbeiten';
            const item = clothingItems.find(c => c.id === clothingId);
            
            if (item) {
                document.getElementById('clothingId').value = item.id;
                document.getElementById('clothingName').value = item.name;
                document.getElementById('clothingEmoji').value = item.emoji || '';
                document.getElementById('clothingPrice').value = item.price;
                document.getElementById('clothingSizes').value = item.sizes ? item.sizes.join('\n') : '';
                document.getElementById('clothingColors').value = item.colors ? item.colors.join('\n') : '';
                document.getElementById('clothingAvailable').checked = item.available;
                
                // Bild laden, falls vorhanden
                if (item.image_url) {
                    document.getElementById('currentClothingImageUrl').value = item.image_url;
                    document.getElementById('currentClothingImagePath').value = item.image_file_path || '';
                    
                    const photoPreview = document.getElementById('clothingPhotoPreviewContainer');
                    if (photoPreview) {
                        photoPreview.innerHTML = `<img src="${item.image_url}" class="photo-preview" alt="Vorschau">`;
                        photoActions.style.display = 'block';
                    }
                }
            } else {
                console.error('Kleidungsartikel nicht gefunden:', clothingId);
                showAlert('Artikel nicht gefunden', 'error');
                return;
            }
        } else {
            // Neu erstellen
            title.textContent = 'Neuen Kleidungsartikel hinzuf√ºgen';
        }
        
        modal.style.display = 'block';
        
        setTimeout(() => {
            const firstInput = document.getElementById('clothingName');
            if (firstInput) firstInput.focus();
        }, 150);
        
    } catch (error) {
        console.error('Fehler beim √ñffnen des Clothing-Modals:', error);
        showAlert('Fehler beim √ñffnen des Bearbeiten-Dialogs', 'error');
    }
}

function editSelectedClothing() {
    if (selectedClothing.length !== 1) {
        showAlert('Bitte genau einen Artikel zum Bearbeiten ausw√§hlen', 'error');
        return;
    }
    
    const clothingId = selectedClothing[0];
    openClothingModal(clothingId);
}

async function deleteSelectedClothing() {
    if (selectedClothing.length === 0) {
        showAlert('Bitte mindestens einen Artikel zum L√∂schen ausw√§hlen', 'error');
        return;
    }
    
    const clothingNames = selectedClothing.map(id => {
        const item = clothingItems.find(c => c.id === id);
        return item ? item.name : 'Unbekannt';
    }).join(', ');
    
    if (confirm(`M√∂chtest du diese ${selectedClothing.length} Kleidungsartikel wirklich l√∂schen?\n\n${clothingNames}\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
        try {
            for (const clothingId of selectedClothing) {
                await apiCall(`/api/clothing-items/${clothingId}`, { method: 'DELETE' });
            }
            showAlert(`${selectedClothing.length} Kleidungsartikel erfolgreich gel√∂scht`, 'success');
            loadClothingItems();
        } catch (error) {
            showAlert('Fehler beim L√∂schen der Kleidungsartikel', 'error');
        }
    }
}

async function saveClothingItem() {
    const saveBtn = document.getElementById('saveClothingBtn');
    const clothingId = document.getElementById('clothingId').value;
    
    // Gr√∂√üen und Farben aus Textareas
    const sizes = document.getElementById('clothingSizes').value
        .split('\n')
        .map(s => s.trim())
        .filter(s => s.length > 0);
    
    const colors = document.getElementById('clothingColors').value
        .split('\n')
        .map(c => c.trim())
        .filter(c => c.length > 0);
    
    const clothingData = {
        name: document.getElementById('clothingName').value,
        emoji: document.getElementById('clothingEmoji').value || 'üëï',
        price: parseFloat(document.getElementById('clothingPrice').value),
        sizes: sizes,
        colors: colors,
        available: document.getElementById('clothingAvailable').checked,
        image_url: uploadedImageUrl || document.getElementById('currentClothingImageUrl').value || null,
        image_file_path: document.getElementById('currentClothingImagePath').value || null
    };
    
    try {
        saveBtn.disabled = true;
        saveBtn.textContent = '‚è≥ Speichere...';
        
        // Bild hochladen, falls vorhanden
        if (currentImageFile) {
            const uploadResult = await uploadImageToAPI(currentImageFile, clothingId || 'new');
            clothingData.image_url = uploadResult.imageUrl;
            clothingData.image_file_path = uploadResult.filePath;
        }
        
        if (clothingId) {
            // Update
            await apiCall(`/api/clothing-items/${clothingId}`, {
                method: 'PUT',
                body: JSON.stringify(clothingData)
            });
            showAlert('Kleidungsartikel erfolgreich aktualisiert', 'success');
        } else {
            // Create
            await apiCall('/api/clothing-items', {
                method: 'POST',
                body: JSON.stringify(clothingData)
            });
            showAlert('Kleidungsartikel erfolgreich erstellt', 'success');
        }
        
        closeModal('clothingModal');
        loadClothingItems();
        
    } catch (error) {
        console.error('Fehler beim Speichern:', error);
        showAlert('Fehler beim Speichern des Artikels', 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Speichern';
    }
}

function triggerClothingFileInput() {
    document.getElementById('clothingPhotoInput').click();
}

async function handleClothingPhotoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (file.size > 2 * 1024 * 1024) {
        showAlert('Bild ist zu gro√ü. Maximum: 2MB', 'error');
        return;
    }
    
    if (!file.type.startsWith('image/')) {
        showAlert('Bitte nur Bilddateien hochladen', 'error');
        return;
    }
    
    currentImageFile = file;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const photoPreview = document.getElementById('clothingPhotoPreviewContainer');
        const photoActions = document.getElementById('clothingPhotoActions');
        
        if (photoPreview) {
            photoPreview.innerHTML = `<img src="${e.target.result}" class="photo-preview" alt="Vorschau">`;
        }
        if (photoActions) {
            photoActions.style.display = 'block';
        }
    };
    reader.readAsDataURL(file);
}

function removeClothingPhoto() {
    currentImageFile = null;
    uploadedImageUrl = null;
    document.getElementById('currentClothingImageUrl').value = '';
    document.getElementById('currentClothingImagePath').value = '';
    
    const photoPreview = document.getElementById('clothingPhotoPreviewContainer');
    const photoActions = document.getElementById('clothingPhotoActions');
    
    if (photoPreview) {
        photoPreview.innerHTML = '<div id="clothingPhotoPlaceholder"><p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p><p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p></div>';
    }
    if (photoActions) {
        photoActions.style.display = 'none';
    }
    
    document.getElementById('clothingPhotoInput').value = '';
}

// ============ ORDERS FUNCTIONS ============

let orders = [];
let selectedOrders = [];

async function loadOrders() {
    try {
        const loadBtn = document.getElementById('loadOrdersBtn');
        if (loadBtn) {
            loadBtn.disabled = true;
            loadBtn.textContent = '‚è≥ Lade...';
        }
        
        orders = await apiCall('/api/clothing-orders');
        renderOrders();
        showAlert(`${orders.length} Bestellungen erfolgreich geladen`, 'success');
        
    } catch (error) {
        console.error('Fehler beim Laden der Bestellungen:', error);
        showAlert('Fehler beim Laden der Bestellungen', 'error');
    } finally {
        const loadBtn = document.getElementById('loadOrdersBtn');
        if (loadBtn) {
            loadBtn.disabled = false;
            loadBtn.textContent = 'üîÑ Neu laden';
        }
    }
}

function renderOrders() {
    const tbody = document.querySelector('#ordersTable tbody');
    selectedOrders = [];
    updateSelectionInfo('orders');
    
    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">Keine Bestellungen verf√ºgbar</td></tr>';
        return;
    }
    
    tbody.innerHTML = orders.map(order => {
        const date = new Date(order.created_at);
        const statusColors = {
            'pending': '#f39c12',
            'paid': '#27ae60',
            'confirmed': '#3498db',
            'shipped': '#9b59b6',
            'completed': '#95a5a6',
            'cancelled': '#e74c3c'
        };
        const statusTexts = {
            'pending': '‚è≥ Ausstehend',
            'paid': '‚úÖ Bezahlt',
            'confirmed': 'üìã Best√§tigt',
            'shipped': 'üöö Versandt',
            'completed': '‚úîÔ∏è Abgeschlossen',
            'cancelled': '‚ùå Storniert'
        };
        const paymentIcons = {
            'sepa': 'üí≥ SEPA',
            'transfer': 'üè¶ √úberweisung',
            'paypal': 'üí∞ PayPal'
        };
        
        const itemCount = order.items ? order.items.length : 0;
        
        return `
            <tr>
                <td class="checkbox-cell">
                    <input type="checkbox" value="${order.id}" onchange="toggleRowSelection(this, 'orders')">
                </td>
                <td><code>#${order.id}</code></td>
                <td style="font-size: 0.85em;">${date.toLocaleDateString('de-DE')} ${date.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}</td>
                <td><strong>${order.member_name}</strong></td>
                <td>${itemCount} Artikel</td>
                <td><strong>${order.total.toFixed(2)} ‚Ç¨</strong></td>
                <td>${paymentIcons[order.payment_method] || order.payment_method}</td>
                <td style="text-align: center;">
                    ${order.status === 'paid' || order.status === 'shipped' || order.status === 'completed' ? '‚úÖ' : '‚ùå'}
                </td>
                <td style="text-align: center;">
                    ${order.status === 'shipped' || order.status === 'completed' ? '‚úÖ' : '‚ùå'}
                </td>
            </tr>
        `;
    }).join('');
}

async function markSelectedOrdersAsPaid() {
    if (selectedOrders.length === 0) {
        showAlert('Bitte mindestens eine Bestellung ausw√§hlen', 'error');
        return;
    }
    
    const orderNumbers = selectedOrders.map(id => {
        const order = orders.find(o => o.id === id);
        return order ? `#${order.id}` : 'Unbekannt';
    }).join(', ');
    
    if (!confirm(`M√∂chtest du diese ${selectedOrders.length} Bestellung(en) als bezahlt markieren?\n\n${orderNumbers}`)) {
        return;
    }
    
    try {
        for (const orderId of selectedOrders) {
            await apiCall(`/api/clothing-orders/${orderId}`, {
                method: 'PUT',
                body: JSON.stringify({
                    status: 'paid',
                    notes: 'Als bezahlt markiert'
                })
            });
        }
        
        showAlert(`${selectedOrders.length} Bestellung(en) als bezahlt markiert`, 'success');
        loadOrders();
        loadPendingClothingOrders(); // Dashboard aktualisieren
        
    } catch (error) {
        showAlert('Fehler beim Aktualisieren der Bestellungen', 'error');
        console.error('Error:', error);
    }
}

async function markSelectedOrdersAsShipped() {
    if (selectedOrders.length === 0) {
        showAlert('Bitte mindestens eine Bestellung ausw√§hlen', 'error');
        return;
    }
    
    // Pr√ºfe, ob alle ausgew√§hlten Bestellungen bereits bezahlt sind
    const unpaidOrders = selectedOrders.filter(id => {
        const order = orders.find(o => o.id === id);
        return order && order.status === 'pending';
    });
    
    if (unpaidOrders.length > 0) {
        showAlert('‚ö†Ô∏è Einige Bestellungen sind noch nicht als bezahlt markiert!', 'error');
        return;
    }
    
    const orderNumbers = selectedOrders.map(id => {
        const order = orders.find(o => o.id === id);
        return order ? `#${order.id}` : 'Unbekannt';
    }).join(', ');
    
    if (!confirm(`M√∂chtest du diese ${selectedOrders.length} Bestellung(en) als ausgeliefert markieren?\n\n${orderNumbers}`)) {
        return;
    }
    
    try {
        for (const orderId of selectedOrders) {
            await apiCall(`/api/clothing-orders/${orderId}`, {
                method: 'PUT',
                body: JSON.stringify({
                    status: 'shipped',
                    notes: 'Als ausgeliefert markiert'
                })
            });
        }
        
        showAlert(`${selectedOrders.length} Bestellung(en) als ausgeliefert markiert`, 'success');
        loadOrders();
        loadPendingClothingOrders(); // Dashboard aktualisieren
        
    } catch (error) {
        showAlert('Fehler beim Aktualisieren der Bestellungen', 'error');
        console.error('Error:', error);
    }
}
    
function viewOrderDetails() {
    if (selectedOrders.length !== 1) {
        showAlert('Bitte genau eine Bestellung ausw√§hlen', 'error');
        return;
    }
    
    const orderId = selectedOrders[0];
    const order = orders.find(o => o.id === orderId);
    
    if (!order) {
        showAlert('Bestellung nicht gefunden', 'error');
        return;
    }
    
    const date = new Date(order.created_at);
    const paymentNames = {
        'sepa': 'SEPA-Lastschrift',
        'transfer': 'Bank√ºberweisung',
        'paypal': 'PayPal'
    };
    
    let itemsHtml = order.items.map(item => `
        <tr>
            <td>${item.name}</td>
            <td>${item.size || '-'}</td>
            <td>${item.color || '-'}</td>
            <td>${item.quantity}x</td>
            <td style="text-align: right;">${item.price.toFixed(2)} ‚Ç¨</td>
            <td style="text-align: right;"><strong>${item.total.toFixed(2)} ‚Ç¨</strong></td>
        </tr>
    `).join('');
    
    const modalHtml = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;" onclick="this.remove()">
            <div style="background: white; padding: 30px; border-radius: 12px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                <h2 style="margin-top: 0; color: #667eea;">üì¶ Bestelldetails #${order.id}</h2>
                
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>Mitglied:</strong> ${order.member_name}</div>
                        <div><strong>Datum:</strong> ${date.toLocaleDateString('de-DE')} ${date.toLocaleTimeString('de-DE')}</div>
                        <div><strong>Zahlungsart:</strong> ${paymentNames[order.payment_method] || order.payment_method}</div>
                        <div><strong>Status:</strong> ${order.status}</div>
                    </div>
                    ${order.notes ? `<div style="margin-top: 10px;"><strong>Notizen:</strong> ${order.notes}</div>` : ''}
                </div>
                
                <h3>Bestellte Artikel:</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #667eea; color: white;">
                            <th style="padding: 8px; text-align: left;">Artikel</th>
                            <th style="padding: 8px; text-align: left;">Gr√∂√üe</th>
                            <th style="padding: 8px; text-align: left;">Farbe</th>
                            <th style="padding: 8px; text-align: left;">Menge</th>
                            <th style="padding: 8px; text-align: right;">Einzelpreis</th>
                            <th style="padding: 8px; text-align: right;">Gesamt</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                        <tr style="border-top: 2px solid #667eea; font-weight: bold;">
                            <td colspan="5" style="padding: 8px; text-align: right;">Gesamtbetrag:</td>
                            <td style="padding: 8px; text-align: right; color: #667eea; font-size: 1.2em;">${order.total.toFixed(2)} ‚Ç¨</td>
                        </tr>
                    </tbody>
                </table>
                
                <button onclick="this.closest('[style*=fixed]').remove()" style="margin-top: 20px; background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
                    Schlie√üen
                </button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

async function deleteSelectedOrders() {
    if (selectedOrders.length === 0) {
        showAlert('Bitte mindestens eine Bestellung ausw√§hlen', 'error');
        return;
    }
    
    const orderNumbers = selectedOrders.map(id => {
        const order = orders.find(o => o.id === id);
        return order ? `#${order.id} (${order.member_name})` : 'Unbekannt';
    }).join(', ');
    
    if (!confirm(`M√∂chtest du diese ${selectedOrders.length} Bestellung(en) wirklich l√∂schen?\n\n${orderNumbers}\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
        return;
    }
    
    try {
        for (const orderId of selectedOrders) {
            await apiCall(`/api/clothing-orders/${orderId}`, {
                method: 'DELETE'
            });
        }
        
        showAlert(`${selectedOrders.length} Bestellung(en) erfolgreich gel√∂scht`, 'success');
        loadOrders();
        loadPendingClothingOrders();
        
    } catch (error) {
        showAlert('Fehler beim L√∂schen der Bestellungen', 'error');
        console.error('Error:', error);
    }
}
    
        // ============ TRANSACTIONS FUNCTIONS ============

        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();
                allTransactions = data;
                transactions = data;
                renderTransactions();
                updateTransactionSummary();
            } catch (error) {
                console.error('Fehler beim Laden der Transaktionen:', error);
                alert('Fehler beim Laden der Transaktionen');
            }
        }

        async function deleteTransaction(transactionId, transactionInfo) {
            if (!confirm(`M√∂chtest du diese Transaktion wirklich l√∂schen?\n\n${transactionInfo}\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                // Hole die Transaktion f√ºr Details
                const transaction = allTransactions.find(t => t.id === transactionId);
                if (!transaction) {
                    showAlert('Transaktion nicht gefunden', 'error');
                    return;
                }
                
                // L√∂sche die Transaktion
                await apiCall(`/api/transactions/${transactionId}`, {
                    method: 'DELETE'
                });
                
                // Aktualisiere den Benutzersaldo (addiere den Betrag zur√ºck)
                const user = await apiCall(`/api/users/id/${transaction.user_id}`);
                await apiCall(`/api/users/${transaction.user_id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        ...user,
                        balance: user.balance + transaction.total
                    })
                });
                
                // Aktualisiere den Produktbestand (addiere die Menge zur√ºck)
                const product = await apiCall(`/api/products/${transaction.product_id}`).catch(() => null);
                if (product) {
                    await apiCall(`/api/products/${transaction.product_id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...product,
                            stock: product.stock + transaction.quantity
                        })
                    });
                }
                
                showAlert('Transaktion erfolgreich gel√∂scht und Saldo wiederhergestellt', 'success');
                
                // Aktualisiere alle Ansichten
                await loadTransactions();
                await loadUsers();
                await loadDashboard();
                
            } catch (error) {
                console.error('Fehler beim L√∂schen der Transaktion:', error);
                showAlert('Fehler beim L√∂schen der Transaktion: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function deleteTransactionFromModal(transactionId, firstName, lastName) {
            try {
                showLoading(true);
                
                // Hole die Transaktion f√ºr Details
                const allTransactions = await apiCall('/api/transactions');
                const transaction = allTransactions.find(t => t.id === transactionId);
                
                if (!transaction) {
                    showAlert('Transaktion nicht gefunden', 'error');
                    return;
                }
                
                if (!confirm(`M√∂chtest du diese Transaktion wirklich l√∂schen?\n\n${transaction.product_name} - ${transaction.total.toFixed(2)}‚Ç¨\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                    showLoading(false);
                    return;
                }
                
                // L√∂sche die Transaktion
                await apiCall(`/api/transactions/${transactionId}`, {
                    method: 'DELETE'
                });
                
                // Aktualisiere den Benutzersaldo (addiere den Betrag zur√ºck)
                const user = await apiCall(`/api/users/id/${transaction.user_id}`);
                await apiCall(`/api/users/${transaction.user_id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        ...user,
                        balance: user.balance + transaction.total
                    })
                });
                
                // Aktualisiere den Produktbestand (addiere die Menge zur√ºck)
                const product = await apiCall(`/api/products/${transaction.product_id}`).catch(() => null);
                if (product) {
                    await apiCall(`/api/products/${transaction.product_id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...product,
                            stock: product.stock + transaction.quantity
                        })
                    });
                }
                
                showAlert('Transaktion erfolgreich gel√∂scht und Saldo wiederhergestellt', 'success');
                
                // Schlie√üe und √∂ffne Modal neu mit aktualisierten Daten
                closeModal('billingDetailsModal');
                
                // Warte kurz und √∂ffne dann das Modal erneut
                setTimeout(async () => {
                    await loadUsers();
                    await loadDashboard();
                    await viewUserBillings(); // √ñffnet das Modal erneut mit aktuellen Daten
                }, 500);
                
            } catch (error) {
                console.error('Fehler beim L√∂schen der Transaktion:', error);
                showAlert('Fehler beim L√∂schen der Transaktion: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }       
        
        function renderTransactions() {
            const tbody = document.querySelector('#transactionTable tbody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">Keine Transaktionen gefunden</td></tr>';
                return;
            }
            
            tbody.innerHTML = transactions.map(t => {
                const date = new Date(t.created_at);
                const formattedDate = date.toLocaleDateString('de-DE');
                const formattedTime = date.toLocaleTimeString('de-DE');
                
                // L√∂sch-Button nur f√ºr nicht abgerechnete Transaktionen
                const deleteBtn = !t.is_billed && !t.billing_id ? 
                    `<button class="btn btn-danger" onclick="deleteTransaction(${t.id}, '${t.product_name} - ${t.total.toFixed(2)}‚Ç¨')" style="padding: 5px 10px; font-size: 0.8em;">üóëÔ∏è</button>` : 
                    '<span style="color: #38a169; font-size: 0.85em;">‚úÖ Abgerechnet</span>';
                
                return `
                    <tr>
                        <td>${formattedDate}<br><small>${formattedTime}</small></td>
                        <td>${t.user_name}</td>
                        <td>${t.product_name}</td>
                        <td>${t.quantity}</td>
                        <td>${t.price.toFixed(2)}‚Ç¨</td>
                        <td><strong>${t.total.toFixed(2)}‚Ç¨</strong></td>
                        <td>${t.payment_method === 'balance' ? 'Saldo' : t.payment_method}</td>
                        <td>${deleteBtn}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterTransactions() {
            const filter = document.getElementById('transactionFilter').value;
            const now = new Date();
            
            if (filter === 'all') {
                transactions = allTransactions;
            } else if (filter === 'today') {
                const today = now.toISOString().split('T')[0];
                transactions = allTransactions.filter(t => t.created_at.startsWith(today));
            } else if (filter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                transactions = allTransactions.filter(t => new Date(t.created_at) >= weekAgo);
            } else if (filter === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                transactions = allTransactions.filter(t => new Date(t.created_at) >= monthAgo);
            }
            
            renderTransactions();
            updateTransactionSummary();
        }

        function updateTransactionSummary() {
            const summary = document.getElementById('transactionSummary');
            const totalRevenue = transactions.reduce((sum, t) => sum + t.total, 0);
            
            document.getElementById('transactionCountSpan').textContent = transactions.length;
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);
            
            summary.style.display = 'block';
        }

        function exportTransactions() {
            if (transactions.length === 0) {
                alert('Keine Transaktionen zum Exportieren');
                return;
            }
            
            const csv = [
                ['Datum', 'Zeit', 'Mitglied', 'Produkt', 'Menge', 'Preis', 'Gesamt', 'Zahlungsart'].join(';'),
                ...transactions.map(t => {
                    const date = new Date(t.created_at);
                    return [
                        date.toLocaleDateString('de-DE'),
                        date.toLocaleTimeString('de-DE'),
                        t.user_name,
                        t.product_name,
                        t.quantity,
                        t.price.toFixed(2),
                        t.total.toFixed(2),
                        t.payment_method
                    ].join(';');
                })
            ].join('\n');
            
            downloadFile(csv, 'transaktionen.csv', 'text/csv');
        }

        // ============ SETTINGS FUNCTIONS (vorher BARCODES) ============

async function loadAllSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                // Barcode-Einstellungen
                if (settings.checkout_barcode) {
                    document.getElementById('checkoutBarcode').value = settings.checkout_barcode;
                }
                if (settings.cancel_barcode) {
                    document.getElementById('cancelBarcode').value = settings.cancel_barcode;
                }
                if (settings.reset_barcode) {
                    document.getElementById('resetBarcode').value = settings.reset_barcode;
                }

                // SEPA-Einstellungen
                if (settings.creditor_name) {
                    document.getElementById('creditorName').value = settings.creditor_name;
                }
                if (settings.creditor_id) {
                    document.getElementById('creditorId').value = settings.creditor_id;
                }
                if (settings.creditor_iban) {
                    document.getElementById('creditorIban').value = settings.creditor_iban;
                }
                if (settings.creditor_bic) {
                    document.getElementById('creditorBic').value = settings.creditor_bic;
                }
                if (settings.sepa_reference) {
                    document.getElementById('sepaReference').value = settings.sepa_reference;
                }
                if (settings.sepa_sequence_type) {
                    document.getElementById('sepaSequenceType').value = settings.sepa_sequence_type;
                }

                // √úberweisungs-Einstellungen
                if (settings.transfer_iban) {
                    document.getElementById('transferIban').value = settings.transfer_iban;
                }
                if (settings.transfer_bic) {
                    document.getElementById('transferBic').value = settings.transfer_bic;
                }
                 
                // PayPal-Einstellungen
                if (settings.paypal_account) {
                    document.getElementById('paypalAccount').value = settings.paypal_account;
                }

                // NEU: PIN-Einstellungen
                if (settings.bartender_pin) {
                    document.getElementById('bartenderPin').value = settings.bartender_pin;
                }
                if (settings.member_pin) {
                    document.getElementById('memberPin').value = settings.member_pin;
                }
                      
            } catch (error) {
                console.log('Keine gespeicherten Einstellungen gefunden, verwende Standardwerte');
            }
        }

        async function saveAllSettings() {
            const settings = {
                // Barcode-Einstellungen
                checkout_barcode: document.getElementById('checkoutBarcode').value,
                cancel_barcode: document.getElementById('cancelBarcode').value,
                reset_barcode: document.getElementById('resetBarcode').value,
                
                // SEPA-Einstellungen
                creditor_name: document.getElementById('creditorName').value,
                creditor_id: document.getElementById('creditorId').value,
                creditor_iban: document.getElementById('creditorIban').value.replace(/\s/g, ''),
                creditor_bic: document.getElementById('creditorBic').value,
                sepa_reference: document.getElementById('sepaReference').value,
                sepa_sequence_type: document.getElementById('sepaSequenceType').value,

                // √úberweisungs-Einstellungen (NEW)
                transfer_iban: document.getElementById('transferIban').value.replace(/\s/g, '') || null,
                transfer_bic: document.getElementById('transferBic').value || null,

                // PayPal-Einstellungen
                paypal_account: document.getElementById('paypalAccount').value,

                // NEU: PIN-Einstellungen hinzuf√ºgen
                bartender_pin: document.getElementById('bartenderPin').value || '0814',
                member_pin: document.getElementById('memberPin').value || '1234'                
            };

            // Validierung der Pflichtfelder
            if (!settings.creditor_name || !settings.creditor_id || !settings.creditor_iban) {
                alert('‚ö†Ô∏è Bitte f√ºlle alle SEPA-Pflichtfelder aus:\n- Vereinsname\n- Gl√§ubiger-ID\n- Vereins-IBAN');
                return;
            }

            // Validierung √úberweisungs-IBAN wenn gesetzt
            if (settings.transfer_iban && !validateIBAN(settings.transfer_iban)) {
                alert('√¢≈° √Ø¬∏ Die √úberweisungs-IBAN ist ung√É¬ºltig!');
                document.getElementById('transferIban').focus();
                return;
            }
            
            try {
                await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                showAlert('Alle Einstellungen erfolgreich gespeichert', 'success');
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                showAlert('Fehler beim Speichern der Einstellungen', 'error');
            }
        }

        // ============ BILLING FUNCTIONS (vorher SEPA) ============

        let billings = [];
        let currentBillingData = null;
        let currentUserBillingData = null;
        let selectedBillingUsers = [];  // NEU
        let usersWithDebt = [];          // NEU

        async function loadOpenBalances() {
            try {
                const allUsers = await apiCall('/api/users');
                usersWithDebt = allUsers.filter(u => u.balance < 0);
                selectedBillingUsers = [];
                
                const tbody = document.querySelector('#openBalancesTable tbody');
                
                if (usersWithDebt.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #666;">Keine offenen Betr√§ge - alle Mitglieder haben positiven oder ausgeglichenen Saldo</td></tr>';
                    document.getElementById('totalOpenAmount').textContent = '0.00‚Ç¨';
                    document.getElementById('openUsersCount').textContent = '0';
                    document.getElementById('selectAllBilling').checked = false;
                    updateBillingSelection();
                    return;
                }
                
                const totalOpen = usersWithDebt.reduce((sum, u) => sum + Math.abs(u.balance), 0);
                
                document.getElementById('totalOpenAmount').textContent = totalOpen.toFixed(2) + '‚Ç¨';
                document.getElementById('openUsersCount').textContent = usersWithDebt.length;
                document.getElementById('selectAllBilling').checked = false;
                
                tbody.innerHTML = usersWithDebt.map(user => `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" value="${user.id}" onchange="toggleBillingUser(this)">
                        </td>
                        <td>${user.first_name} ${user.last_name}</td>
                        <td style="color: #e53e3e; font-weight: bold;">${Math.abs(user.balance).toFixed(2)}‚Ç¨</td>
                        <td>${user.sepa_active && user.iban ? '‚úÖ SEPA' : '‚ùå Manuell'}</td>
                        <td style="font-size: 0.85em;">${user.email || '-'}</td>
                    </tr>
                `).join('');
                
                updateBillingSelection();
                
            } catch (error) {
                console.error('Fehler beim Laden der offenen Betr√§ge:', error);
                showAlert('Fehler beim Laden der offenen Betr√§ge', 'error');
            }
        }

        function toggleSelectAllBilling() {
            const checkbox = document.getElementById('selectAllBilling');
            const checkboxes = document.querySelectorAll('#openBalancesTable tbody input[type="checkbox"]');
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const userId = parseInt(cb.value);
                if (checkbox.checked) {
                    if (!selectedBillingUsers.includes(userId)) {
                        selectedBillingUsers.push(userId);
                    }
                } else {
                    selectedBillingUsers = selectedBillingUsers.filter(id => id !== userId);
                }
            });
            
            updateBillingSelection();
        }

        function toggleBillingUser(checkbox) {
            const userId = parseInt(checkbox.value);
            
            if (checkbox.checked) {
                if (!selectedBillingUsers.includes(userId)) {
                    selectedBillingUsers.push(userId);
                }
            } else {
                selectedBillingUsers = selectedBillingUsers.filter(id => id !== userId);
            }
            
            updateBillingSelection();
        }

        function updateBillingSelection() {
            const selectedUsers = usersWithDebt.filter(u => selectedBillingUsers.includes(u.id));
            const selectedAmount = selectedUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
            
            document.getElementById('selectedOpenAmount').textContent = selectedAmount.toFixed(2) + '‚Ç¨';
            document.getElementById('selectedBillingCount').textContent = selectedUsers.length;
            document.getElementById('selectedBillingCount2').textContent = selectedUsers.length;
            
            const createBtn = document.getElementById('createBillingBtn');
            createBtn.disabled = selectedUsers.length === 0;
        }
        
        async function createBillingFromSelection() {
            if (selectedBillingUsers.length === 0) {
                showAlert('Bitte w√§hle mindestens ein Mitglied aus', 'error');
                return;
            }

            const selectedUsers = usersWithDebt.filter(u => selectedBillingUsers.includes(u.id));
            const totalAmount = selectedUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
            const sepaCount = selectedUsers.filter(u => u.sepa_active && u.iban).length;
            const nonSepaCount = selectedUsers.length - sepaCount;

            const confirmMessage = `M√∂chtest du wirklich ${selectedUsers.length} Mitglieder abrechnen?

Gesamtbetrag: ${totalAmount.toFixed(2)}‚Ç¨
- SEPA-Lastschrift: ${sepaCount} Mitglieder
- Manuelle Abrechnung: ${nonSepaCount} Mitglieder

Nach der Abrechnung werden die Salden auf 0‚Ç¨ gesetzt.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showLoading(true);
                
                const sepaUsers = selectedUsers.filter(u => u.sepa_active && u.iban);
                const nonSepaUsers = selectedUsers.filter(u => !u.sepa_active || !u.iban);
                
                const now = new Date();
                const billingNumber = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                
                const sepaAmount = sepaUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
                const nonSepaAmount = nonSepaUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
                
                const billingData = {
                    billing_number: billingNumber,
                    total_amount: totalAmount,
                    sepa_amount: sepaAmount,
                    non_sepa_amount: nonSepaAmount,
                    sepa_user_count: sepaUsers.length,
                    non_sepa_user_count: nonSepaUsers.length,
                    status: 'completed'
                };
                
                const billing = await apiCall('/api/billings', {
                    method: 'POST',
                    body: JSON.stringify(billingData)
                });
                
                if (selectedBillingUsers.length > 0) {
                    await apiCall('/api/transactions/mark-billed', {
                        method: 'POST',
                        body: JSON.stringify({
                            billing_id: billing.id,
                            user_ids: selectedBillingUsers
                        })
                    });
                }
                
                for (const user of selectedUsers) {
                    await apiCall(`/api/users/${user.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...user,
                            balance: 0
                        })
                    });
                }
                
                showAlert(`‚úÖ Abrechnung ${billingNumber} erfolgreich erstellt!\n\nSEPA: ${sepaUsers.length} Benutzer (${sepaAmount.toFixed(2)}‚Ç¨)\nManuell: ${nonSepaUsers.length} Benutzer (${nonSepaAmount.toFixed(2)}‚Ç¨)`, 'success');
                
const sepaUsersWithAmount = sepaUsers.map(u => ({
    ...u,
    billing_amount: Math.abs(u.balance),
    transactions: []  // NEU: Leeres Array f√ºr neue Abrechnungen
}));

const nonSepaUsersWithAmount = nonSepaUsers.map(u => ({
    ...u,
    billing_amount: Math.abs(u.balance),
    transactions: []  // NEU: Leeres Array f√ºr neue Abrechnungen
}));
                
                showBillingDetails(billing, sepaUsersWithAmount, nonSepaUsersWithAmount);
                
                await loadOpenBalances();
                await loadBillingHistory();
                await loadDashboard();
                
            } catch (error) {
                console.error('Fehler beim Erstellen der Abrechnung:', error);
                showAlert('Fehler beim Erstellen der Abrechnung: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function loadBillingHistory() {
            try {
                billings = await apiCall('/api/billings');
                renderBillingHistory();
            } catch (error) {
                console.error('Fehler beim Laden der Abrechnungshistorie:', error);
                showAlert('Fehler beim Laden der Abrechnungshistorie', 'error');
            }
        }

async function viewUserBillings() {
    if (selectedUsers.length !== 1) return;
    
    try {
        showLoading(true);
        
        // WICHTIG: Lade Abrechnungen IMMER neu, um aktuelle Daten zu haben
        await loadBillingHistory();
        
        const userId = selectedUsers[0];
        const user = users.find(u => u.id === userId);
        
        if (!user) {
            showAlert('Mitglied nicht gefunden', 'error');
            return;
        }
        
        // Lade alle Transaktionen des Mitglieds
        const allTransactions = await apiCall('/api/transactions');
        const userTransactions = allTransactions.filter(t => t.user_id === userId);
        
        if (userTransactions.length === 0) {
            showAlert(`Keine Transaktionen f√ºr ${user.first_name} ${user.last_name} gefunden`, 'info');
            return;
        }
        
        // Gruppiere nach Abrechnungen
        const billedTransactions = userTransactions.filter(t => t.billing_id);
        const unbilledTransactions = userTransactions.filter(t => !t.billing_id);
        
        // Gruppiere abgerechnete Transaktionen nach billing_id
        const billingGroups = {};
        billedTransactions.forEach(t => {
            if (!billingGroups[t.billing_id]) {
                billingGroups[t.billing_id] = [];
            }
            billingGroups[t.billing_id].push(t);
        });
        
        // Debug: Zeige an, wie viele Abrechnungen gefunden wurden
        console.log('Gefundene Abrechnungen:', Object.keys(billingGroups).length);
        console.log('Billing Groups:', billingGroups);
        console.log('Billings Array:', billings);
        
        // Erstelle Modal-Inhalt
        showUserBillingHistory(user, billingGroups, unbilledTransactions);
        
    } catch (error) {
        console.error('Fehler beim Laden der Abrechnungen:', error);
        showAlert('Fehler beim Laden der Abrechnungshistorie', 'error');
    } finally {
        showLoading(false);
    }
}
        
function showUserBillingHistory(user, billingGroups, unbilledTransactions) {
    const modal = document.getElementById('billingDetailsModal');
    const title = document.getElementById('billingDetailsTitle');
    const content = document.getElementById('billingDetailsContent');
    
    title.textContent = `Abrechnungen: ${user.first_name} ${user.last_name}`;
    
    let html = `
        <div style="margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px;">
            <p><strong>Mitglied:</strong> ${user.first_name} ${user.last_name}</p>
            <p><strong>Aktueller Saldo:</strong> <span style="color: ${user.balance >= 0 ? '#38a169' : '#e53e3e'}; font-weight: bold;">${user.balance.toFixed(2)}‚Ç¨</span></p>
            <p><strong>Gesamt Transaktionen:</strong> ${Object.values(billingGroups).flat().length + unbilledTransactions.length}</p>
        </div>
        
        <hr style="margin: 20px 0; border: none; border-top: 2px solid #e2e8f0;">
    `;
    
    // Nicht abgerechnete Transaktionen
    if (unbilledTransactions.length > 0) {
        const unbilledTotal = unbilledTransactions.reduce((sum, t) => sum + t.total, 0);
        html += `
            <h3 style="color: #ed8936; margin-bottom: 15px;">‚ö†Ô∏è Noch nicht abgerechnet (${unbilledTransactions.length} Transaktionen - ${unbilledTotal.toFixed(2)}‚Ç¨)</h3>
            
            <div style="margin-bottom: 15px;">
                <button class="btn btn-warning" onclick='exportSinglePeriodCSV(${JSON.stringify(unbilledTransactions)}, "${user.first_name}", "${user.last_name}", "nicht_abgerechnet")'>
                    üìä Diese Transaktionen als CSV exportieren
                </button>
            </div>
            
            <div style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <table class="data-table" style="font-size: 0.85em;">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Produkt</th>
                            <th>Menge</th>
                            <th>Preis</th>
                            <th>Gesamt</th>
                            <th>Aktion</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${unbilledTransactions.map(t => {
                            const date = new Date(t.created_at);
                            return `
                                <tr>
                                    <td>${date.toLocaleDateString('de-DE')}<br><small>${date.toLocaleTimeString('de-DE')}</small></td>
                                    <td>${t.product_name}</td>
                                    <td>${t.quantity}</td>
                                    <td>${t.price.toFixed(2)}‚Ç¨</td>
                                    <td><strong>${t.total.toFixed(2)}‚Ç¨</strong></td>
                                    <td>
                                        <button class="btn btn-danger" onclick="deleteTransactionFromModal(${t.id}, '${user.first_name}', '${user.last_name}')" style="padding: 3px 8px; font-size: 0.75em;">
                                            üóëÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                        <tr style="background: #fff5e6; font-weight: bold;">
                            <td colspan="4" style="text-align: right;">Summe:</td>
                            <td colspan="2">${unbilledTotal.toFixed(2)}‚Ç¨</td>
                        </tr>                    </tbody>
                </table>
            </div>
            <hr style="margin: 20px 0; border: none; border-top: 2px solid #e2e8f0;">
        `;
    }
    
    // Abgerechnete Transaktionen nach Abrechnung gruppiert
    if (Object.keys(billingGroups).length > 0) {
        html += `<h3 style="color: #38a169; margin-bottom: 15px;">‚úÖ Abgerechnete Perioden (${Object.keys(billingGroups).length})</h3>`;
        
for (const [billingId, transactions] of Object.entries(billingGroups).sort((a, b) => {
    const billingA = billings.find(bill => bill.id === parseInt(a[0]));
    const billingB = billings.find(bill => bill.id === parseInt(b[0]));
    return new Date(billingB?.created_at || 0) - new Date(billingA?.created_at || 0);
})) {       const billing = billings.find(b => b.id === parseInt(billingId));
            const billingTotal = transactions.reduce((sum, t) => sum + t.total, 0);
            const billingDate = billing ? new Date(billing.created_at).toLocaleDateString('de-DE') : 'Unbekannt';
            const billingNumber = billing ? billing.billing_number : billingId;
            
            html += `
                <div style="margin-bottom: 20px; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f8fafc; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="cursor: pointer; flex: 1;" onclick="toggleUserTransactions('billing-${billingId}')">
                            <strong>‚ñ∂Ô∏è Abrechnung ${billingNumber}</strong> 
                            <span style="margin-left: 15px;">üìÖ ${billingDate}</span>
                            <span style="margin-left: 15px; color: #e53e3e; font-weight: bold;">${billingTotal.toFixed(2)}‚Ç¨</span>
                            <span style="margin-left: 15px; color: #666;">(${transactions.length} Transaktionen)</span>
                        </div>
                        <button class="btn btn-success" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick='event.stopPropagation(); exportSinglePeriodCSV(${JSON.stringify(transactions)}, "${user.first_name}", "${user.last_name}", "${billingNumber}")'>
                            üìä CSV
                        </button>
                    </div>
                    <div id="billing-${billingId}" style="display: none;">
                        <table class="data-table" style="font-size: 0.85em;">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Produkt</th>
                                    <th>Menge</th>
                                    <th>Preis</th>
                                    <th>Gesamt</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transactions.map(t => {
                                    const date = new Date(t.created_at);
                                    return `
                                        <tr>
                                            <td>${date.toLocaleDateString('de-DE')}<br><small>${date.toLocaleTimeString('de-DE')}</small></td>
                                            <td>${t.product_name}</td>
                                            <td>${t.quantity}</td>
                                            <td>${t.price.toFixed(2)}‚Ç¨</td>
                                            <td><strong>${t.total.toFixed(2)}‚Ç¨</strong></td>
                                        </tr>
                                    `;
                                }).join('')}
                                <tr style="background: #e6f3ff; font-weight: bold;">
                                    <td colspan="4" style="text-align: right;">Summe:</td>
                                    <td>${billingTotal.toFixed(2)}‚Ç¨</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
    }
    
    if (Object.keys(billingGroups).length === 0 && unbilledTransactions.length === 0) {
        html += '<p style="text-align: center; color: #666; padding: 30px;">Keine Transaktionen gefunden</p>';
    }
    
    content.innerHTML = html;
    modal.style.display = 'block';
}
        
        function renderBillingHistory() {
            const tbody = document.querySelector('#billingHistoryTable tbody');
            
            if (billings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #666;">Noch keine Abrechnungen erstellt</td></tr>';
                return;
            }
            
            // Sortiere nach Datum absteigend
            billings.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            tbody.innerHTML = billings.map(billing => {
                const date = new Date(billing.created_at);
                const formattedDate = date.toLocaleDateString('de-DE') + ' ' + date.toLocaleTimeString('de-DE');
                
                return `
                    <tr>
                        <td><strong>${billing.billing_number}</strong></td>
                        <td>${formattedDate}</td>
                        <td><strong>${billing.total_amount.toFixed(2)}‚Ç¨</strong></td>
                        <td>${billing.sepa_user_count} (${billing.sepa_amount.toFixed(2)}‚Ç¨)</td>
                        <td>${billing.non_sepa_user_count} (${billing.non_sepa_amount.toFixed(2)}‚Ç¨)</td>
                        <td>
                            <button class="btn" onclick="viewBillingDetails(${billing.id})" style="padding: 5px 10px; font-size: 0.8em;">
                                üëÅÔ∏è Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

async function viewBillingDetails(billingId) {
    try {
        showLoading(true);
        
        const billing = billings.find(b => b.id === billingId);
        if (!billing) {
            showAlert('Abrechnung nicht gefunden', 'error');
            return;
        }
        
        // Lade alle Transaktionen dieser Abrechnung
        const transactions = await apiCall(`/api/billings/${billingId}/transactions`);
        
        // Lade alle betroffenen Benutzer
        const userIds = [...new Set(transactions.map(t => t.user_id))];
        const usersData = await Promise.all(
            userIds.map(id => apiCall(`/api/users/id/${id}`).catch(() => null))
        );
        const usersMap = {};
        usersData.filter(u => u).forEach(u => usersMap[u.id] = u);
        
        // Gruppiere nach SEPA/Nicht-SEPA MIT Transaktionen
        const sepaUsers = [];
        const nonSepaUsers = [];
        
        userIds.forEach(userId => {
            const user = usersMap[userId];
            if (!user) return;
            
            const userTransactions = transactions.filter(t => t.user_id === userId);
            const userTotal = userTransactions.reduce((sum, t) => sum + t.total, 0);
            
            const userData = {
                ...user,
                billing_amount: userTotal,
                transaction_count: userTransactions.length,
                transactions: userTransactions  // NEU: Transaktionen mitgeben
            };
            
            if (user.sepa_active && user.iban) {
                sepaUsers.push(userData);
            } else {
                nonSepaUsers.push(userData);
            }
        });
        
        showBillingDetails(billing, sepaUsers, nonSepaUsers);
        
    } catch (error) {
        console.error('Fehler beim Laden der Details:', error);
        showAlert('Fehler beim Laden der Abrechnungs-Details', 'error');
    } finally {
        showLoading(false);
    }
}

function showBillingDetails(billing, sepaUsers, nonSepaUsers) {
    const modal = document.getElementById('billingDetailsModal');
    const title = document.getElementById('billingDetailsTitle');
    const content = document.getElementById('billingDetailsContent');
    
    title.textContent = `Abrechnung ${billing.billing_number}`;
    
    const sepaTotal = sepaUsers.reduce((sum, u) => sum + (u.billing_amount || Math.abs(u.balance) || 0), 0);
    const nonSepaTotal = nonSepaUsers.reduce((sum, u) => sum + (u.billing_amount || Math.abs(u.balance) || 0), 0);
    
    let html = `
        <div style="margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px;">
          <div style="margin-bottom: 15px;">
            <button class="btn btn-success" onclick="exportBillingDetailsCSV()">
            üìä Komplette Abrechnung als CSV exportieren
            </button>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 2px solid #e2e8f0;">

            <p><strong>Datum:</strong> ${new Date(billing.created_at).toLocaleString('de-DE')}</p>
            <p><strong>Gesamtbetrag:</strong> ${billing.total_amount.toFixed(2)}‚Ç¨</p>
            <p><strong>Status:</strong> ${billing.status === 'completed' ? '‚úÖ Abgeschlossen' : billing.status}</p>
        </div>
        
        <hr style="margin: 20px 0; border: none; border-top: 2px solid #e2e8f0;">
        
        <h3 style="color: #38a169; margin-bottom: 15px;">üí≥ SEPA-Lastschrift (${sepaUsers.length} Mitglieder - ${sepaTotal.toFixed(2)}‚Ç¨)</h3>
    `;
    
    if (sepaUsers.length > 0) {
        html += `
            <div style="margin-bottom: 15px;">
                <button class="btn btn-success" onclick="exportSepaForBilling(${billing.id})">
                    üìÑ SEPA-XML exportieren
                </button>
                <button class="btn btn-success" onclick="exportSepaCSVForBilling(${billing.id})">
                    üìä CSV exportieren
                </button>
            </div>
        `;
        
        sepaUsers.forEach((u, index) => {
            const amount = u.billing_amount || 0;
            html += `
                <div style="margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                    <div style="background: #f0fff4; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="cursor: pointer; flex: 1;" onclick="toggleUserTransactions('sepa-${billing.id}-${index}')">
                            <strong>‚ñ∂Ô∏è ${u.first_name} ${u.last_name}</strong>
                            <span style="margin-left: 15px;">üìß ${u.email || '-'}</span>
                            <span style="margin-left: 15px; color: #e53e3e; font-weight: bold;">${amount.toFixed(2)}‚Ç¨</span>
                            <span style="margin-left: 15px; color: #666;">(${u.transaction_count} Transaktionen)</span>
                        </div>
                        <button class="btn btn-success" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick='event.stopPropagation(); exportSinglePeriodCSV(${JSON.stringify(u.transactions)}, "${u.first_name}", "${u.last_name}", "${billing.billing_number}")'>
                            üìä CSV
                        </button>
                    </div>
                    <div id="sepa-${billing.id}-${index}" style="display: none;">
                        <table class="data-table" style="font-size: 0.85em;">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Produkt</th>
                                    <th>Menge</th>
                                    <th>Preis</th>
                                    <th>Gesamt</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(u.transactions || []).map(t => {
                                    const date = new Date(t.created_at);
                                    return `
                                        <tr>
                                            <td>${date.toLocaleDateString('de-DE')}<br><small>${date.toLocaleTimeString('de-DE')}</small></td>
                                            <td>${t.product_name}</td>
                                            <td>${t.quantity}</td>
                                            <td>${t.price.toFixed(2)}‚Ç¨</td>
                                            <td><strong>${t.total.toFixed(2)}‚Ç¨</strong></td>
                                        </tr>
                                    `;
                                }).join('')}
                                <tr style="background: #e6f3ff; font-weight: bold;">
                                    <td colspan="4" style="text-align: right;">Summe:</td>
                                    <td>${amount.toFixed(2)}‚Ç¨</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
    } else {
        html += '<p style="color: #666; padding: 15px; background: #f8fafc; border-radius: 6px;">Keine SEPA-Nutzer in dieser Abrechnung</p>';
    }
    
    html += `
        <hr style="margin: 20px 0; border: none; border-top: 2px solid #e2e8f0;">
        
        <h3 style="color: #ed8936; margin-bottom: 15px;">üìã Manuelle Abrechnung (${nonSepaUsers.length} Mitglieder - ${nonSepaTotal.toFixed(2)}‚Ç¨)</h3>
    `;
    
    if (nonSepaUsers.length > 0) {
        html += `
            <div style="margin-bottom: 15px;">
                <button class="btn btn-warning" onclick="exportNonSepaList(${billing.id})">
                    üìÑ CSV exportieren
                </button>
            </div>
        `;
        
        nonSepaUsers.forEach((u, index) => {
            const amount = u.billing_amount || 0;
            const sepaStatus = !u.sepa_active ? '‚ùå Nicht aktiviert' : (!u.iban ? '‚ö†Ô∏è IBAN fehlt' : '?');
            
            html += `
                <div style="margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                    <div style="background: #fff5e6; padding: 12px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="cursor: pointer; flex: 1;" onclick="toggleUserTransactions('nonsepa-${billing.id}-${index}')">
                            <strong>‚ñ∂Ô∏è ${u.first_name} ${u.last_name}</strong>
                            <span style="margin-left: 15px;">üìß ${u.email || '-'}</span>
                            <span style="margin-left: 15px; font-size: 0.85em;">${sepaStatus}</span>
                            <span style="margin-left: 15px; color: #e53e3e; font-weight: bold;">${amount.toFixed(2)}‚Ç¨</span>
                            <span style="margin-left: 15px; color: #666;">(${u.transaction_count} Transaktionen)</span>
                        </div>
                        <button class="btn btn-success" style="margin-left: 10px; padding: 5px 10px; font-size: 0.8em;" 
                                onclick='event.stopPropagation(); exportSinglePeriodCSV(${JSON.stringify(u.transactions)}, "${u.first_name}", "${u.last_name}", "${billing.billing_number}")'>
                            üìä CSV
                        </button>
                    </div>
                    <div id="nonsepa-${billing.id}-${index}" style="display: none;">
                        <table class="data-table" style="font-size: 0.85em;">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Produkt</th>
                                    <th>Menge</th>
                                    <th>Preis</th>
                                    <th>Gesamt</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(u.transactions || []).map(t => {
                                    const date = new Date(t.created_at);
                                    return `
                                        <tr>
                                            <td>${date.toLocaleDateString('de-DE')}<br><small>${date.toLocaleTimeString('de-DE')}</small></td>
                                            <td>${t.product_name}</td>
                                            <td>${t.quantity}</td>
                                            <td>${t.price.toFixed(2)}‚Ç¨</td>
                                            <td><strong>${t.total.toFixed(2)}‚Ç¨</strong></td>
                                        </tr>
                                    `;
                                }).join('')}
                                <tr style="background: #fff5e6; font-weight: bold;">
                                    <td colspan="4" style="text-align: right;">Summe:</td>
                                    <td>${amount.toFixed(2)}‚Ç¨</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
    } else {
        html += '<p style="color: #666; padding: 15px; background: #f8fafc; border-radius: 6px;">Keine Nicht-SEPA-Nutzer in dieser Abrechnung</p>';
    }
    
    content.innerHTML = html;
    currentBillingData = { billing, sepaUsers, nonSepaUsers };
    modal.style.display = 'block';
}

// ============ TOGGLE FUNCTION - MUSS AU√üERHALB SEIN! ============
function toggleUserTransactions(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        if (element.style.display === 'none') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
}

// ============ SEPA XML EXPORT ============
async function exportSepaForBilling(billingId) {
    if (!currentBillingData || !currentBillingData.sepaUsers) {
        showAlert('Keine SEPA-Daten verf√ºgbar', 'error');
        return;
    }

    const { billing, sepaUsers } = currentBillingData;

    if (sepaUsers.length === 0) {
        alert('Keine SEPA-Benutzer in dieser Abrechnung');
        return;
    }

    let settings = {};
    try {
        const response = await fetch('/api/settings');
        settings = await response.json();
    } catch (error) {
        alert('‚ö†Ô∏è SEPA-Einstellungen konnten nicht geladen werden.\n\nBitte konfiguriere zuerst die SEPA-Daten im Einstellungen-Tab.');
        return;
    }

    if (!settings.creditor_id || !settings.creditor_iban || !settings.creditor_name) {
        alert('‚ö†Ô∏è SEPA-Einstellungen unvollst√§ndig! Bitte im Einstellungen-Tab konfigurieren.');
        return;
    }
    
    const now = new Date();
    const msgId = `${billing.billing_number}`;
    const totalAmount = sepaUsers.reduce((sum, u) => sum + u.billing_amount, 0).toFixed(2);
    
    const executionDate = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    const formattedDate = executionDate.toISOString().split('T')[0];
    
    const sequenceType = settings.sepa_sequence_type || 'RCUR';
    const reference = settings.sepa_reference || 'Saarcade Getraenkeabrechnung';
    
    let xml = `<?xml version="1.0" encoding="UTF-8"?>
<Document xmlns="urn:iso:std:iso:20022:tech:xsd:pain.008.001.02" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <CstmrDrctDbtInitn>
        <GrpHdr>
            <MsgId>${msgId}</MsgId>
            <CreDtTm>${now.toISOString()}</CreDtTm>
            <NbOfTxs>${sepaUsers.length}</NbOfTxs>
            <CtrlSum>${totalAmount}</CtrlSum>
            <InitgPty>
                <Nm>${settings.creditor_name}</Nm>
            </InitgPty>
        </GrpHdr>
        <PmtInf>
            <PmtInfId>PMT-${billing.billing_number}</PmtInfId>
            <PmtMtd>DD</PmtMtd>
            <NbOfTxs>${sepaUsers.length}</NbOfTxs>
            <CtrlSum>${totalAmount}</CtrlSum>
            <PmtTpInf>
                <SvcLvl>
                    <Cd>SEPA</Cd>
                </SvcLvl>
                <LclInstrm>
                    <Cd>CORE</Cd>
                </LclInstrm>
                <SeqTp>${sequenceType}</SeqTp>
            </PmtTpInf>
            <ReqdColltnDt>${formattedDate}</ReqdColltnDt>
            <Cdtr>
                <Nm>${settings.creditor_name}</Nm>
            </Cdtr>
            <CdtrAcct>
                <Id>
                    <IBAN>${settings.creditor_iban.replace(/\s/g, '')}</IBAN>
                </Id>
            </CdtrAcct>
            <CdtrAgt>
                <FinInstnId>${settings.creditor_bic ? `<BIC>${settings.creditor_bic}</BIC>` : '<Othr><Id>NOTPROVIDED</Id></Othr>'}</FinInstnId>
            </CdtrAgt>
            <CdtrSchmeId>
                <Id>
                    <PrvtId>
                        <Othr>
                            <Id>${settings.creditor_id}</Id>
                            <SchmeNm>
                                <Prtry>SEPA</Prtry>
                            </SchmeNm>
                        </Othr>
                    </PrvtId>
                </Id>
            </CdtrSchmeId>
`;

    sepaUsers.forEach((user) => {
        const endToEndId = `${billing.billing_number}-${user.id}`;
        const mandateId = `MANDATE-${user.id}`;
        
        xml += `
            <DrctDbtTxInf>
                <PmtId>
                    <EndToEndId>${endToEndId}</EndToEndId>
                </PmtId>
                <InstdAmt Ccy="EUR">${user.billing_amount.toFixed(2)}</InstdAmt>
                <DrctDbtTx>
                    <MndtRltdInf>
                        <MndtId>${mandateId}</MndtId>
                        <DtOfSgntr>2024-01-01</DtOfSgntr>
                    </MndtRltdInf>
                </DrctDbtTx>
                <DbtrAgt>
                    <FinInstnId>
                        <Othr>
                            <Id>NOTPROVIDED</Id>
                        </Othr>
                    </FinInstnId>
                </DbtrAgt>
                <Dbtr>
                    <Nm>${user.first_name} ${user.last_name}</Nm>
                </Dbtr>
                <DbtrAcct>
                    <Id>
                        <IBAN>${user.iban.replace(/\s/g, '')}</IBAN>
                    </Id>
                </DbtrAcct>
                <RmtInf>
                    <Ustrd>${reference} - ${billing.billing_number}</Ustrd>
                </RmtInf>
            </DrctDbtTxInf>
`;
    });

    xml += `
        </PmtInf>
    </CstmrDrctDbtInitn>
</Document>`;

    downloadFile(xml, `sepa_${billing.billing_number}.xml`, 'application/xml');
    showAlert(`SEPA-XML f√ºr Abrechnung ${billing.billing_number} exportiert`, 'success');
}
function exportSepaCSVForBilling(billingId) {
    if (!currentBillingData || !currentBillingData.sepaUsers) {
        showAlert('Keine SEPA-Daten verf√ºgbar', 'error');
        return;
    }

    const { billing, sepaUsers } = currentBillingData;
    
    if (sepaUsers.length === 0) {
        alert('Keine SEPA-Benutzer in dieser Abrechnung');
        return;
    }
    
    const csv = [
        ['Rechnungsnummer', 'Name', 'Vorname', 'Nachname', 'E-Mail', 'IBAN', 'Betrag', 'Datum'].join(';'),
        ...sepaUsers.map(u => {
            const amount = u.billing_amount || Math.abs(u.balance) || 0;
            
            return [
                billing.billing_number,
                `${u.first_name} ${u.last_name}`,
                u.first_name,
                u.last_name,
                u.email || '-',
                u.iban || '-',
                amount.toFixed(2),
                new Date(billing.created_at).toLocaleDateString('de-DE')
            ].join(';');
        })
    ].join('\n');
    
    downloadFile(csv, `sepa_${billing.billing_number}.csv`, 'text/csv');
    showAlert('CSV-Export erfolgreich', 'success');
}
        
function exportNonSepaList(billingId) {
    if (!currentBillingData || !currentBillingData.nonSepaUsers) {
        showAlert('Keine Nicht-SEPA-Daten verf√ºgbar', 'error');
        return;
    }

    const { billing, nonSepaUsers } = currentBillingData;
    
    if (nonSepaUsers.length === 0) {
        alert('Keine Nicht-SEPA-Benutzer in dieser Abrechnung');
        return;
    }
    
    const csv = [
        ['Abrechnung', 'Name', 'Vorname', 'Nachname', 'E-Mail', 'SEPA-Status', 'Betrag', 'Datum'].join(';'),
        ...nonSepaUsers.map(u => {
            const amount = u.billing_amount || Math.abs(u.balance) || 0;
            const sepaStatus = !u.sepa_active ? 'Nicht aktiviert' : (!u.iban ? 'IBAN fehlt' : 'Unbekannt');
            
            return [
                billing.billing_number,
                `${u.first_name} ${u.last_name}`,
                u.first_name,
                u.last_name,
                u.email || '-',
                sepaStatus,
                amount.toFixed(2),
                new Date(billing.created_at).toLocaleDateString('de-DE')
            ].join(';');
        })
    ].join('\n');
    
    downloadFile(csv, `nicht_sepa_${billing.billing_number}.csv`, 'text/csv');
    showAlert('CSV-Export erfolgreich', 'success');
}

function toggleUserTransactions(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        if (element.style.display === 'none') {
            element.style.display = 'block';
            // √Ñndere Pfeil
            const parent = element.previousElementSibling || element.parentElement;
            if (parent && parent.textContent.includes('‚ñ∂Ô∏è')) {
                parent.innerHTML = parent.innerHTML.replace('‚ñ∂Ô∏è', 'üîΩ');
            }
        } else {
            element.style.display = 'none';
            // √Ñndere Pfeil zur√ºck
            const parent = element.previousElementSibling || element.parentElement;
            if (parent && parent.textContent.includes('üîΩ')) {
                parent.innerHTML = parent.innerHTML.replace('üîΩ', '‚ñ∂Ô∏è');
            }
        }
    }
}
        
function exportBillingDetailsCSV() {
    if (!currentBillingData) {
        showAlert('Keine Abrechnungsdaten zum Exportieren', 'error');
        return;
    }

    const { billing, sepaUsers, nonSepaUsers } = currentBillingData;
    const allUsers = [...sepaUsers, ...nonSepaUsers];

    if (allUsers.length === 0) {
        alert('Keine Daten zum Exportieren');
        return;
    }

    const csv = [
        ['Abrechnung', 'Mitglied', 'Vorname', 'Nachname', 'E-Mail', 'IBAN', 'Betrag', 'SEPA', 'Abgerechnet am'].join(';'),
        ...allUsers.map(u => {
            const amount = u.billing_amount || Math.abs(u.balance) || 0;
            const isSEPA = u.sepa_active && u.iban ? 'Ja' : 'Nein';
            
            return [
                billing.billing_number,
                `${u.first_name} ${u.last_name}`,
                u.first_name,
                u.last_name,
                u.email || '-',
                u.iban || '-',
                amount.toFixed(2),
                isSEPA,
                new Date(billing.created_at).toLocaleDateString('de-DE')
            ].join(';');
        })
    ].join('\n');
    
    downloadFile(csv, `abrechnung_details_${billing.billing_number}.csv`, 'text/csv');
    showAlert('CSV-Export erfolgreich', 'success');
}

async function exportUserTransactionsCSV(userId, firstName, lastName) {
    try {
        const allTransactions = await apiCall('/api/transactions');
        const userTransactions = allTransactions.filter(t => t.user_id === userId);
        
        if (userTransactions.length === 0) {
            showAlert('Keine Transaktionen zum Exportieren', 'info');
            return;
        }
        
        const csv = [
            ['Datum', 'Uhrzeit', 'Produkt', 'Menge', 'Preis', 'Gesamt', 'Abgerechnet', 'Rechnungsnummer'].join(';'),
            ...userTransactions.map(t => {
                const date = new Date(t.created_at);
                const billing = billings.find(b => b.id === t.billing_id);
                
                return [
                    date.toLocaleDateString('de-DE'),
                    date.toLocaleTimeString('de-DE'),
                    t.product_name,
                    t.quantity,
                    t.price.toFixed(2),
                    t.total.toFixed(2),
                    t.billing_id ? 'Ja' : 'Nein',
                    billing ? billing.billing_number : '-'
                ].join(';');
            })
        ].join('\n');
        
        downloadFile(csv, `transaktionen_${firstName}_${lastName}.csv`, 'text/csv');
        showAlert('CSV-Export erfolgreich', 'success');
        
    } catch (error) {
        console.error('Export-Fehler:', error);
        showAlert('Fehler beim Exportieren', 'error');
    }
}

        function exportSinglePeriodCSV(transactions, firstName, lastName, periodLabel) {
    if (!transactions || transactions.length === 0) {
        showAlert('Keine Transaktionen zum Exportieren', 'info');
        return;
    }
    
    const total = transactions.reduce((sum, t) => sum + t.total, 0);
    
    const csv = [
        ['Mitglied', 'Periode', 'Datum', 'Uhrzeit', 'Produkt', 'Menge', 'Preis', 'Gesamt'].join(';'),
        ...transactions.map(t => {
            const date = new Date(t.created_at);
            
            return [
                `${firstName} ${lastName}`,
                periodLabel,
                date.toLocaleDateString('de-DE'),
                date.toLocaleTimeString('de-DE'),
                t.product_name,
                t.quantity,
                t.price.toFixed(2),
                t.total.toFixed(2)
            ].join(';');
        }),
        // Summenzeile
        ['', '', '', '', '', '', 'GESAMT:', total.toFixed(2)].join(';')
    ].join('\n');
    
    const fileName = `${firstName}_${lastName}_${periodLabel}.csv`.replace(/[^a-zA-Z0-9_-]/g, '_');
    downloadFile(csv, fileName, 'text/csv');
    showAlert(`CSV f√ºr ${periodLabel} exportiert`, 'success');
}

// ============ STOCK MOVEMENT FUNCTIONS ============

        async function loadStockMovements() {
            try {
                allStockMovements = await apiCall('/api/stock-movements');
                stockMovements = allStockMovements;
                renderStockMovements();
                showAlert(`${stockMovements.length} Bestandsbewegungen geladen`, 'success');
            } catch (error) {
                console.error('Fehler beim Laden der Bestandsbewegungen:', error);
                showAlert('Fehler beim Laden der Bestandsbewegungen', 'error');
            }
        }

        function renderStockMovements() {
            const tbody = document.querySelector('#stockMovementTable tbody');
            
            if (stockMovements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 30px; color: #666;">Keine Bestandsbewegungen gefunden</td></tr>';
                return;
            }
            
            tbody.innerHTML = stockMovements.map(m => {
                const date = new Date(m.created_at);
                const formattedDate = date.toLocaleDateString('de-DE');
                const formattedTime = date.toLocaleTimeString('de-DE');
                
                let typeIcon, typeColor, typeText;
                switch(m.movement_type) {
                    case 'initial':
                        typeIcon = 'üéØ';
                        typeColor = '#9f7aea';
                        typeText = 'Startbestand';
                        break;
                    case 'purchase':
                        typeIcon = 'üì•';
                        typeColor = '#38a169';
                        typeText = 'Beschaffung';
                        break;
                    case 'sale':
                        typeIcon = 'üõí';
                        typeColor = '#3182ce';
                        typeText = 'Verkauf';
                        break;
                    case 'correction':
                        typeIcon = 'üîß';
                        typeColor = '#ed8936';
                        typeText = 'Korrektur';
                        break;
                    default:
                        typeIcon = '‚ùì';
                        typeColor = '#666';
                        typeText = m.movement_type;
                }
                
                const quantityColor = m.quantity >= 0 ? '#38a169' : '#e53e3e';
                const quantitySign = m.quantity >= 0 ? '+' : '';
                
                const deleteBtn = m.movement_type !== 'sale' ? 
                    `<button class="btn btn-danger" onclick="deleteStockMovement(${m.id}, '${m.product_name}')" style="padding: 5px 10px; font-size: 0.8em;">üóëÔ∏è</button>` : 
                    '<span style="color: #666; font-size: 0.85em;">Automatisch</span>';
                
                return `
                    <tr>
                        <td>${formattedDate}<br><small>${formattedTime}</small></td>
                        <td><strong>${m.product_name}</strong></td>
                        <td style="color: ${typeColor};">${typeIcon} ${typeText}</td>
                        <td style="color: ${quantityColor}; font-weight: bold;">${quantitySign}${m.quantity}</td>
                        <td>${m.stock_before}</td>
                        <td><strong>${m.stock_after}</strong></td>
                        <td style="font-size: 0.9em;">${m.reason || '-'}</td>
                        <td style="font-size: 0.9em;">${m.reference || '-'}</td>
                        <td style="font-size: 0.9em;">${m.created_by || '-'}</td>
                        <td>${deleteBtn}</td>
                    </tr>
                `;
            }).join('');
        }

        function filterStockMovements() {
            const filter = document.getElementById('stockFilter').value;
            
            if (filter === 'all') {
                stockMovements = allStockMovements;
            } else {
                stockMovements = allStockMovements.filter(m => m.movement_type === filter);
            }
            
            renderStockMovements();
        }

        function openStockMovementModal(type) {
            const modal = document.getElementById('stockMovementModal');
            const title = document.getElementById('stockMovementModalTitle');
            const form = document.getElementById('stockMovementForm');
            const quantityLabel = document.getElementById('quantityLabel');
            const quantityHelp = document.getElementById('quantityHelp');
            const costFields = document.getElementById('costFields');
            
            form.reset();
            document.getElementById('movementType').value = type;
            
            const productSelect = document.getElementById('movementProductId');
            productSelect.innerHTML = '<option value="">-- Produkt w√§hlen --</option>' + 
                products.map(p => `<option value="${p.id}">${p.name} (Bestand: ${p.stock})</option>`).join('');
            
            if (type === 'purchase') {
                title.textContent = 'üì• Beschaffung / Nachbestellung';
                quantityLabel.textContent = 'Menge (Zugang) *';
                quantityHelp.textContent = 'Anzahl der eingekauften/gelieferten Einheiten';
                costFields.style.display = 'block';
            } else if (type === 'correction') {
                title.textContent = 'üîß Bestandskorrektur';
                quantityLabel.textContent = 'Mengendifferenz *';
                quantityHelp.textContent = 'Positiv f√ºr Zugang, negativ f√ºr Abgang (z.B. +5 oder -3)';
                costFields.style.display = 'none';
            }
            
            document.getElementById('currentStockInfo').style.display = 'none';
            modal.style.display = 'block';
            
            setTimeout(() => {
                productSelect.focus();
            }, 150);
        }

        function updateStockInfo() {
            const productId = parseInt(document.getElementById('movementProductId').value);
            const stockInfo = document.getElementById('currentStockInfo');
            const stockValue = document.getElementById('currentStockValue');
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    stockValue.textContent = product.stock;
                    stockInfo.style.display = 'block';
                }
            } else {
                stockInfo.style.display = 'none';
            }
        }

        function calculateTotalCost() {
            const quantity = parseFloat(document.getElementById('movementQuantity').value) || 0;
            const costPerUnit = parseFloat(document.getElementById('movementCostPerUnit').value) || 0;
            const totalCost = quantity * costPerUnit;
            
            document.getElementById('movementTotalCost').value = totalCost.toFixed(2);
        }

        async function saveStockMovement() {
            const saveBtn = document.getElementById('saveMovementBtn');
            const productId = parseInt(document.getElementById('movementProductId').value);
            const movementType = document.getElementById('movementType').value;
            let quantity = parseInt(document.getElementById('movementQuantity').value);
            const reason = document.getElementById('movementReason').value.trim();
            const reference = document.getElementById('movementReference').value.trim();
            const costPerUnit = parseFloat(document.getElementById('movementCostPerUnit').value) || null;
            const totalCost = parseFloat(document.getElementById('movementTotalCost').value) || null;
            
            if (!productId || !quantity) {
                showAlert('Bitte Produkt und Menge eingeben', 'error');
                return;
            }

            if (movementType === 'purchase') {
                quantity = Math.abs(quantity);
            }
            
            const movementData = {
                product_id: productId,
                movement_type: movementType,
                quantity: quantity,
                reason: reason || null,
                reference: reference || null,
                cost_per_unit: costPerUnit,
                total_cost: totalCost,
                created_by: 'admin'
            };
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Speichere...';
                
                const result = await apiCall('/api/stock-movements', {
                    method: 'POST',
                    body: JSON.stringify(movementData)
                });
                
                showAlert(`‚úÖ Bestandsbewegung gespeichert! Neuer Bestand: ${result.newStock}`, 'success');
                closeModal('stockMovementModal');
                
                await loadStockMovements();
                await loadProducts();
                await loadDashboard();
                
            } catch (error) {
                showAlert('Fehler beim Speichern der Bestandsbewegung: ' + error.message, 'error');
                console.error('Save stock movement error:', error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Speichern';
            }
        }

        async function deleteStockMovement(movementId, productName) {
            if (!confirm(`M√∂chtest du diese Bestandsbewegung wirklich l√∂schen?\n\nProdukt: ${productName}\n\nDer Bestand wird automatisch zur√ºckgerechnet.`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                await apiCall(`/api/stock-movements/${movementId}`, {
                    method: 'DELETE'
                });
                
                showAlert('‚úÖ Bestandsbewegung gel√∂scht und Bestand korrigiert', 'success');
                
                await loadStockMovements();
                await loadProducts();
                await loadDashboard();
                
            } catch (error) {
                showAlert('Fehler beim L√∂schen: ' + error.message, 'error');
                console.error('Delete stock movement error:', error);
            } finally {
                showLoading(false);
            }
        }
        
        // ============ HELPER FUNCTIONS ============

// ============ BESTANDSANZEIGE-FUNKTIONEN ============

async function updateStockOverview() {
    try {
        if (!products || products.length === 0) {
            products = await apiCall('/api/products');
        }
        
        const criticalProducts = products.filter(p => p.stock > 0 && p.stock <= 10);
        const warningProducts = products.filter(p => p.stock > 10 && p.stock <= (p.min_stock || 0));
        const outOfStockProducts = products.filter(p => p.stock <= 0);
        
        document.getElementById('criticalStock').textContent = criticalProducts.length;
        document.getElementById('warningStock').textContent = warningProducts.length;
        document.getElementById('otherStock').textContent = outOfStockProducts.length;
        
        window.stockCategories = {
            critical: criticalProducts,
            warning: warningProducts,
            other: outOfStockProducts
        };
    } catch (error) {
        console.error('Fehler beim Laden der Bestands√ºbersicht:', error);
    }
}

// ============ DASHBOARD WIDGETS ============

async function loadTopProducts() {
    try {
        // Lade alle Transaktionen der letzten 30 Tage
        const allTransactions = await apiCall('/api/transactions');
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const recentTransactions = allTransactions.filter(t => 
            new Date(t.created_at) >= thirtyDaysAgo
        );
        
        // Gruppiere nach Produkt
        const productSales = {};
        recentTransactions.forEach(t => {
            if (!t.product_name || t.product_name.includes('Manuelle Buchung')) return;
            
            if (!productSales[t.product_name]) {
                productSales[t.product_name] = {
                    name: t.product_name,
                    quantity: 0,
                    revenue: 0
                };
            }
            productSales[t.product_name].quantity += t.quantity;
            productSales[t.product_name].revenue += t.total;
        });
        
        // Sortiere nach Menge
        const topProducts = Object.values(productSales)
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 5);
        
        const container = document.getElementById('topProductsList');
        
        if (topProducts.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Noch keine Verk√§ufe</div>';
            return;
        }
        
        container.innerHTML = topProducts.map((p, index) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #e2e8f0;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.5em; font-weight: bold; color: ${index === 0 ? '#f39c12' : index === 1 ? '#95a5a6' : index === 2 ? '#cd7f32' : '#666'};">
                        ${index + 1}
                    </span>
                    <div>
                        <div style="font-weight: 600;">${p.name}</div>
                        <div style="font-size: 0.85em; color: #666;">${p.revenue.toFixed(2)} ‚Ç¨</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: bold; color: #667eea;">${p.quantity}√ó</div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Fehler beim Laden der Top-Produkte:', error);
        document.getElementById('topProductsList').innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Fehler beim Laden</div>';
    }
}

async function loadSepaStatus() {
    try {
        if (!users || users.length === 0) {
            users = await apiCall('/api/users');
        }
        
        const members = users.filter(u => u.role === 'member');
        const sepaActive = members.filter(u => u.sepa_active && u.iban);
        const sepaInactive = members.filter(u => !u.sepa_active || !u.iban);
        
        const percentage = members.length > 0 ? Math.round((sepaActive.length / members.length) * 100) : 0;
        
        document.getElementById('sepaActiveCount').textContent = sepaActive.length;
        document.getElementById('sepaInactiveCount').textContent = sepaInactive.length;
        document.getElementById('sepaPercentage').textContent = percentage;
        document.getElementById('sepaProgressBar').style.width = percentage + '%';
        
    } catch (error) {
        console.error('Fehler beim Laden des SEPA-Status:', error);
    }
}

async function loadPendingClothingOrders() {
    try {
        const allOrders = await apiCall('/api/clothing-orders');
        
        // Nur offene Bestellungen (pending)
        const pendingOrders = allOrders.filter(o => o.status === 'pending');
        
        const container = document.getElementById('pendingClothingOrdersList');
        
        if (pendingOrders.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #27ae60;">‚úÖ Keine offenen Bestellungen</div>';
            return;
        }
        
        container.innerHTML = pendingOrders.map(order => {
            const date = new Date(order.created_at);
            const paymentIcons = {
                'sepa': 'üí≥ SEPA',
                'transfer': 'üè¶ √úberweisung',
                'paypal': 'üí∞ PayPal'
            };
            
            return `
                <div style="padding: 12px; border-bottom: 1px solid #e2e8f0; background: #fffbeb; margin-bottom: 8px; border-radius: 4px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: #2c3e50;">
                                ${order.member_name}
                            </div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
                                ${paymentIcons[order.payment_method] || order.payment_method} ‚Ä¢ 
                                ${order.items.length} Artikel ‚Ä¢ 
                                ${date.toLocaleDateString('de-DE')}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: #667eea; font-size: 1.1em;">
                                ${order.total.toFixed(2)} ‚Ç¨
                            </div>
                            <div style="font-size: 0.75em; color: #f39c12; margin-top: 4px;">
                                ‚è≥ Ausstehend
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Fehler beim Laden der Kleidungsbestellungen:', error);
        document.getElementById('pendingClothingOrdersList').innerHTML = 
            '<div style="text-align: center; padding: 20px; color: #e74c3c;">Fehler beim Laden</div>';
    }
    
}async function loadTopDebtors() {
    try {
        if (!users || users.length === 0) {
            users = await apiCall('/api/users');
        }
        
        const debtors = users
            .filter(u => u.balance < 0)
            .sort((a, b) => a.balance - b.balance)
            .slice(0, 5);     
        
        const container = document.getElementById('topDebtorsList');
        
        if (debtors.length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #27ae60;">‚úÖ Keine offenen Betr√§ge</div>';
            return;
        }
        
        container.innerHTML = debtors.map((u, index) => {
            const amount = Math.abs(u.balance);
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #e2e8f0;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3em; font-weight: bold; color: #e74c3c;">
                            ${index + 1}
                        </span>
                        <div>
                            <div style="font-weight: 600;">${u.first_name} ${u.last_name}</div>
                            <div style="font-size: 0.85em; color: #666;">
                                ${u.sepa_active ? 'üí≥ SEPA' : 'üìÑ Manuell'}
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold; color: #e74c3c; font-size: 1.1em;">
                            ${amount.toFixed(2)} ‚Ç¨
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Fehler beim Laden der Top-Schuldner:', error);
        document.getElementById('topDebtorsList').innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Fehler beim Laden</div>';
    }
}
        
function showStockDetails(category) {
    const categories = window.stockCategories || {critical: [], warning: [], other: []};
    let products = [];
    let title = '';
    let description = '';
    
    switch(category) {
        case 'critical':
            products = categories.critical;
            title = 'üö® Kritischer Bestand (1-10 St√ºck)';
            description = 'Diese Artikel haben einen kritisch niedrigen Bestand und sollten bald nachbestellt werden.';
            break;
        case 'warning':
            products = categories.warning;
            title = '‚ö†Ô∏è Warnungen (‚â§ Mindestbestand)';
            description = 'Diese Artikel haben den Mindestbestand erreicht oder unterschritten.';
            break;
        case 'other':
            products = categories.other;
            title = '‚õî Nicht verf√ºgbar (‚â§ 0)';
            description = 'Diese Artikel sind derzeit nicht verf√ºgbar.';
            break;
    }
    
    if (products.length === 0) {
        showAlert('Keine Artikel in dieser Kategorie', 'info');
        return;
    }
    
    const modal = document.getElementById('billingDetailsModal');
    const modalTitle = document.getElementById('billingDetailsTitle');
    const modalContent = document.getElementById('billingDetailsContent');
    
    modalTitle.textContent = title;
    
    let html = `
        <div style="margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
            <p style="margin: 0;">${description}</p>
        </div>
        
        <table class="data-table" style="width: 100%;">
            <thead>
                <tr>
                    <th>Produkt</th>
                    <th>Kategorie</th>
                    <th style="text-align: center;">Bestand</th>
                    <th style="text-align: center;">Mindestbestand</th>
                    <th style="text-align: center;">Aktion</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    products.forEach(product => {
        const stockColor = product.stock <= 0 ? '#e74c3c' : 
                          product.stock <= 10 ? '#f39c12' : '#27ae60';
        
        const categoryNames = {
            'getraenke': 'ü•§ Getr√§nke',
            'snacks': 'üç´ Snacks',
            'sonstiges': 'üì¶ Sonstiges'
        };
        
        html += `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        ${product.image || 'üì¶'}
                        <span>${product.name}</span>
                    </div>
                </td>
                <td>${categoryNames[product.category] || product.category}</td>
                <td style="text-align: center;">
                    <span style="color: ${stockColor}; font-weight: bold; font-size: 1.1em;">
                        ${product.stock || 0}
                    </span>
                </td>
                <td style="text-align: center;">${product.min_stock || 5}</td>
                <td style="text-align: center;">
                    <button onclick="quickPurchase(${product.id})" class="btn btn-success" style="padding: 5px 15px; font-size: 0.9em;">
                        üì• Nachbestellen
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
        
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="closeModal('billingDetailsModal')" class="btn btn-secondary">
                Schlie√üen
            </button>
        </div>
    `;
    
    modalContent.innerHTML = html;
    modal.style.display = 'flex';
}

function quickPurchase(productId) {
    closeModal('billingDetailsModal');
    openStockMovementModal('purchase');
    
    setTimeout(() => {
        const productSelect = document.getElementById('movementProductId');
        if (productSelect) {
            productSelect.value = productId;
        }
    }, 100);
}
        
        function getRoleIcon(role) {
            const icons = { member: 'üë•', guest: 'üë§', bartender: 'üç∫', admin: '‚öôÔ∏è' };
            return icons[role] || 'üë§';
        }

        function getRoleText(role) {
            const texts = { member: 'Mitglied', guest: 'Gast', bartender: 'Barkeeper', admin: 'Administrator' };
            return texts[role] || role;
        }

        function getCategoryText(category) {
            const categories = {
                bier: 'üç∫',
                softdrinks: 'ü•§',
                schnaps: 'ü•É',
                snacks: 'üçø',
                heissgetraenke: '‚òï',
                sonstiges: 'üì¶'
            };
            return categories[category] || category;
        }

        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
                
                currentImageFile = null;
                uploadedImageUrl = null;
                
                console.log('‚úÖ Modal closed successfully');
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ============ DRAG & DROP ============
        
        function initDragAndDrop() {
            const photoUpload = document.getElementById('photoUpload');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                photoUpload.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                photoUpload.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                photoUpload.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                photoUpload.classList.add('dragover');
            }

            function unhighlight(e) {
                photoUpload.classList.remove('dragover');
            }

            photoUpload.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    document.getElementById('photoInput').files = files;
                    handlePhotoUpload({ target: { files: files } });
                }
            }
        }

// ============ IBAN VALIDATION ============

function validateIBAN(iban) {
    // Entferne Leerzeichen und mache Gro√übuchstaben
    iban = iban.replace(/\s/g, '').toUpperCase();
    
    // Pr√ºfe Format (nur Buchstaben und Zahlen)
    if (!/^[A-Z]{2}[0-9]{2}[A-Z0-9]+$/.test(iban)) {
        return false;
    }
    
    // L√§ngenpr√ºfung nach Land
    const ibanLengths = {
        AD: 24, AE: 23, AL: 28, AT: 20, AZ: 28, BA: 20, BE: 16, BG: 22,
        BH: 22, BR: 29, BY: 28, CH: 21, CR: 22, CY: 28, CZ: 24, DE: 22,
        DK: 18, DO: 28, EE: 20, EG: 29, ES: 24, FI: 18, FO: 18, FR: 27,
        GB: 22, GE: 22, GI: 23, GL: 18, GR: 27, GT: 28, HR: 21, HU: 28,
        IE: 22, IL: 23, IS: 26, IT: 27, JO: 30, KW: 30, KZ: 20, LB: 28,
        LC: 32, LI: 21, LT: 20, LU: 20, LV: 21, MC: 27, MD: 24, ME: 22,
        MK: 19, MR: 27, MT: 31, MU: 30, NL: 18, NO: 15, PK: 24, PL: 28,
        PS: 29, PT: 25, QA: 29, RO: 24, RS: 22, SA: 24, SE: 24, SI: 19,
        SK: 24, SM: 27, TN: 24, TR: 26, UA: 29, VA: 22, VG: 24, XK: 20
    };
    
    const countryCode = iban.substring(0, 2);
    const expectedLength = ibanLengths[countryCode];
    
    if (!expectedLength || iban.length !== expectedLength) {
        return false;
    }
    
    // MOD-97-Pr√ºfung
    // Verschiebe die ersten 4 Zeichen ans Ende
    const rearranged = iban.substring(4) + iban.substring(0, 4);
    
    // Ersetze Buchstaben durch Zahlen (A=10, B=11, ..., Z=35)
    let numericString = '';
    for (let i = 0; i < rearranged.length; i++) {
        const char = rearranged[i];
        if (char >= '0' && char <= '9') {
            numericString += char;
        } else {
            numericString += (char.charCodeAt(0) - 55).toString();
        }
    }
    
    // Berechne MOD 97
    let remainder = numericString;
    while (remainder.length > 2) {
        const block = remainder.substring(0, 9);
        remainder = (parseInt(block, 10) % 97).toString() + remainder.substring(block.length);
    }
    
    return parseInt(remainder, 10) % 97 === 1;
}

function formatIBAN(iban) {
    // Formatiere IBAN mit Leerzeichen alle 4 Zeichen
    iban = iban.replace(/\s/g, '').toUpperCase();
    return iban.replace(/(.{4})/g, '$1 ').trim();
}
        
        // ============ INITIALIZATION ============
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Admin-Dashboard mit Bildupload startet...');
            
            try {
                await loadDashboard();
                await loadProducts();

                loadedTabs.products = true;
                initDragAndDrop();
                loadAllSettings();
                loadOpenBalances(); // Lade offene Betr√§ge f√ºr Abrechnungs-Tab
                loadBillingHistory(); // Lade Abrechnungshistorie
                
                const sepaCheckbox = document.getElementById('userSepaActive');
                if (sepaCheckbox) {
                    sepaCheckbox.addEventListener('change', toggleIbanField);
                }

// IBAN Live-Validierung
const ibanInput = document.getElementById('userIban');
if (ibanInput) {
    ibanInput.addEventListener('blur', function() {
        const iban = this.value.trim();
        if (iban && !validateIBAN(iban)) {
            this.style.borderColor = '#e53e3e';
            this.style.backgroundColor = '#fff5f5';
        } else {
            this.style.borderColor = '';
            this.style.backgroundColor = '';
        }
    });
    
    ibanInput.addEventListener('input', function() {
        // Entferne Warnung beim Tippen
        this.style.borderColor = '';
        this.style.backgroundColor = '';
    });
}
                
                console.log('‚úÖ Admin-Dashboard erfolgreich initialisiert');
                showAlert('Dashboard mit Abrechnungs-System geladen', 'success');
                
            } catch (error) {
                console.error('‚ùå Fehler bei der Initialisierung:', error);
                showAlert('Fehler beim Laden des Dashboards. Pr√ºfe die API-Verbindung.', 'error');
            }
        });

// Logout-Funktion
function logoutAdmin() {
    if (confirm('M√∂chtest du dich wirklich abmelden?')) {
        localStorage.removeItem('adminLogin');
        window.location.href = '/login-admin.html';
    }
}
        
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // ============ PRODUCT STOCK HISTORY FUNCTIONS ============

        async function viewProductStockHistory() {
            const productId = parseInt(document.getElementById('productId').value);
            
            if (!productId) {
                showAlert('Produkt-ID nicht gefunden', 'error');
                return;
            }

            try {
                showLoading(true);
                
                const movements = await apiCall(`/api/stock-movements/product/${productId}`);
                const product = products.find(p => p.id === productId);
                
                if (!product) {
                    showAlert('Produkt nicht gefunden', 'error');
                    return;
                }

                closeModal('productModal');
                showProductStockHistoryModal(product, movements);
                
            } catch (error) {
                console.error('Fehler beim Laden der Bestandshistorie:', error);
                showAlert('Fehler beim Laden der Bestandshistorie', 'error');
            } finally {
                showLoading(false);
            }
        }

        function showProductStockHistoryModal(product, movements) {
            const modal = document.getElementById('billingDetailsModal');
            const title = document.getElementById('billingDetailsTitle');
            const content = document.getElementById('billingDetailsContent');
            
            title.textContent = `üìä Bestandshistorie: ${product.name}`;
            
            let html = `
                <div style="margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px;">
                    <p><strong>Produkt:</strong> ${product.name}</p>
                    <p><strong>Aktueller Bestand:</strong> <span style="color: ${product.stock > 0 ? '#38a169' : '#e53e3e'}; font-weight: bold;">${product.stock} Einheiten</span></p>
                    <p><strong>Mindestbestand:</strong> ${product.min_stock} Einheiten</p>
                    <p><strong>Kategorie:</strong> ${getCategoryText(product.category)}</p>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #e2e8f0;">
                
                <h3 style="margin-bottom: 15px; color: #667eea;">üìú Bewegungshistorie (${movements.length})</h3>
            `;
            
            if (movements.length === 0) {
                html += '<p style="text-align: center; color: #666; padding: 30px;">Noch keine Bestandsbewegungen aufgezeichnet</p>';
            } else {
                html += `
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table" style="font-size: 0.85em;">
                            <thead>
                                <tr>
                                    <th>Datum/Zeit</th>
                                    <th>Typ</th>
                                    <th>Menge</th>
                                    <th>Vorher</th>
                                    <th>Nachher</th>
                                    <th>Grund</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${movements.map(m => {
                                    const date = new Date(m.created_at);
                                    let typeIcon, typeColor, typeText;
                                    
                                    switch(m.movement_type) {
                                        case 'initial':
                                            typeIcon = 'üéØ';
                                            typeColor = '#9f7aea';
                                            typeText = 'Start';
                                            break;
                                        case 'purchase':
                                            typeIcon = 'üì•';
                                            typeColor = '#38a169';
                                            typeText = 'Beschaffung';
                                            break;
                                        case 'sale':
                                            typeIcon = 'üõí';
                                            typeColor = '#3182ce';
                                            typeText = 'Verkauf';
                                            break;
                                        case 'correction':
                                            typeIcon = 'üîß';
                                            typeColor = '#ed8936';
                                            typeText = 'Korrektur';
                                            break;
                                        default:
                                            typeIcon = '‚ùì';
                                            typeColor = '#666';
                                            typeText = m.movement_type;
                                    }
                                    
                                    const quantityColor = m.quantity >= 0 ? '#38a169' : '#e53e3e';
                                    const quantitySign = m.quantity >= 0 ? '+' : '';
                                    
                                    return `
                                        <tr>
                                            <td>${date.toLocaleDateString('de-DE')}<br><small>${date.toLocaleTimeString('de-DE')}</small></td>
                                            <td style="color: ${typeColor};">${typeIcon} ${typeText}</td>
                                            <td style="color: ${quantityColor}; font-weight: bold;">${quantitySign}${m.quantity}</td>
                                            <td>${m.stock_before}</td>
                                            <td><strong>${m.stock_after}</strong></td>
                                            <td style="font-size: 0.9em;">${m.reason || '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            content.innerHTML = html;
            modal.style.display = 'block';
        }
        
async function resetUserPin() {
    const userId = document.getElementById('userId').value;
    if (!userId) return;
    
    const user = users.find(u => u.id === parseInt(userId));
    if (!user) return;
    
    if (!confirm(`M√∂chtest du die PIN f√ºr ${user.first_name} ${user.last_name} wirklich zur√ºcksetzen?\n\nDer Benutzer muss danach eine neue PIN vergeben.`)) {
        return;
    }
    
    try {
        const resetBtn = document.getElementById('resetPinBtn');
        resetBtn.disabled = true;
        resetBtn.textContent = '‚è≥ Setze zur√ºck...';
        
        await apiCall(`/api/users/${userId}`, {
            method: 'PUT',
            body: JSON.stringify({
                ...user,
                user_pin: null,
                pin_require_for_name_search: false,
                pin_require_for_barcode: false
            })
        });
        
        // Update lokale Daten
        user.user_pin = null;
        user.pin_require_for_name_search = false;
        user.pin_require_for_barcode = false;
        
        const userIndex = users.findIndex(u => u.id === parseInt(userId));
        if (userIndex !== -1) {
            users[userIndex] = { ...users[userIndex], ...user };
        }
        
        showAlert('PIN erfolgreich zur√ºckgesetzt', 'success');
        
        // UI aktualisieren
        document.getElementById('pinStatusText').innerHTML = '‚ùå Keine PIN gesetzt';
        
    } catch (error) {
        showAlert('Fehler beim Zur√ºcksetzen der PIN', 'error');
        console.error('PIN reset error:', error);
    } finally {
        const resetBtn = document.getElementById('resetPinBtn');
        resetBtn.disabled = false;
        resetBtn.textContent = 'üîì PIN zur√ºcksetzen';
    }
}
        
    </script>
</body>
</html>
