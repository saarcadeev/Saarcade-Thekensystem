<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Saarcade Admin - Vollst√§ndig</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #2d3748;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .demo-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            background: #f7fafc;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 25px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .btn-secondary { background: linear-gradient(135deg, #a0aec0, #718096); }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ddd;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .alert {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #1a202c;
            border-left: 5px solid #38a169;
        }

        .alert-error {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            color: #1a202c;
            border-left: 5px solid #e53e3e;
        }

        .alert-info {
            background: linear-gradient(135deg, #bee3f8, #90cdf4);
            color: #1a202c;
            border-left: 5px solid #3182ce;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .toolbar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .editable-cell {
            background: #f0f8ff;
            border: 1px dashed #667eea;
            padding: 5px;
            cursor: pointer;
            border-radius: 4px;
        }

        .editable-cell:hover {
            background: #e6f3ff;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-grid { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="demo-badge">VOLLST√ÑNDIGES ADMIN DASHBOARD</div>
        <h1>‚öôÔ∏è Saarcade Admin-Dashboard</h1>
        <p>Komplette Verwaltung f√ºr Kassenwart und Vereinsvorstand</p>
    </div>

    <div class="container">
        <!-- Dashboard Statistiken -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-number" id="memberCount">0</div>
                <div class="stat-label">Vereinsmitglieder</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="productCount">0</div>
                <div class="stat-label">Produkte</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalStock">0</div>
                <div class="stat-label">Gesamtbestand</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lowStockCount">0</div>
                <div class="stat-label">Niedrige Best√§nde</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('users')">üë• Mitglieder</button>
            <button class="tab" onclick="showTab('transactions')">üí∞ Transaktionen</button>
            <button class="tab" onclick="showTab('sepa')">üí≥ SEPA-Export</button>
            <button class="tab" onclick="showTab('inventory')">üì¶ Inventar</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Einstellungen</button>
        </div>

        <!-- Mitglieder Tab -->
        <div id="users" class="tab-content active">
            <div class="section">
                <h2>üë• Mitgliederverwaltung</h2>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="openAddUserModal()">
                        ‚ûï Neues Mitglied
                    </button>
                    <button class="btn btn-warning" onclick="resetAllBalances()">
                        üí∞ Alle Salden zur√ºcksetzen
                    </button>
                    <button class="btn btn-secondary" onclick="exportUsers()">
                        üìä Mitglieder exportieren
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="userTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Rolle</th>
                                <th>Barcode</th>
                                <th>Saldo</th>
                                <th>SEPA</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Wird dynamisch gef√ºllt -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transaktionen Tab -->
        <div id="transactions" class="tab-content">
            <div class="section">
                <h2>üí∞ Transaktionsverlauf</h2>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="exportTransactions()">
                        üìä Transaktionen exportieren
                    </button>
                    <button class="btn btn-secondary" onclick="loadTransactions()">
                        üîÑ Aktualisieren
                    </button>
                    <button class="btn btn-warning" onclick="clearOldTransactions()">
                        üóëÔ∏è Alte Transaktionen l√∂schen
                    </button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: 600; margin-right: 10px;">Zeitraum:</label>
                    <input type="date" id="transactionDateFrom" style="margin-right: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <span style="margin: 0 10px;">bis</span>
                    <input type="date" id="transactionDateTo" style="margin-right: 15px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <button class="btn btn-secondary" onclick="filterTransactions()" style="padding: 8px 15px;">
                        üîç Filtern
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="transactionTable">
                        <thead>
                            <tr>
                                <th>Datum/Zeit</th>
                                <th>Benutzer</th>
                                <th>Artikel</th>
                                <th>Menge</th>
                                <th>Einzelpreis</th>
                                <th>Gesamtbetrag</th>
                                <th>Zahlart</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Wird dynamisch gef√ºllt -->
                        </tbody>
                    </table>
                </div>
                
                <div id="transactionSummary" style="margin-top: 20px; padding: 20px; background: #f7fafc; border-radius: 10px;">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>
        </div>

        <!-- SEPA Tab -->
        <div id="sepa" class="tab-content">
            <div class="section">
                <h2>üí≥ SEPA-Lastschriften</h2>
                
                <div class="alert alert-info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        <strong>SEPA-Export bereit:</strong> Alle Mitglieder mit negativem Saldo und aktivem SEPA-Mandat k√∂nnen abgebucht werden.
                    </div>
                </div>
                
                <div class="dashboard-grid" style="margin-bottom: 30px;">
                    <div class="stat-card">
                        <div class="stat-number" id="sepaUserCount">0</div>
                        <div class="stat-label">Benutzer mit SEPA</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="sepaAmount">0.00‚Ç¨</div>
                        <div class="stat-label">Gesamtbetrag</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="sepaDueDate">-</div>
                        <div class="stat-label">F√§lligkeitsdatum</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="sepaFileCount">0</div>
                        <div class="stat-label">Heute erstellt</div>
                    </div>
                </div>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="downloadSepaFile()" id="sepaDownloadBtn">
                        üíæ SEPA-XML herunterladen
                    </button>
                    <button class="btn btn-warning" onclick="previewSepaFile()">
                        üëÅÔ∏è Vorschau anzeigen
                    </button>
                    <button class="btn btn-secondary" onclick="updateSepaDueDate()">
                        üìÖ F√§lligkeitsdatum √§ndern
                    </button>
                </div>
                
                <div style="overflow-x: auto; margin-top: 20px;">
                    <table class="data-table" id="sepaTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>IBAN</th>
                                <th>Betrag</th>
                                <th>Mandat-ID</th>
                                <th>Status</th>
                                <th>Letzte Abbuchung</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Wird dynamisch gef√ºllt -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Inventar Tab -->
        <div id="inventory" class="tab-content">
            <div class="section">
                <h2>üì¶ Inventar-Management</h2>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="openAddProductModal()">
                        ‚ûï Neues Produkt
                    </button>
                    <button class="btn btn-warning" onclick="showLowStock()">
                        ‚ö†Ô∏è Niedrige Best√§nde
                    </button>
                    <button class="btn btn-secondary" onclick="exportInventory()">
                        üìä Inventar exportieren
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>Kategorie</th>
                                <th>Bestand</th>
                                <th>Mindestbestand</th>
                                <th>Mitgliedspreis</th>
                                <th>Gastpreis</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Wird dynamisch gef√ºllt -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Einstellungen Tab -->
        <div id="settings" class="tab-content">
            <div class="section">
                <h2>‚öôÔ∏è System-Einstellungen</h2>
                
                <div class="alert alert-info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        <strong>Demo-Modus:</strong> Alle √Ñnderungen werden lokal gespeichert und gehen beim Neuladen verloren. 
                        In der Produktivversion werden alle Daten persistent in der Datenbank gespeichert.
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn btn-success" onclick="createBackup()">
                        üíæ Backup erstellen
                    </button>
                    <button class="btn btn-warning" onclick="loadDemoData()">
                        üìù Demo-Daten laden
                    </button>
                    <button class="btn btn-danger" onclick="clearAllData()">
                        üóëÔ∏è Alle Daten l√∂schen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Benutzer Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Mitglied bearbeiten</h3>
                <span class="close" onclick="closeModal('userModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="saveUser(event)">
                    <input type="hidden" id="userId" value="">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Vorname *</label>
                            <input type="text" id="userFirstName" required>
                        </div>
                        <div class="form-group">
                            <label>Nachname *</label>
                            <input type="text" id="userLastName" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Rolle</label>
                            <select id="userRole">
                                <option value="member">Mitglied</option>
                                <option value="guest">Gast</option>
                                <option value="bartender">Barkeeper</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Barcode *</label>
                            <input type="text" id="userBarcode" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Aktueller Saldo (‚Ç¨)</label>
                            <input type="number" id="userBalance" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>SEPA-Mandat</label>
                            <select id="userSepa">
                                <option value="false">Inaktiv</option>
                                <option value="true">Aktiv</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>E-Mail (optional)</label>
                        <input type="email" id="userEmail">
                    </div>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-success">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Produkt Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Produkt bearbeiten</h3>
                <span class="close" onclick="closeModal('productModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="productForm" onsubmit="saveProduct(event)">
                    <input type="hidden" id="productId" value="">
                    
                    <div class="form-group">
                        <label>Produktname *</label>
                        <input type="text" id="productName" required>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Kategorie</label>
                            <select id="productCategory">
                                <option value="bier">üç∫ Bier</option>
                                <option value="softdrinks">ü•§ Softdrinks</option>
                                <option value="schnaps">ü•É Spirituosen</option>
                                <option value="snacks">üçø Snacks</option>
                                <option value="heissgetraenke">‚òï Hei√ügetr√§nke</option>
                                <option value="sonstiges">üì¶ Sonstiges</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Emoji/Icon</label>
                            <input type="text" id="productEmoji" placeholder="üç∫" maxlength="2">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mitgliedspreis (‚Ç¨) *</label>
                            <input type="number" id="productMemberPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Gastpreis (‚Ç¨) *</label>
                            <input type="number" id="productGuestPrice" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Aktueller Bestand</label>
                            <input type="number" id="productStock" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label>Mindestbestand</label>
                            <input type="number" id="productMinStock" min="0" value="5">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Barcode (optional)</label>
                        <input type="text" id="productBarcode">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productAvailable" checked>
                            Verf√ºgbar
                        </label>
                    </div>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('productModal')">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-success">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bestand bearbeiten Modal -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì¶ Bestand bearbeiten</h3>
                <span class="close" onclick="closeModal('stockModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="stockForm" onsubmit="updateStock(event)">
                    <input type="hidden" id="stockProductId" value="">
                    
                    <div class="form-group">
                        <label>Produkt</label>
                        <input type="text" id="stockProductName" readonly style="background: #f7fafc;">
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Aktueller Bestand</label>
                            <input type="number" id="stockCurrent" readonly style="background: #f7fafc;">
                        </div>
                        <div class="form-group">
                            <label>Neuer Bestand</label>
                            <input type="number" id="stockNew" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Grund f√ºr √Ñnderung</label>
                        <select id="stockReason">
                            <option value="nachkauf">üì¶ Nachkauf/Lieferung</option>
                            <option value="inventur">üìã Inventur-Korrektur</option>
                            <option value="verlust">‚ùå Verlust/Verderb</option>
                            <option value="rueckgabe">‚Ü©Ô∏è R√ºckgabe</option>
                            <option value="sonstiges">‚ÑπÔ∏è Sonstiges</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Notiz (optional)</label>
                        <textarea id="stockNote" rows="3" placeholder="Zus√§tzliche Informationen..."></textarea>
                    </div>
                    
                    <div style="text-align: right; margin-top: 30px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('stockModal')">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-success">
                            üì¶ Bestand aktualisieren
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============ DATENSTRUKTUREN ============
        let users = [
            { id: 1, firstName: 'Max', lastName: 'Mustermann', role: 'member', barcode: 'SAAR001', balance: -15.50, sepa: true, email: 'max@example.com', iban: 'DE89 3704 0044 0532 0130 00', mandateId: 'SEPA-001', lastDebit: '2024-08-15' },
            { id: 2, firstName: 'Anna', lastName: 'Schmidt', role: 'member', barcode: 'SAAR002', balance: -8.20, sepa: true, email: 'anna@example.com', iban: 'DE12 3004 0033 0200 0001 23', mandateId: 'SEPA-002', lastDebit: '2024-08-15' },
            { id: 3, firstName: 'Tom', lastName: 'Wagner', role: 'bartender', barcode: 'SAAR003', balance: 2.40, sepa: false, email: 'tom@example.com', iban: '', mandateId: '', lastDebit: '' },
            { id: 4, firstName: 'Sarah', lastName: 'Klein', role: 'member', barcode: 'SAAR004', balance: -12.30, sepa: true, email: 'sarah@example.com', iban: 'DE45 5007 0010 0987 6543 21', mandateId: 'SEPA-004', lastDebit: '2024-08-15' },
            { id: 5, firstName: 'Gast', lastName: 'Benutzer', role: 'guest', barcode: 'GUEST001', balance: 0.00, sepa: false, email: '', iban: '', mandateId: '', lastDebit: '' }
        ];

        let products = [
            { id: 1, name: 'Augustiner Helles', category: 'bier', emoji: 'üç∫', memberPrice: 2.50, guestPrice: 3.00, stock: 24, minStock: 10, available: true, barcode: '4000417025001' },
            { id: 2, name: 'Erdinger Weissbier', category: 'bier', emoji: 'üç∫', memberPrice: 2.80, guestPrice: 3.30, stock: 6, minStock: 8, available: true, barcode: '4002103001011' },
            { id: 3, name: 'Coca Cola', category: 'softdrinks', emoji: 'ü•§', memberPrice: 1.50, guestPrice: 2.00, stock: 36, minStock: 15, available: true, barcode: '5000112637447' },
            { id: 4, name: 'Sprite', category: 'softdrinks', emoji: 'ü•§', memberPrice: 1.50, guestPrice: 2.00, stock: 28, minStock: 15, available: true, barcode: '5000112637448' },
            { id: 5, name: 'J√§germeister', category: 'schnaps', emoji: 'ü•É', memberPrice: 3.50, guestPrice: 4.50, stock: 3, minStock: 5, available: true, barcode: '4000417025200' },
            { id: 6, name: 'Erdn√ºsse', category: 'snacks', emoji: 'ü•ú', memberPrice: 2.00, guestPrice: 2.50, stock: 15, minStock: 10, available: true, barcode: '4008400123456' },
            { id: 7, name: 'Kaffee', category: 'heissgetraenke', emoji: '‚òï', memberPrice: 1.00, guestPrice: 1.50, stock: 1, minStock: 20, available: true, barcode: '4008400123457' }
        ];

        // Mock-Transaktionsdaten
        let transactions = [
            { id: 1, date: '2024-09-20 14:30', userId: 1, userName: 'Max Mustermann', productId: 1, productName: 'Augustiner Helles', quantity: 2, price: 2.50, total: 5.00, paymentType: 'account' },
            { id: 2, date: '2024-09-20 14:15', userId: 2, userName: 'Anna Schmidt', productId: 3, productName: 'Coca Cola', quantity: 1, price: 1.50, total: 1.50, paymentType: 'account' },
            { id: 3, date: '2024-09-20 14:15', userId: 2, userName: 'Anna Schmidt', productId: 2, productName: 'Erdinger Weissbier', quantity: 1, price: 2.80, total: 2.80, paymentType: 'account' },
            { id: 4, date: '2024-09-20 13:45', userId: 4, userName: 'Sarah Klein', productId: 5, productName: 'J√§germeister', quantity: 1, price: 3.50, total: 3.50, paymentType: 'account' },
            { id: 5, date: '2024-09-20 13:45', userId: 4, userName: 'Sarah Klein', productId: 6, productName: 'Erdn√ºsse', quantity: 2, price: 2.00, total: 4.00, paymentType: 'account' },
            { id: 6, date: '2024-09-20 13:20', userId: 3, userName: 'Tom Wagner', productId: 4, productName: 'Sprite', quantity: 2, price: 1.50, total: 3.00, paymentType: 'account' },
            { id: 7, date: '2024-09-19 19:30', userId: 1, userName: 'Max Mustermann', productId: 1, productName: 'Augustiner Helles', quantity: 3, price: 2.50, total: 7.50, paymentType: 'account' },
            { id: 8, date: '2024-09-19 18:45', userId: 2, userName: 'Anna Schmidt', productId: 3, productName: 'Coca Cola', quantity: 2, price: 1.50, total: 3.00, paymentType: 'account' },
            { id: 9, date: '2024-09-19 17:15', userId: 4, userName: 'Sarah Klein', productId: 2, productName: 'Erdinger Weissbier', quantity: 1, price: 2.80, total: 2.80, paymentType: 'account' }
        ];

        let nextUserId = 6;
        let nextProductId = 8;
        let nextTransactionId = 10;
        let sepaDueDate = new Date();
        sepaDueDate.setDate(sepaDueDate.getDate() + 3); // 3 Tage in der Zukunft

        // ============ INITIALISIERUNG ============
        document.addEventListener('DOMContentLoaded', function() {
            updateDashboard();
            renderUsers();
            renderProducts();
            renderTransactions();
            renderSepaData();
            initializeDateFilters();
            console.log('‚úÖ Admin-Dashboard geladen');
        });

        // ============ TAB NAVIGATION ============
        function showTab(tabName) {
            // Alle Tabs deaktivieren
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Aktiven Tab setzen
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ============ DASHBOARD FUNCTIONS ============
        function updateDashboard() {
            document.getElementById('memberCount').textContent = users.length;
            document.getElementById('productCount').textContent = products.length;
            
            const totalStock = products.reduce((sum, p) => sum + p.stock, 0);
            document.getElementById('totalStock').textContent = totalStock;
            
            const lowStockCount = products.filter(p => p.stock <= p.minStock).length;
            document.getElementById('lowStockCount').textContent = lowStockCount;
        }

        // ============ BENUTZER-VERWALTUNG ============
        function renderUsers() {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                const balanceColor = user.balance >= 0 ? '#38a169' : '#e53e3e';
                const roleIcon = getRoleIcon(user.role);
                const sepaStatus = user.sepa ? '‚úÖ Aktiv' : '‚ùå Inaktiv';
                
                row.innerHTML = `
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${roleIcon} ${getRoleText(user.role)}</td>
                    <td>${user.barcode}</td>
                    <td style="color: ${balanceColor}; font-weight: bold;">${user.balance.toFixed(2)}‚Ç¨</td>
                    <td>${sepaStatus}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editUser(${user.id})" style="padding: 5px 10px; font-size: 0.8em;">
                            ‚úèÔ∏è Bearbeiten
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})" style="padding: 5px 10px; font-size: 0.8em;">
                            üóëÔ∏è L√∂schen
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Neues Mitglied hinzuf√ºgen';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userBalance').value = '0.00';
            document.getElementById('userModal').style.display = 'block';
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('userModalTitle').textContent = 'Mitglied bearbeiten';
            document.getElementById('userId').value = user.id;
            document.getElementById('userFirstName').value = user.firstName;
            document.getElementById('userLastName').value = user.lastName;
            document.getElementById('userRole').value = user.role;
            document.getElementById('userBarcode').value = user.barcode;
            document.getElementById('userBalance').value = user.balance.toFixed(2);
            document.getElementById('userSepa').value = user.sepa ? 'true' : 'false';
            document.getElementById('userEmail').value = user.email || '';
            
            document.getElementById('userModal').style.display = 'block';
        }

        function saveUser(event) {
            event.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const userData = {
                firstName: document.getElementById('userFirstName').value.trim(),
                lastName: document.getElementById('userLastName').value.trim(),
                role: document.getElementById('userRole').value,
                barcode: document.getElementById('userBarcode').value.trim(),
                balance: parseFloat(document.getElementById('userBalance').value) || 0,
                sepa: document.getElementById('userSepa').value === 'true',
                email: document.getElementById('userEmail').value.trim()
            };
            
            // Validierung
            if (!userData.firstName || !userData.lastName || !userData.barcode) {
                showAlert('Bitte alle Pflichtfelder ausf√ºllen', 'error');
                return;
            }
            
            // Barcode-Eindeutigkeit pr√ºfen
            const existingUser = users.find(u => u.barcode === userData.barcode && u.id !== parseInt(userId));
            if (existingUser) {
                showAlert('Dieser Barcode ist bereits vergeben', 'error');
                return;
            }
            
            if (userId) {
                // Benutzer bearbeiten
                const userIndex = users.findIndex(u => u.id === parseInt(userId));
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...userData };
                    showAlert('Mitglied erfolgreich aktualisiert', 'success');
                }
            } else {
                // Neuen Benutzer hinzuf√ºgen
                const newUser = { id: nextUserId++, ...userData };
                users.push(newUser);
                showAlert('Neues Mitglied erfolgreich hinzugef√ºgt', 'success');
            }
            
            renderUsers();
            updateDashboard();
            closeModal('userModal');
        }

        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            if (confirm(`M√∂chten Sie ${user.firstName} ${user.lastName} wirklich l√∂schen?\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                users = users.filter(u => u.id !== userId);
                renderUsers();
                updateDashboard();
                showAlert('Mitglied gel√∂scht', 'success');
            }
        }

        function resetAllBalances() {
            if (confirm('M√∂chten Sie wirklich alle Mitgliedersalden auf 0,00‚Ç¨ zur√ºcksetzen?\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden!')) {
                users.forEach(user => user.balance = 0.00);
                renderUsers();
                showAlert('Alle Salden wurden zur√ºckgesetzt', 'success');
            }
        }

        // ============ PRODUKT-VERWALTUNG ============
        function renderProducts() {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';
            
            products.forEach(product => {
                const row = document.createElement('tr');
                const stockStatus = getStockStatus(product);
                const statusText = stockStatus.text;
                const statusColor = stockStatus.color;
                
                row.innerHTML = `
                    <td>${product.emoji} ${product.name}</td>
                    <td>${getCategoryText(product.category)}</td>
                    <td>
                        <span class="editable-cell" onclick="openStockModal(${product.id})" title="Klicken zum Bearbeiten">
                            ${product.stock}
                        </span>
                    </td>
                    <td>${product.minStock}</td>
                    <td>${product.memberPrice.toFixed(2)}‚Ç¨</td>
                    <td>${product.guestPrice.toFixed(2)}‚Ç¨</td>
                    <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editProduct(${product.id})" style="padding: 5px 10px; font-size: 0.8em;">
                            ‚úèÔ∏è Bearbeiten
                        </button>
                        <button class="btn btn-warning" onclick="openStockModal(${product.id})" style="padding: 5px 10px; font-size: 0.8em;">
                            üì¶ Bestand
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct(${product.id})" style="padding: 5px 10px; font-size: 0.8em;">
                            üóëÔ∏è L√∂schen
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function openAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Neues Produkt hinzuf√ºgen';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productStock').value = '0';
            document.getElementById('productMinStock').value = '5';
            document.getElementById('productAvailable').checked = true;
            document.getElementById('productModal').style.display = 'block';
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('productModalTitle').textContent = 'Produkt bearbeiten';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productEmoji').value = product.emoji || '';
            document.getElementById('productMemberPrice').value = product.memberPrice.toFixed(2);
            document.getElementById('productGuestPrice').value = product.guestPrice.toFixed(2);
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productMinStock').value = product.minStock;
            document.getElementById('productBarcode').value = product.barcode || '';
            document.getElementById('productAvailable').checked = product.available;
            
            document.getElementById('productModal').style.display = 'block';
        }

        function saveProduct(event) {
            event.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const productData = {
                name: document.getElementById('productName').value.trim(),
                category: document.getElementById('productCategory').value,
                emoji: document.getElementById('productEmoji').value.trim() || 'üì¶',
                memberPrice: parseFloat(document.getElementById('productMemberPrice').value) || 0,
                guestPrice: parseFloat(document.getElementById('productGuestPrice').value) || 0,
                stock: parseInt(document.getElementById('productStock').value) || 0,
                minStock: parseInt(document.getElementById('productMinStock').value) || 0,
                barcode: document.getElementById('productBarcode').value.trim() || '',
                available: document.getElementById('productAvailable').checked
            };
            
            // Validierung
            if (!productData.name || productData.memberPrice <= 0 || productData.guestPrice <= 0) {
                showAlert('Bitte alle Pflichtfelder korrekt ausf√ºllen', 'error');
                return;
            }
            
            if (productData.guestPrice < productData.memberPrice) {
                showAlert('Gastpreis muss mindestens so hoch wie Mitgliedspreis sein', 'error');
                return;
            }
            
            // Barcode-Eindeutigkeit pr√ºfen (falls angegeben)
            if (productData.barcode) {
                const existingProduct = products.find(p => p.barcode === productData.barcode && p.id !== parseInt(productId));
                if (existingProduct) {
                    showAlert('Dieser Barcode ist bereits vergeben', 'error');
                    return;
                }
            }
            
            if (productId) {
                // Produkt bearbeiten
                const productIndex = products.findIndex(p => p.id === parseInt(productId));
                if (productIndex !== -1) {
                    products[productIndex] = { ...products[productIndex], ...productData };
                    showAlert('Produkt erfolgreich aktualisiert', 'success');
                }
            } else {
                // Neues Produkt hinzuf√ºgen
                const newProduct = { id: nextProductId++, ...productData };
                products.push(newProduct);
                showAlert('Neues Produkt erfolgreich hinzugef√ºgt', 'success');
            }
            
            renderProducts();
            updateDashboard();
            closeModal('productModal');
        }

        function deleteProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (confirm(`M√∂chten Sie "${product.name}" wirklich l√∂schen?\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                products = products.filter(p => p.id !== productId);
                renderProducts();
                updateDashboard();
                showAlert('Produkt gel√∂scht', 'success');
            }
        }

        // ============ BESTAND-VERWALTUNG ============
        function openStockModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            document.getElementById('stockProductId').value = product.id;
            document.getElementById('stockProductName').value = `${product.emoji} ${product.name}`;
            document.getElementById('stockCurrent').value = product.stock;
            document.getElementById('stockNew').value = product.stock;
            document.getElementById('stockReason').value = 'nachkauf';
            document.getElementById('stockNote').value = '';
            
            document.getElementById('stockModal').style.display = 'block';
        }

        function updateStock(event) {
            event.preventDefault();
            
            const productId = parseInt(document.getElementById('stockProductId').value);
            const newStock = parseInt(document.getElementById('stockNew').value);
            const reason = document.getElementById('stockReason').value;
            const note = document.getElementById('stockNote').value.trim();
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const oldStock = product.stock;
            const difference = newStock - oldStock;
            
            if (newStock < 0) {
                showAlert('Bestand kann nicht negativ sein', 'error');
                return;
            }
            
            // Bestand aktualisieren
            product.stock = newStock;
            
            // Log erstellen (in Produktivversion w√ºrde das in die Datenbank)
            console.log(`Bestands√§nderung: ${product.name} von ${oldStock} auf ${newStock} (${difference >= 0 ? '+' : ''}${difference}) - Grund: ${reason}${note ? ' - ' + note : ''}`);
            
            renderProducts();
            updateDashboard();
            closeModal('stockModal');
            
            const action = difference > 0 ? 'erh√∂ht' : difference < 0 ? 'reduziert' : 'unver√§ndert';
            showAlert(`Bestand f√ºr "${product.name}" ${action} (${difference >= 0 ? '+' : ''}${difference})`, 'success');
        }

        // ============ HILFSFUNKTIONEN ============
        function getRoleIcon(role) {
            const icons = { member: 'üë•', guest: 'üë§', bartender: 'üç∫', admin: '‚öôÔ∏è' };
            return icons[role] || 'üë§';
        }

        function getRoleText(role) {
            const texts = { member: 'Mitglied', guest: 'Gast', bartender: 'Barkeeper', admin: 'Administrator' };
            return texts[role] || role;
        }

        function getCategoryText(category) {
            const categories = {
                bier: 'üç∫ Bier',
                softdrinks: 'ü•§ Softdrinks',
                schnaps: 'ü•É Spirituosen',
                snacks: 'üçø Snacks',
                heissgetraenke: '‚òï Hei√ügetr√§nke',
                sonstiges: 'üì¶ Sonstiges'
            };
            return categories[category] || category;
        }

        function getStockStatus(product) {
            if (product.stock <= 0) {
                return { text: '‚ùå Ausverkauft', color: '#e53e3e' };
            } else if (product.stock <= product.minStock) {
                return { text: '‚ö†Ô∏è Niedrig', color: '#ed8936' };
            } else {
                return { text: '‚úÖ OK', color: '#38a169' };
            }
        }

        // ============ MODAL FUNKTIONEN ============
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Schlie√üen bei Klick au√üerhalb
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // ============ EXPORT/IMPORT FUNKTIONEN ============
        function exportUsers() {
            const csv = convertToCSV(users, ['firstName', 'lastName', 'role', 'barcode', 'balance', 'sepa', 'email']);
            downloadCSV(csv, 'mitglieder.csv');
            showAlert('Mitgliederliste exportiert', 'success');
        }

        function exportInventory() {
            const csv = convertToCSV(products, ['name', 'category', 'memberPrice', 'guestPrice', 'stock', 'minStock', 'available', 'barcode']);
            downloadCSV(csv, 'inventar.csv');
            showAlert('Inventar exportiert', 'success');
        }

        function convertToCSV(data, fields) {
            const header = fields.join(',');
            const rows = data.map(item => 
                fields.map(field => `"${item[field] || ''}"`).join(',')
            );
            return [header, ...rows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function createBackup() {
            const backup = {
                timestamp: new Date().toISOString(),
                version: '1.0',
                users: users,
                products: products
            };
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `saarcade_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Backup erfolgreich erstellt', 'success');
        }

        function loadDemoData() {
            if (confirm('Demo-Daten laden? Aktuelle √Ñnderungen gehen verloren.')) {
                location.reload();
            }
        }

        function clearAllData() {
            if (confirm('ACHTUNG: Alle Daten werden gel√∂scht!\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                if (confirm('Letzte Warnung: Wirklich ALLE Daten l√∂schen?')) {
                    users.length = 0;
                    products.length = 0;
                    renderUsers();
                    renderProducts();
                    updateDashboard();
                    showAlert('Alle Daten wurden gel√∂scht', 'error');
                }
            }
        }

        function showLowStock() {
            const lowStockProducts = products.filter(p => p.stock <= p.minStock);
            if (lowStockProducts.length === 0) {
                showAlert('Alle Best√§nde sind ausreichend', 'success');
            } else {
                const message = `${lowStockProducts.length} Produkte haben niedrige Best√§nde:\n\n${lowStockProducts.map(p => `‚Ä¢ ${p.name}: ${p.stock} (Min: ${p.minStock})`).join('\n')}`;
                alert(message);
            }
        }

        // ============ TRANSAKTIONS-VERWALTUNG ============
        function renderTransactions() {
            const tbody = document.querySelector('#transactionTable tbody');
            tbody.innerHTML = '';
            
            // Sortiere nach Datum (neueste zuerst)
            const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                const date = new Date(transaction.date);
                const formattedDate = date.toLocaleString('de-DE');
                const paymentIcon = transaction.paymentType === 'cash' ? 'üíµ' : 'üí≥';
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${transaction.userName}</td>
                    <td>${transaction.productName}</td>
                    <td>${transaction.quantity}x</td>
                    <td>${transaction.price.toFixed(2)}‚Ç¨</td>
                    <td style="font-weight: bold;">${transaction.total.toFixed(2)}‚Ç¨</td>
                    <td>${paymentIcon} ${transaction.paymentType === 'cash' ? 'Bar' : 'Konto'}</td>
                `;
                tbody.appendChild(row);
            });
            
            updateTransactionSummary();
        }

        function updateTransactionSummary() {
            const today = new Date().toDateString();
            const todayTransactions = transactions.filter(t => new Date(t.date).toDateString() === today);
            const totalToday = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            const totalAll = transactions.reduce((sum, t) => sum + t.total, 0);
            
            document.getElementById('transactionSummary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #667eea;">${todayTransactions.length}</div>
                        <div>Transaktionen heute</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #38a169;">${totalToday.toFixed(2)}‚Ç¨</div>
                        <div>Umsatz heute</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #667eea;">${transactions.length}</div>
                        <div>Transaktionen gesamt</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2em; font-weight: bold; color: #38a169;">${totalAll.toFixed(2)}‚Ç¨</div>
                        <div>Umsatz gesamt</div>
                    </div>
                </div>
            `;
        }

        function exportTransactions() {
            const csv = convertToCSV(transactions, ['date', 'userName', 'productName', 'quantity', 'price', 'total', 'paymentType']);
            downloadCSV(csv, 'transaktionen.csv');
            showAlert('Transaktionen exportiert', 'success');
        }

        function loadTransactions() {
            // In Produktivversion: API-Call
            renderTransactions();
            showAlert('Transaktionen aktualisiert', 'info');
        }

        function clearOldTransactions() {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 30); // 30 Tage alt
            
            const oldCount = transactions.filter(t => new Date(t.date) < cutoffDate).length;
            
            if (oldCount === 0) {
                showAlert('Keine alten Transaktionen gefunden', 'info');
                return;
            }
            
            if (confirm(`${oldCount} Transaktionen √§lter als 30 Tage l√∂schen?`)) {
                transactions = transactions.filter(t => new Date(t.date) >= cutoffDate);
                renderTransactions();
                showAlert(`${oldCount} alte Transaktionen gel√∂scht`, 'success');
            }
        }

        function filterTransactions() {
            const fromDate = document.getElementById('transactionDateFrom').value;
            const toDate = document.getElementById('transactionDateTo').value;
            
            if (!fromDate || !toDate) {
                showAlert('Bitte beide Datumsfelder ausf√ºllen', 'error');
                return;
            }
            
            const filteredTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date).toDateString();
                const from = new Date(fromDate).toDateString();
                const to = new Date(toDate).toDateString();
                return transactionDate >= from && transactionDate <= to;
            });
            
            // Tempor√§r gefilterte Daten anzeigen
            const originalTransactions = [...transactions];
            transactions = filteredTransactions;
            renderTransactions();
            transactions = originalTransactions;
            
            showAlert(`${filteredTransactions.length} Transaktionen im gew√§hlten Zeitraum`, 'info');
        }

        function initializeDateFilters() {
            const today = new Date().toISOString().split('T')[0];
            const firstOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            
            document.getElementById('transactionDateFrom').value = firstOfMonth;
            document.getElementById('transactionDateTo').value = today;
        }

        // ============ SEPA-VERWALTUNG ============
        function renderSepaData() {
            const sepaUsers = users.filter(u => u.sepa && u.balance < 0);
            const totalAmount = sepaUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
            const dueDate = sepaDueDate.toLocaleDateString('de-DE');
            
            // Update Summary Cards
            document.getElementById('sepaUserCount').textContent = sepaUsers.length;
            document.getElementById('sepaAmount').textContent = totalAmount.toFixed(2) + '‚Ç¨';
            document.getElementById('sepaDueDate').textContent = dueDate;
            document.getElementById('sepaFileCount').textContent = '0'; // Demo
            
            // Render Table
            const tbody = document.querySelector('#sepaTable tbody');
            tbody.innerHTML = '';
            
            sepaUsers.forEach(user => {
                const row = document.createElement('tr');
                const amount = Math.abs(user.balance);
                const lastDebit = user.lastDebit ? new Date(user.lastDebit).toLocaleDateString('de-DE') : 'Noch nie';
                
                row.innerHTML = `
                    <td>${user.firstName} ${user.lastName}</td>
                    <td>${user.iban || 'Keine IBAN'}</td>
                    <td style="font-weight: bold; color: #e53e3e;">${amount.toFixed(2)}‚Ç¨</td>
                    <td>${user.mandateId || 'Kein Mandat'}</td>
                    <td><span style="color: #38a169;">‚úÖ Bereit</span></td>
                    <td>${lastDebit}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Enable/Disable Download Button
            document.getElementById('sepaDownloadBtn').disabled = sepaUsers.length === 0;
        }

        function downloadSepaFile() {
            const sepaUsers = users.filter(u => u.sepa && u.balance < 0);
            
            if (sepaUsers.length === 0) {
                showAlert('Keine Benutzer f√ºr SEPA-Export verf√ºgbar', 'error');
                return;
            }
            
            const sepaXml = generateSepaXML(sepaUsers);
            const blob = new Blob([sepaXml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `SEPA_Saarcade_${new Date().toISOString().split('T')[0]}.xml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Update last debit date
            sepaUsers.forEach(user => {
                user.lastDebit = new Date().toISOString().split('T')[0];
                user.balance = 0.00; // Reset balance after SEPA
            });
            
            renderUsers();
            renderSepaData();
            updateDashboard();
            
            showAlert(`SEPA-Datei mit ${sepaUsers.length} Lastschriften erstellt`, 'success');
        }

        function generateSepaXML(sepaUsers) {
            const totalAmount = sepaUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
            const msgId = `SAARCADE${Date.now()}`;
            const creationDate = new Date().toISOString();
            const dueDate = sepaDueDate.toISOString().split('T')[0];
            
            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<Document xmlns="urn:iso:std:iso:20022:tech:xsd:pain.008.001.02">
    <CstmrDrctDbtInitn>
        <GrpHdr>
            <MsgId>${msgId}</MsgId>
            <CreDtTm>${creationDate}</CreDtTm>
            <NbOfTxs>${sepaUsers.length}</NbOfTxs>
            <CtrlSum>${totalAmount.toFixed(2)}</CtrlSum>
            <InitgPty>
                <Nm>Saarcade e.V.</Nm>
                <Id>
                    <OrgId>
                        <Othr>
                            <Id>DE98ZZZ09999999999</Id>
                        </Othr>
                    </OrgId>
                </Id>
            </InitgPty>
        </GrpHdr>
        <PmtInf>
            <PmtInfId>PMTINF-${Date.now()}</PmtInfId>
            <PmtMtd>DD</PmtMtd>
            <NbOfTxs>${sepaUsers.length}</NbOfTxs>
            <CtrlSum>${totalAmount.toFixed(2)}</CtrlSum>
            <PmtTpInf>
                <SvcLvl>
                    <Cd>SEPA</Cd>
                </SvcLvl>
                <LclInstrm>
                    <Cd>CORE</Cd>
                </LclInstrm>
                <SeqTp>RCUR</SeqTp>
            </PmtTpInf>
            <ReqdColltnDt>${dueDate}</ReqdColltnDt>
            <Cdtr>
                <Nm>Saarcade e.V.</Nm>
            </Cdtr>
            <CdtrAcct>
                <Id>
                    <IBAN>DE89370400440532013000</IBAN>
                </Id>
            </CdtrAcct>
            <CdtrAgt>
                <FinInstnId>
                    <BIC>COBADEFFXXX</BIC>
                </FinInstnId>
            </CdtrAgt>
            <CdtrSchmeId>
                <Id>
                    <PrvtId>
                        <Othr>
                            <Id>DE98ZZZ09999999999</Id>
                            <SchmeNm>
                                <Prtry>SEPA</Prtry>
                            </SchmeNm>
                        </Othr>
                    </PrvtId>
                </Id>
            </CdtrSchmeId>`;
            
            sepaUsers.forEach((user, index) => {
                const amount = Math.abs(user.balance);
                xml += `
            <DrctDbtTxInf>
                <PmtId>
                    <EndToEndId>TXN-${Date.now()}-${index + 1}</EndToEndId>
                </PmtId>
                <InstdAmt Ccy="EUR">${amount.toFixed(2)}</InstdAmt>
                <DrctDbtTx>
                    <MndtRltdInf>
                        <MndtId>${user.mandateId}</MndtId>
                        <DtOfSgntr>2024-01-01</DtOfSgntr>
                    </MndtRltdInf>
                </DrctDbtTx>
                <DbtrAgt>
                    <FinInstnId>
                        <Othr>
                            <Id>NOTPROVIDED</Id>
                        </Othr>
                    </FinInstnId>
                </DbtrAgt>
                <Dbtr>
                    <Nm>${user.firstName} ${user.lastName}</Nm>
                </Dbtr>
                <DbtrAcct>
                    <Id>
                        <IBAN>${user.iban.replace(/\s/g, '')}</IBAN>
                    </Id>
                </DbtrAcct>
                <RmtInf>
                    <Ustrd>Saarcade Kassenabrechnng</Ustrd>
                </RmtInf>
            </DrctDbtTxInf>`;
            });
            
            xml += `
        </PmtInf>
    </CstmrDrctDbtInitn>
</Document>`;
            
            return xml;
        }

        function previewSepaFile() {
            const sepaUsers = users.filter(u => u.sepa && u.balance < 0);
            
            if (sepaUsers.length === 0) {
                showAlert('Keine Benutzer f√ºr SEPA-Export verf√ºgbar', 'error');
                return;
            }
            
            const totalAmount = sepaUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
            const dueDate = sepaDueDate.toLocaleDateString('de-DE');
            
            let preview = `SEPA-Lastschrift Vorschau\n`;
            preview += `========================\n\n`;
            preview += `F√§lligkeitsdatum: ${dueDate}\n`;
            preview += `Anzahl Lastschriften: ${sepaUsers.length}\n`;
            preview += `Gesamtbetrag: ${totalAmount.toFixed(2)}‚Ç¨\n\n`;
            preview += `Details:\n--------\n`;
            
            sepaUsers.forEach((user, index) => {
                const amount = Math.abs(user.balance);
                preview += `${index + 1}. ${user.firstName} ${user.lastName}\n`;
                preview += `   IBAN: ${user.iban}\n`;
                preview += `   Betrag: ${amount.toFixed(2)}‚Ç¨\n`;
                preview += `   Mandat: ${user.mandateId}\n\n`;
            });
            
            alert(preview);
        }

        function updateSepaDueDate() {
            const newDate = prompt('Neues F√§lligkeitsdatum (YYYY-MM-DD):', sepaDueDate.toISOString().split('T')[0]);
            
            if (newDate && !isNaN(new Date(newDate))) {
                sepaDueDate = new Date(newDate);
                renderSepaData();
                showAlert('F√§lligkeitsdatum aktualisiert', 'success');
            } else if (newDate) {
                showAlert('Ung√ºltiges Datum', 'error');
            }
        }

        // ============ ALERT SYSTEM ============
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            alertDiv.innerHTML = `<span>${icon}</span><div>${message}</div>`;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.children[1]);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 4000);
        }

        console.log('‚öôÔ∏è Admin-Dashboard vollst√§ndig geladen');
        console.log('‚úÖ Alle CRUD-Funktionen verf√ºgbar');
    </script>
</body>
</html>
