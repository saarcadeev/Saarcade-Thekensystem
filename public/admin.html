<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Saarcade Admin - Mit API-Integration</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #2d3748;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .api-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .api-status.connected {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .api-status.error {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            background: #f7fafc;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 25px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .btn-secondary { background: linear-gradient(135deg, #a0aec0, #718096); }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .toolbar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #1a202c;
            border-left: 5px solid #38a169;
        }

        .alert-error {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            color: #1a202c;
            border-left: 5px solid #e53e3e;
        }

        .alert-info {
            background: linear-gradient(135deg, #bee3f8, #90cdf4);
            color: #1a202c;
            border-left: 5px solid #3182ce;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px; font-weight: 600;">Lade Daten...</p>
        </div>
    </div>

    <div class="header">
        <div class="api-status" id="apiStatus">üîÑ Verbinde mit API...</div>
        <h1>‚öôÔ∏è Saarcade Admin-Dashboard</h1>
        <p>Vollst√§ndige Verwaltung mit Datenbank-Integration</p>
    </div>

    <div class="container">
        <!-- Dashboard Statistiken -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-number" id="memberCount">-</div>
                <div class="stat-label">Vereinsmitglieder</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="productCount">-</div>
                <div class="stat-label">Produkte</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalStock">-</div>
                <div class="stat-label">Gesamtbestand</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayRevenue">-</div>
                <div class="stat-label">Heute (‚Ç¨)</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('users')">üë• Mitglieder</button>
            <button class="tab" onclick="showTab('transactions')">üí∞ Transaktionen</button>
            <button class="tab" onclick="showTab('products')">üì¶ Produkte</button>
            <button class="tab" onclick="showTab('sepa')">üí≥ SEPA-Export</button>
        </div>

        <!-- Mitglieder Tab -->
        <div id="users" class="tab-content active">
            <div class="section">
                <h2>üë• Mitgliederverwaltung</h2>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="loadUsers()" id="loadUsersBtn">
                        üîÑ Neu laden
                    </button>
                    <button class="btn btn-secondary" onclick="exportData('users')">
                        üìä Export CSV
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="userTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Rolle</th>
                                <th>Barcode</th>
                                <th>Saldo</th>
                                <th>SEPA</th>
                                <th>E-Mail</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                    Lade Mitgliederdaten...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transaktionen Tab -->
        <div id="transactions" class="tab-content">
            <div class="section">
                <h2>üí∞ Transaktionsverlauf</h2>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="loadTransactions()" id="loadTransactionsBtn">
                        üîÑ Neu laden
                    </button>
                    <button class="btn btn-secondary" onclick="exportData('transactions')">
                        üìä Export CSV
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="transactionTable">
                        <thead>
                            <tr>
                                <th>Datum/Zeit</th>
                                <th>Benutzer</th>
                                <th>Artikel</th>
                                <th>Menge</th>
                                <th>Preis</th>
                                <th>Gesamt</th>
                                <th>Zahlart</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                    Lade Transaktionsdaten...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Produkte Tab -->
        <div id="products" class="tab-content">
            <div class="section">
                <h2>üì¶ Produktverwaltung</h2>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="loadProducts()" id="loadProductsBtn">
                        üîÑ Neu laden
                    </button>
                    <button class="btn btn-secondary" onclick="exportData('products')">
                        üìä Export CSV
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="productTable">
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>Kategorie</th>
                                <th>Mitgliedspreis</th>
                                <th>Gastpreis</th>
                                <th>Bestand</th>
                                <th>Verf√ºgbar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                    Lade Produktdaten...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SEPA Tab -->
        <div id="sepa" class="tab-content">
            <div class="section">
                <h2>üí≥ SEPA-Lastschriften</h2>
                
                <div class="alert alert-info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        <strong>SEPA-Export:</strong> Alle Mitglieder mit negativem Saldo und aktivem SEPA-Mandat k√∂nnen abgebucht werden.
                    </div>
                </div>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="loadSepaUsers()" id="loadSepaBtn">
                        üîÑ SEPA-Daten laden
                    </button>
                    <button class="btn btn-warning" onclick="downloadSepaXML()" id="sepaDownloadBtn" disabled>
                        üíæ SEPA-XML herunterladen
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="sepaTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>IBAN</th>
                                <th>Betrag</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px; color: #666;">
                                    Klicke "SEPA-Daten laden" um Lastschriften anzuzeigen
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ GLOBALE VARIABLEN ============
        let apiConnected = false;
        let users = [];
        let products = [];
        let transactions = [];
        let sepaUsers = [];

        // ============ API FUNCTIONS ============
        
        async function apiCall(endpoint, options = {}) {
            try {
                showLoading(true);
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateApiStatus(true);
                return data;
                
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                updateApiStatus(false, error.message);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // ============ UI FUNCTIONS ============
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function updateApiStatus(connected, errorMsg = '') {
            const statusEl = document.getElementById('apiStatus');
            apiConnected = connected;
            
            if (connected) {
                statusEl.className = 'api-status connected';
                statusEl.textContent = '‚úÖ API verbunden';
            } else {
                statusEl.className = 'api-status error';
                statusEl.textContent = `‚ùå API-Fehler: ${errorMsg}`;
            }
        }

        function showAlert(message, type = 'info') {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            alertDiv.innerHTML = `<span>${icon}</span><div>${message}</div>`;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.children[1]);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // ============ TAB NAVIGATION ============
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ============ DATA LOADING FUNCTIONS ============
        
        async function loadDashboard() {
            try {
                const data = await apiCall('/api/dashboard');
                console.log('Dashboard-Daten:', data);
                
                document.getElementById('memberCount').textContent = data.member_count || 0;
                document.getElementById('productCount').textContent = data.available_products || 0;
                document.getElementById('totalStock').textContent = data.total_stock || 0;
                document.getElementById('todayRevenue').textContent = `${(data.today_revenue || 0).toFixed(2)}`;
                
            } catch (error) {
                console.error('Fehler beim Laden der Dashboard-Daten:', error);
                showAlert('Fehler beim Laden der Dashboard-Statistiken', 'error');
            }
        }

        async function loadUsers() {
            try {
                const loadBtn = document.getElementById('loadUsersBtn');
                loadBtn.disabled = true;
                loadBtn.textContent = '‚è≥ Lade...';
                
                users = await apiCall('/api/users');
                console.log(`${users.length} Benutzer geladen`);
                
                renderUsers();
                showAlert(`${users.length} Mitglieder erfolgreich geladen`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der Benutzer:', error);
                showAlert('Fehler beim Laden der Mitgliederdaten', 'error');
            } finally {
                const loadBtn = document.getElementById('loadUsersBtn');
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ Neu laden';
            }
        }

        async function loadProducts() {
            try {
                const loadBtn = document.getElementById('loadProductsBtn');
                loadBtn.disabled = true;
                loadBtn.textContent = '‚è≥ Lade...';
                
                products = await apiCall('/api/products');
                console.log(`${products.length} Produkte geladen`);
                
                renderProducts();
                showAlert(`${products.length} Produkte erfolgreich geladen`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der Produkte:', error);
                showAlert('Fehler beim Laden der Produktdaten', 'error');
            } finally {
                const loadBtn = document.getElementById('loadProductsBtn');
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ Neu laden';
            }
        }

        async function loadTransactions() {
            try {
                const loadBtn = document.getElementById('loadTransactionsBtn');
                loadBtn.disabled = true;
                loadBtn.textContent = '‚è≥ Lade...';
                
                transactions = await apiCall('/api/transactions');
                console.log(`${transactions.length} Transaktionen geladen`);
                
                renderTransactions();
                showAlert(`${transactions.length} Transaktionen erfolgreich geladen`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der Transaktionen:', error);
                showAlert('Fehler beim Laden der Transaktionsdaten', 'error');
            } finally {
                const loadBtn = document.getElementById('loadTransactionsBtn');
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ Neu laden';
            }
        }

        async function loadSepaUsers() {
            try {
                const loadBtn = document.getElementById('loadSepaBtn');
                loadBtn.disabled = true;
                loadBtn.textContent = '‚è≥ Lade...';
                
                sepaUsers = await apiCall('/api/sepa-users');
                console.log(`${sepaUsers.length} SEPA-Benutzer geladen`);
                
                renderSepaUsers();
                document.getElementById('sepaDownloadBtn').disabled = sepaUsers.length === 0;
                showAlert(`${sepaUsers.length} SEPA-Benutzer gefunden`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der SEPA-Benutzer:', error);
                showAlert('Fehler beim Laden der SEPA-Daten', 'error');
            } finally {
                const loadBtn = document.getElementById('loadSepaBtn');
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ SEPA-Daten laden';
            }
        }

        // ============ RENDER FUNCTIONS ============
        
        function renderUsers() {
            const tbody = document.querySelector('#userTable tbody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Keine Mitgliederdaten verf√ºgbar</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const balanceColor = user.balance >= 0 ? '#38a169' : '#e53e3e';
                const roleIcon = getRoleIcon(user.role);
                const sepaStatus = user.sepa_active ? '‚úÖ Aktiv' : '‚ùå Inaktiv';
                
                return `
                    <tr>
                        <td>${user.first_name} ${user.last_name}</td>
                        <td>${roleIcon} ${getRoleText(user.role)}</td>
                        <td><code>${user.barcode}</code></td>
                        <td style="color: ${balanceColor}; font-weight: bold;">${user.balance.toFixed(2)}‚Ç¨</td>
                        <td>${sepaStatus}</td>
                        <td>${user.email || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderProducts() {
            const tbody = document.querySelector('#productTable tbody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">Keine Produktdaten verf√ºgbar</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => {
                const stockColor = product.stock > 0 ? '#38a169' : '#e53e3e';
                const availableText = product.available ? '‚úÖ Ja' : '‚ùå Nein';
                
                return `
                    <tr>
                        <td>${product.image || 'üì¶'} ${product.name}</td>
                        <td>${getCategoryText(product.category)}</td>
                        <td>${product.member_price.toFixed(2)}‚Ç¨</td>
                        <td>${product.guest_price.toFixed(2)}‚Ç¨</td>
                        <td style="color: ${stockColor}; font-weight: bold;">${product.stock}</td>
                        <td>${availableText}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderTransactions() {
            const tbody = document.querySelector('#transactionTable tbody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">Keine Transaktionsdaten verf√ºgbar</td></tr>';
                return;
            }
            
            tbody.innerHTML = transactions.map(transaction => {
                const date = new Date(transaction.created_at);
                const formattedDate = date.toLocaleString('de-DE');
                const paymentIcon = transaction.payment_method === 'cash' ? 'üíµ' : 'üí≥';
                
                return `
                    <tr>
                        <td>${formattedDate}</td>
                        <td>${transaction.user_name}</td>
                        <td>${transaction.product_name}</td>
                        <td>${transaction.quantity}x</td>
                        <td>${transaction.price.toFixed(2)}‚Ç¨</td>
                        <td style="font-weight: bold;">${transaction.total.toFixed(2)}‚Ç¨</td>
                        <td>${paymentIcon} ${transaction.payment_method === 'cash' ? 'Bar' : 'Konto'}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderSepaUsers() {
            const tbody = document.querySelector('#sepaTable tbody');
            
            if (sepaUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #666;">Keine SEPA-Benutzer mit negativem Saldo gefunden</td></tr>';
                return;
            }
            
            tbody.innerHTML = sepaUsers.map(user => {
                const amount = Math.abs(user.balance);
                
                return `
                    <tr>
                        <td>${user.first_name} ${user.last_name}</td>
                        <td><code>${formatIban(user.iban)}</code></td>
                        <td style="font-weight: bold; color: #e53e3e;">${amount.toFixed(2)}‚Ç¨</td>
                        <td><span style="color: #38a169;">‚úÖ Bereit</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ============ HELPER FUNCTIONS ============
        
        function getRoleIcon(role) {
            const icons = { member: 'üë•', guest: 'üë§', bartender: 'üç∫', admin: '‚öôÔ∏è' };
            return icons[role] || 'üë§';
        }

        function getRoleText(role) {
            const texts = { member: 'Mitglied', guest: 'Gast', bartender: 'Barkeeper', admin: 'Administrator' };
            return texts[role] || role;
        }

        function getCategoryText(category) {
            const categories = {
                bier: 'üç∫ Bier',
                softdrinks: 'ü•§ Softdrinks',
                schnaps: 'ü•É Spirituosen',
                snacks: 'üçø Snacks',
                heissgetraenke: '‚òï Hei√ügetr√§nke',
                sonstiges: 'üì¶ Sonstiges'
            };
            return categories[category] || category;
        }

        function formatIban(iban) {
            if (!iban) return '';
            return iban.replace(/(.{4})/g, '$1 ').trim();
        }

        // ============ EXPORT FUNCTIONS ============
        
        function exportData(type) {
            let data, filename, fields;
            
            switch(type) {
                case 'users':
                    data = users;
                    filename = 'mitglieder.csv';
                    fields = ['first_name', 'last_name', 'role', 'barcode', 'balance', 'sepa_active', 'email'];
                    break;
                case 'products':
                    data = products;
                    filename = 'produkte.csv';
                    fields = ['name', 'category', 'member_price', 'guest_price', 'stock', 'available'];
                    break;
                case 'transactions':
                    data = transactions;
                    filename = 'transaktionen.csv';
                    fields = ['created_at', 'user_name', 'product_name', 'quantity', 'price', 'total', 'payment_method'];
                    break;
                default:
                    return;
            }
            
            if (data.length === 0) {
                showAlert(`Keine ${type}-Daten zum Exportieren verf√ºgbar`, 'error');
                return;
            }
            
            const csv = convertToCSV(data, fields);
            downloadCSV(csv, filename);
            showAlert(`${type} erfolgreich als CSV exportiert`, 'success');
        }

        function convertToCSV(data, fields) {
            const header = fields.join(',');
            const rows = data.map(item => 
                fields.map(field => `"${item[field] || ''}"`).join(',')
            );
            return [header, ...rows].join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ============ SEPA FUNCTIONS ============
        
        function downloadSepaXML() {
            if (sepaUsers.length === 0) {
                showAlert('Keine SEPA-Benutzer zum Export verf√ºgbar', 'error');
                return;
            }
            
            const xml = generateSepaXML(sepaUsers);
            const blob = new Blob([xml], { type: 'application/xml' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `SEPA_Saarcade_${new Date().toISOString().split('T')[0]}.xml`;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert(`SEPA-Datei mit ${sepaUsers.length} Lastschriften erstellt`, 'success');
        }

        function generateSepaXML(users) {
            const totalAmount = users.reduce((sum, u) => sum + Math.abs(u.balance), 0);
            const msgId = `SAARCADE${Date.now()}`;
            const creationDate = new Date().toISOString();
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 5); // 5 Tage Vorlauf
            const dueDateStr = dueDate.toISOString().split('T')[0];
            
            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<Document xmlns="urn:iso:std:iso:20022:tech:xsd:pain.008.001.02">
    <CstmrDrctDbtInitn>
        <GrpHdr>
            <MsgId>${msgId}</MsgId>
            <CreDtTm>${creationDate}</CreDtTm>
            <NbOfTxs>${users.length}</NbOfTxs>
            <CtrlSum>${totalAmount.toFixed(2)}</CtrlSum>
            <InitgPty>
                <Nm>Saarcade e.V.</Nm>
                <Id>
                    <OrgId>
                        <Othr>
                            <Id>DE98ZZZ09999999999</Id>
                        </Othr>
                    </OrgId>
                </Id>
            </InitgPty>
        </GrpHdr>
        <PmtInf>
            <PmtInfId>PMTINF-${Date.now()}</PmtInfId>
            <PmtMtd>DD</PmtMtd>
            <NbOfTxs>${users.length}</NbOfTxs>
            <CtrlSum>${totalAmount.toFixed(2)}</CtrlSum>
            <PmtTpInf>
                <SvcLvl>
                    <Cd>SEPA</Cd>
                </SvcLvl>
                <LclInstrm>
                    <Cd>CORE</Cd>
                </LclInstrm>
                <SeqTp>RCUR</SeqTp>
            </PmtTpInf>
            <ReqdColltnDt>${dueDateStr}</ReqdColltnDt>
            <Cdtr>
                <Nm>Saarcade e.V.</Nm>
            </Cdtr>
            <CdtrAcct>
                <Id>
                    <IBAN>DE89370400440532013000</IBAN>
                </Id>
            </CdtrAcct>
            <CdtrAgt>
                <FinInstnId>
                    <BIC>COBADEFFXXX</BIC>
                </FinInstnId>
            </CdtrAgt>
            <CdtrSchmeId>
                <Id>
                    <PrvtId>
                        <Othr>
                            <Id>DE98ZZZ09999999999</Id>
                            <SchmeNm>
                                <Prtry>SEPA</Prtry>
                            </SchmeNm>
                        </Othr>
                    </PrvtId>
                </Id>
            </CdtrSchmeId>`;
            
            users.forEach((user, index) => {
                const amount = Math.abs(user.balance);
                const endToEndId = `TXN-${Date.now()}-${(index + 1).toString().padStart(3, '0')}`;
                
                xml += `
            <DrctDbtTxInf>
                <PmtId>
                    <EndToEndId>${endToEndId}</EndToEndId>
                </PmtId>
                <InstdAmt Ccy="EUR">${amount.toFixed(2)}</InstdAmt>
                <DrctDbtTx>
                    <MndtRltdInf>
                        <MndtId>SEPA-${user.id.toString().padStart(3, '0')}</MndtId>
                        <DtOfSgntr>2024-01-01</DtOfSgntr>
                    </MndtRltdInf>
                </DrctDbtTx>
                <DbtrAgt>
                    <FinInstnId>
                        <Othr>
                            <Id>NOTPROVIDED</Id>
                        </Othr>
                    </FinInstnId>
                </DbtrAgt>
                <Dbtr>
                    <Nm>${user.first_name} ${user.last_name}</Nm>
                </Dbtr>
                <DbtrAcct>
                    <Id>
                        <IBAN>${user.iban}</IBAN>
                    </Id>
                </DbtrAcct>
                <RmtInf>
                    <Ustrd>Saarcade Kassenabrechnung</Ustrd>
                </RmtInf>
            </DrctDbtTxInf>`;
            });
            
            xml += `
        </PmtInf>
    </CstmrDrctDbtInitn>
</Document>`;
            
            return xml;
        }

        // ============ INITIALIZATION ============
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Admin-Dashboard mit API-Integration startet...');
            
            try {
                // API-Verbindung testen
                await apiCall('/api/dashboard');
                
                // Initial Dashboard laden
                await loadDashboard();
                
                // Initial Mitglieder laden
                await loadUsers();
                
                console.log('‚úÖ Admin-Dashboard erfolgreich initialisiert');
                showAlert('Dashboard erfolgreich geladen', 'success');
                
            } catch (error) {
                console.error('‚ùå Fehler bei der Initialisierung:', error);
                showAlert('Fehler beim Laden des Dashboards. Pr√ºfe die API-Verbindung.', 'error');
            }
        });
    </script>
</body>
</html>
