<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Saarcade Admin - Mit Bildupload</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #2d3748;
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .api-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .api-status.connected {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.5);
        }

        .api-status.error {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            background: #f7fafc;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 25px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 16px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #666;
            font-size: 0.9em;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.6em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 4px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success { background: linear-gradient(135deg, #48bb78, #38a169); }
        .btn-warning { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .btn-danger { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .btn-secondary { background: linear-gradient(135deg, #a0aec0, #718096); }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-top: 15px;
            font-size: 0.9em;
        }

        .data-table th, .data-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 0.85em;
        }

        .data-table tr:hover {
            background: #f7fafc;
        }

        .data-table tr.selected {
            background: #e6f3ff;
        }

        .checkbox-cell {
            width: 30px;
            text-align: center;
        }

        .checkbox-cell input[type="checkbox"] {
            transform: scale(1.2);
            cursor: pointer;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .stat-number {
            font-size: 2.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
            font-size: 0.9em;
        }

        .toolbar {
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .selection-info {
            background: #e6f3ff;
            color: #1a365d;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: auto;
        }

        .alert {
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .alert-success {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #1a202c;
            border-left: 4px solid #38a169;
        }

        .alert-error {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            color: #1a202c;
            border-left: 4px solid #e53e3e;
        }

        .alert-info {
            background: linear-gradient(135deg, #bee3f8, #90cdf4);
            color: #1a202c;
            border-left: 4px solid #3182ce;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }

        .close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ddd;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9em;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .photo-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .photo-upload:hover {
            background: #f8f9ff;
            border-color: #5a67d8;
        }

        .photo-upload.dragover {
            background: #e6f3ff;
            border-color: #3182ce;
        }

        .photo-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            object-fit: cover;
            margin: 10px auto;
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .photo-upload-progress {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            display: none;
        }

        .photo-actions {
            margin-top: 10px;
            display: none;
        }

        .photo-preview-container.has-image .photo-actions {
            display: block;
        }

        .product-image-cell {
            width: 60px;
            text-align: center;
            padding: 5px;
        }

        .product-image-preview {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            border: 2px solid #e2e8f0;
        }

        .product-emoji-fallback {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            background: #f7fafc;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .dashboard-grid { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; align-items: stretch; }
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="loading-spinner"></div>
            <p style="margin-top: 15px; font-weight: 600;">Lade Daten...</p>
        </div>
    </div>

    <div class="header">
        <div class="api-status" id="apiStatus">üîÑ Verbinde mit API...</div>
        <h1>‚öôÔ∏è Saarcade Admin-Dashboard</h1>
        <p>Vollst√§ndige Verwaltung mit Bildupload-Integration</p>
    </div>

    <div class="container">
        <!-- Dashboard Statistiken -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-number" id="memberCount">-</div>
                <div class="stat-label">Vereinsmitglieder</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="productCount">-</div>
                <div class="stat-label">Produkte</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="transactionCount">-</div>
                <div class="stat-label">Transaktionen</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayRevenue">-</div>
                <div class="stat-label">Heute (‚Ç¨)</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab" onclick="showTab('users')">üë• Mitglieder</button>
            <button class="tab active" onclick="showTab('products')">üì¶ Produkte</button>
            <button class="tab" onclick="showTab('transactions')">üí∞ Transaktionen</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Einstellungen</button>
            <button class="tab" onclick="showTab('billing')">üìã Abrechnung</button>
        </div>

        <!-- Mitglieder Tab -->
        <div id="users" class="tab-content">
            <div class="section">
                <h2>üë• Mitgliederverwaltung</h2>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="openUserModal()" id="addUserBtn">
                        ‚ûï Neues Mitglied
                    </button>
                    <button class="btn btn-warning" onclick="editSelectedUser()" id="editUserBtn" disabled>
                        ‚úèÔ∏è Bearbeiten
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelectedUsers()" id="deleteUserBtn" disabled>
                        üóëÔ∏è L√∂schen
                    </button>
                    <button class="btn btn-secondary" onclick="loadUsers()" id="loadUsersBtn">
                        üîÑ Neu laden
                    </button>
                    <div class="selection-info" id="userSelectionInfo">0 ausgew√§hlt</div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="userTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAll('users')">
                                </th>
                                <th>Name</th>
                                <th>Rolle</th>
                                <th>Barcode</th>
                                <th>Saldo</th>
                                <th>SEPA</th>
                                <th>E-Mail</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                                    Lade Mitgliederdaten...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Produkte Tab -->
        <div id="products" class="tab-content active">
            <div class="section">
                <h2>üì¶ Produktverwaltung mit Bildupload</h2>
                
                <div class="toolbar">
                    <button class="btn btn-success" onclick="openProductModal()" id="addProductBtn">
                        ‚ûï Neues Produkt
                    </button>
                    <button class="btn btn-warning" onclick="editSelectedProduct()" id="editProductBtn" disabled>
                        ‚úèÔ∏è Bearbeiten
                    </button>
                    <button class="btn btn-danger" onclick="deleteSelectedProducts()" id="deleteProductBtn" disabled>
                        üóëÔ∏è L√∂schen
                    </button>
                    <button class="btn btn-secondary" onclick="loadProducts()" id="loadProductsBtn">
                        üîÑ Neu laden
                    </button>
                    <div class="selection-info" id="productSelectionInfo">0 ausgew√§hlt</div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table" id="productTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAllProducts" onchange="toggleSelectAll('products')">
                                </th>
                                <th>Bild</th>
                                <th>Produkt</th>
                                <th>Kategorie</th>
                                <th>Mitgliedspreis</th>
                                <th>Gastpreis</th>
                                <th>Bestand</th>
                                <th>Barcode</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 30px; color: #666;">
                                    Klicke "Neu laden" um Produktdaten zu laden
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transaktionen Tab -->
        <div id="transactions" class="tab-content">
            <div class="section">
                <h2>üí∞ Transaktionsverlauf</h2>
                
                <div class="toolbar">
                    <button class="btn" onclick="loadTransactions()">üîÑ Neu laden</button>
                    <button class="btn btn-success" onclick="exportTransactions()">üìä CSV Export</button>
                    <select id="transactionFilter" onchange="filterTransactions()" style="padding: 10px; border-radius: 6px; border: 2px solid #e2e8f0;">
                        <option value="all">Alle Transaktionen</option>
                        <option value="today">Heute</option>
                        <option value="week">Diese Woche</option>
                        <option value="month">Dieser Monat</option>
                    </select>
                </div>
                
                <table class="data-table" id="transactionTable">
                    <thead>
                        <tr>
                            <th>Datum/Zeit</th>
                            <th>Mitglied</th>
                            <th>Produkt</th>
                            <th>Menge</th>
                            <th>Preis</th>
                            <th>Gesamt</th>
                            <th>Zahlungsart</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                                Klicke "Neu laden" um Transaktionen zu laden
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div id="transactionSummary" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 6px; display: none;">
                    <strong>Zusammenfassung:</strong>
                    <div style="margin-top: 10px;">
                        <span id="transactionCountSpan">0</span> Transaktionen | 
                        Gesamtumsatz: <span id="totalRevenue">0.00</span>‚Ç¨
                    </div>
                </div>
            </div>
        </div>

        <!-- Einstellungen Tab (vorher Barcodes) -->
        <div id="settings" class="tab-content">
            <div class="section">
                <h2>‚öôÔ∏è System-Einstellungen</h2>
                
                <h3 style="margin-top: 25px; margin-bottom: 15px; color: #667eea;">üè∑Ô∏è Spezial-Barcodes</h3>
                <p>Konfiguriere die speziellen System-Barcodes f√ºr das Kassensystem.</p>
                
                <form id="settingsForm" style="max-width: 800px; margin-top: 20px;">
                    <div class="form-group">
                        <label>üõí Checkout-Barcode</label>
                        <input type="text" id="checkoutBarcode" placeholder="CHECKOUT123" value="CHECKOUT123">
                        <small style="color: #666;">Dieser Barcode schlie√üt den Kaufvorgang ab</small>
                    </div>
                    
                    <div class="form-group">
                        <label>‚ùå Abbruch-Barcode</label>
                        <input type="text" id="cancelBarcode" placeholder="CANCEL123" value="CANCEL123">
                        <small style="color: #666;">Leert den Warenkorb</small>
                    </div>
                    
                    <div class="form-group">
                        <label>üîÑ Reset-Barcode</label>
                        <input type="text" id="resetBarcode" placeholder="RESET123" value="RESET123">
                        <small style="color: #666;">Beendet die komplette Session</small>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 2px solid #e2e8f0;">

                    <h3 style="margin-bottom: 15px; color: #667eea;">üí≥ SEPA-Lastschrift Einstellungen</h3>
                    <p style="margin-bottom: 20px;">Diese Daten werden f√ºr den SEPA-XML-Export ben√∂tigt.</p>
                    
                    <div class="form-group">
                        <label>Vereinsname *</label>
                        <input type="text" id="creditorName" placeholder="Saarcade e.V." value="Saarcade e.V." required>
                        <small style="color: #666;">Offizieller Name des Vereins</small>
                    </div>

                    <div class="form-group">
                        <label>Gl√§ubiger-Identifikationsnummer (Creditor ID) *</label>
                        <input type="text" id="creditorId" placeholder="DE98ZZZ09999999999" required>
                        <small style="color: #666;">Eindeutige ID f√ºr SEPA-Lastschriften (erh√§ltlich bei der Bundesbank)</small>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Vereins-IBAN *</label>
                            <input type="text" id="creditorIban" placeholder="DE89 3704 0044 0532 0130 00" required>
                            <small style="color: #666;">IBAN des Vereinskontos</small>
                        </div>
                        
                        <div class="form-group">
                            <label>BIC (optional)</label>
                            <input type="text" id="creditorBic" placeholder="COBADEFFXXX">
                            <small style="color: #666;">Bei deutschen IBANs optional</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Verwendungszweck (Standard)</label>
                        <input type="text" id="sepaReference" placeholder="Getr√§nkeabrechnung" value="Saarcade Getraenkeabrechnung">
                        <small style="color: #666;">Wird auf dem Kontoauszug angezeigt</small>
                    </div>

                    <div class="form-group">
                        <label>SEPA-Sequenztyp</label>
                        <select id="sepaSequenceType">
                            <option value="RCUR">RCUR - Wiederkehrende Lastschrift</option>
                            <option value="FRST">FRST - Erste Lastschrift</option>
                            <option value="OOFF">OOFF - Einmalige Lastschrift</option>
                            <option value="FNAL">FNAL - Letzte Lastschrift</option>
                        </select>
                        <small style="color: #666;">Standard: RCUR f√ºr wiederkehrende monatliche Abbuchungen</small>
                    </div>

                    <div style="margin-top: 25px; padding: 15px; background: #fff5e6; border-left: 4px solid #ed8936; border-radius: 4px;">
                        <strong>‚ö†Ô∏è Wichtig:</strong> Die Gl√§ubiger-ID kannst du bei der Deutschen Bundesbank beantragen. 
                        <a href="https://extranet.bundesbank.de/scp/" target="_blank" style="color: #667eea;">Hier geht's zur Beantragung</a>
                    </div>
                    
                    <button type="button" class="btn btn-success" onclick="saveAllSettings()" style="margin-top: 20px;">
                        üíæ Alle Einstellungen speichern
                    </button>
                </form>
                
                <div style="margin-top: 30px; padding: 15px; background: #e6f3ff; border-left: 4px solid #3182ce; border-radius: 4px;">
                    <strong>üí° Tipp:</strong> Drucke die Spezial-Barcodes aus und platziere sie an der Kasse f√ºr schnellen Zugriff.
                </div>
            </div>
        </div>

        <!-- Abrechnung Tab (vorher SEPA) -->
        <div id="billing" class="tab-content">
            <div class="section">
                <h2>üìã Getr√§nke-Abrechnung</h2>
                <p>W√§hle Mitglieder aus und erstelle monatliche Abrechnungen mit SEPA-Lastschriften oder Rechnungslisten.</p>
                
                <div class="toolbar" style="margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="createBillingFromSelection()" id="createBillingBtn" disabled>
                        üí≥ Ausgew√§hlte abrechnen (<span id="selectedBillingCount">0</span>)
                    </button>
                    <button class="btn btn-secondary" onclick="loadOpenBalances()">
                        üîÑ Offene Betr√§ge neu laden
                    </button>
                    <button class="btn btn-secondary" onclick="loadBillingHistory()">
                        üìú Abrechnungshistorie anzeigen
                    </button>
                </div>

                <div id="openBalancesSection" style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: #667eea;">üìä Offene Betr√§ge (nicht abgerechnet)</h3>
                    
                    <div style="background: #fff5e6; padding: 15px; border-left: 4px solid #ed8936; border-radius: 4px; margin-bottom: 15px;">
                        <strong>Gesamtsumme nicht abgerechnet:</strong> 
                        <span id="totalOpenAmount" style="font-size: 1.2em; color: #e53e3e;">0.00‚Ç¨</span> 
                        (<span id="openUsersCount">0</span> Benutzer mit Schulden)
                        <br>
                        <strong>Ausgew√§hlt:</strong> 
                        <span id="selectedOpenAmount" style="font-size: 1.2em; color: #667eea;">0.00‚Ç¨</span> 
                        (<span id="selectedBillingCount2">0</span> Benutzer)
                    </div>
                    
                    <table class="data-table" id="openBalancesTable">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <input type="checkbox" id="selectAllBilling" onchange="toggleSelectAllBilling()">
                                </th>
                                <th>Name</th>
                                <th>Offener Betrag</th>
                                <th>SEPA</th>
                                <th>E-Mail</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 30px; color: #666;">
                                    Lade offene Betr√§ge...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <hr style="margin: 30px 0; border: none; border-top: 2px solid #e2e8f0;">

                <h3 style="margin-bottom: 15px; color: #667eea;">üìú Abrechnungshistorie</h3>
                <table class="data-table" id="billingHistoryTable">
                    <thead>
                        <tr>
                            <th>Rechnungsnummer</th>
                            <th>Datum</th>
                            <th>Gesamtbetrag</th>
                            <th>SEPA-Nutzer</th>
                            <th>Nicht-SEPA</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px; color: #666;">
                                Noch keine Abrechnungen erstellt
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Abrechnungs-Details Modal -->
        <div id="billingDetailsModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3 id="billingDetailsTitle">Abrechnungs-Details</h3>
                    <span class="close" onclick="closeModal('billingDetailsModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="billingDetailsContent">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Produkt bearbeiten</h3>
                <span class="close" onclick="closeModal('productModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId" value="">
                    <input type="hidden" id="currentImageUrl" value="">
                    <input type="hidden" id="currentImagePath" value="">
                    
                    <div class="form-group">
                        <label>Produktfoto</label>
                        <div class="photo-upload" id="photoUpload" onclick="triggerFileInput()">
                            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                            <div class="photo-preview-container" id="photoPreviewContainer">
                                <div id="photoPlaceholder">
                                    <p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p>
                                    <p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p>
                                </div>
                            </div>
                            <div class="photo-upload-progress" id="uploadProgress">
                                Lade hoch... 0%
                            </div>
                        </div>
                        <div class="photo-actions" id="photoActions">
                            <button type="button" class="btn btn-secondary" onclick="triggerFileInput()">
                                üîÑ Bild √§ndern
                            </button>
                            <button type="button" class="btn btn-danger" onclick="removePhoto()">
                                üóëÔ∏è Entfernen
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Produktname *</label>
                        <input type="text" id="productName" required>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Kategorie</label>
                            <select id="productCategory">
                                <option value="bier">üç∫ Bier</option>
                                <option value="softdrinks">ü•§ Softdrinks</option>
                                <option value="schnaps">ü•É Spirituosen</option>
                                <option value="snacks">üçø Snacks</option>
                                <option value="heissgetraenke">‚òï Hei√ügetr√§nke</option>
                                <option value="sonstiges">üì¶ Sonstiges</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Emoji/Icon (Fallback)</label>
                            <input type="text" id="productEmoji" placeholder="üç∫" maxlength="2">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Mitgliedspreis (‚Ç¨) *</label>
                            <input type="number" id="productMemberPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Gastpreis (‚Ç¨) *</label>
                            <input type="number" id="productGuestPrice" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Aktueller Bestand</label>
                            <input type="number" id="productStock" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label>Mindestbestand</label>
                            <input type="number" id="productMinStock" min="0" value="5">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Barcodes (optional, mit Enter trennen)</label>
                        <textarea id="productBarcodes" rows="3" placeholder="4000417025001&#10;5000112637447"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productAvailable" checked>
                            Verf√ºgbar
                        </label>
                    </div>
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('productModal')">
                            Abbrechen
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveProduct()" id="saveProductBtn">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Mitglied bearbeiten</h3>
                <span class="close" onclick="closeModal('userModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId" value="">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Vorname *</label>
                            <input type="text" id="userFirstName" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Nachname *</label>
                            <input type="text" id="userLastName" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Barcodes * (mit Enter trennen)</label>
                        <textarea id="userBarcodes" rows="3" placeholder="SAAR001&#10;ALT123" required></textarea>
                        <small style="color: #666;">Jeder Barcode in eine neue Zeile</small>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Rolle</label>
                            <select id="userRole">
                                <option value="member">üë• Mitglied</option>
                                <option value="guest">üë§ Gast</option>
                                <option value="bartender">üç∫ Barkeeper</option>
                                <option value="admin">‚öôÔ∏è Administrator</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Saldo (‚Ç¨)</label>
                            <input type="number" id="userBalance" step="0.01" value="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>E-Mail</label>
                        <input type="email" id="userEmail">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="userSepaActive">
                            SEPA-Lastschrift aktiv
                        </label>
                    </div>
                    
                    <div class="form-group" id="ibanGroup" style="display: none;">
                        <label>IBAN</label>
                        <input type="text" id="userIban" placeholder="DE89 3704 0044 0532 0130 00">
                    </div>
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">
                            Abbrechen
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveUser()" id="saveUserBtn">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // ============ GLOBALE VARIABLEN ============
        let apiConnected = false;
        let users = [];
        let products = [];
        let selectedUsers = [];
        let selectedProducts = [];
        let currentImageFile = null;
        let uploadedImageUrl = null;
        let transactions = [];
        let allTransactions = [];
        let sepaUsers = [];

        // ============ API FUNCTIONS ============
        
        async function apiCall(endpoint, options = {}) {
            try {
                showLoading(true);
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateApiStatus(true);
                return data;
                
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                updateApiStatus(false, error.message);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // ============ IMAGE UPLOAD FUNCTIONS ============
        
        async function uploadImageToAPI(imageFile, productId) {
            try {
                const base64 = await fileToBase64(imageFile);
                
                const uploadData = {
                    image: base64,
                    fileName: imageFile.name,
                    productId: productId
                };

                const result = await apiCall('/api/upload-image', {
                    method: 'POST',
                    body: JSON.stringify(uploadData)
                });

                return result;
            } catch (error) {
                console.error('Image upload error:', error);
                throw error;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function deleteImageFromAPI(filePath) {
            try {
                await apiCall('/api/delete-image', {
                    method: 'DELETE',
                    body: JSON.stringify({ filePath })
                });
            } catch (error) {
                console.error('Image delete error:', error);
            }
        }

        // ============ PHOTO UPLOAD UI FUNCTIONS ============
        
        function triggerFileInput() {
            try {
                const fileInput = document.getElementById('photoInput');
                if (fileInput) {
                    fileInput.click();
                } else {
                    console.error('Photo input not found');
                }
            } catch (error) {
                console.error('Error triggering file input:', error);
            }
        }

        window.addEventListener('error', function(e) {
            console.error('Global JavaScript error:', e.error);
            
            if (e.error && e.error.message && e.error.message.includes('placeholder')) {
                console.warn('Photo placeholder error detected - this is handled gracefully');
                return;
            }
            
            if (e.error && e.error.message && e.error.message.includes('JSON')) {
                showAlert('Datenfehler aufgetreten - Seite neu laden empfohlen', 'error');
            }
        });

        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showAlert('Datei zu gro√ü. Maximum 2MB erlaubt.', 'error');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showAlert('Nur Bilddateien erlaubt.', 'error');
                return;
            }

            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        showPhotoPreview(e.target.result);
                        console.log('‚úÖ Image preview loaded successfully');
                    } catch (error) {
                        console.error('Error showing preview:', error);
                        showAlert('Fehler beim Anzeigen der Bildvorschau', 'error');
                    }
                };
                reader.onerror = function() {
                    showAlert('Fehler beim Lesen der Bilddatei', 'error');
                };
                reader.readAsDataURL(file);

                currentImageFile = file;
                uploadedImageUrl = null;
                
            } catch (error) {
                console.error('Error in handlePhotoUpload:', error);
                showAlert('Fehler beim Verarbeiten des Bildes', 'error');
            }
        }

        function showPhotoPreview(imageSrc, isUploaded = false) {
            const container = document.getElementById('photoPreviewContainer');
            const actions = document.getElementById('photoActions');
            
            if (!container) {
                console.error('Photo preview container not found');
                return;
            }
            
            container.innerHTML = `
                <img src="${imageSrc}" class="photo-preview" alt="Produktfoto">
                <div id="photoPlaceholder" style="display: none;">
                    <p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p>
                    <p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p>
                </div>
            `;
            
            container.classList.add('has-image');
            
            if (actions) {
                actions.style.display = 'block';
            }

            if (isUploaded) {
                uploadedImageUrl = imageSrc;
            }
            
            console.log('‚úÖ Photo preview shown successfully');
        }

        function removePhoto() {
            const container = document.getElementById('photoPreviewContainer');
            const actions = document.getElementById('photoActions');
            
            if (!container) {
                console.error('Photo preview container not found');
                return;
            }
            
            container.innerHTML = `
                <div id="photoPlaceholder">
                    <p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p>
                    <p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p>
                </div>
            `;
            
            container.classList.remove('has-image');
            
            if (actions) {
                actions.style.display = 'none';
            }
            
            const photoInput = document.getElementById('photoInput');
            if (photoInput) {
                photoInput.value = '';
            }
            
            currentImageFile = null;
            uploadedImageUrl = null;
            
            console.log('‚úÖ Photo removed successfully');
        }

        function resetPhotoPreview() {
            removePhoto();
        }

        // ============ UI FUNCTIONS ============
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function updateApiStatus(connected, errorMsg = '') {
            const statusEl = document.getElementById('apiStatus');
            apiConnected = connected;
            
            if (connected) {
                statusEl.className = 'api-status connected';
                statusEl.textContent = '‚úÖ API verbunden';
            } else {
                statusEl.className = 'api-status error';
                statusEl.textContent = `‚ùå API-Fehler`;
            }
        }

        function showAlert(message, type = 'info') {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert && !existingAlert.classList.contains('alert-info')) {
                existingAlert.remove();
            }

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            alertDiv.innerHTML = `<span>${icon}</span><div>${message}</div>`;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.children[1]);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 4000);
        }

        // ============ TAB NAVIGATION ============
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ============ SELECTION FUNCTIONS ============
        
        function toggleSelectAll(type) {
            const checkbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const isChecked = checkbox.checked;
            
            const checkboxes = document.querySelectorAll(`#${type}Table tbody input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
                toggleRowSelection(cb, type);
            });
            
            updateSelectionInfo(type);
        }

        function toggleRowSelection(checkbox, type) {
            const row = checkbox.closest('tr');
            const id = parseInt(checkbox.value);
            
            if (checkbox.checked) {
                row.classList.add('selected');
                if (type === 'users') {
                    if (!selectedUsers.includes(id)) selectedUsers.push(id);
                } else if (type === 'products') {
                    if (!selectedProducts.includes(id)) selectedProducts.push(id);
                }
            } else {
                row.classList.remove('selected');
                if (type === 'users') {
                    selectedUsers = selectedUsers.filter(userId => userId !== id);
                } else if (type === 'products') {
                    selectedProducts = selectedProducts.filter(productId => productId !== id);
                }
            }
            
            updateSelectionInfo(type);
        }

        function updateSelectionInfo(type) {
            let count, buttons;
            
            if (type === 'users') {
                count = selectedUsers.length;
                buttons = ['editUserBtn', 'deleteUserBtn'];
                document.getElementById('userSelectionInfo').textContent = `${count} ausgew√§hlt`;
            } else if (type === 'products') {
                count = selectedProducts.length;
                buttons = ['editProductBtn', 'deleteProductBtn'];
                document.getElementById('productSelectionInfo').textContent = `${count} ausgew√§hlt`;
            }
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btnId.includes('edit')) {
                    btn.disabled = count !== 1;
                } else {
                    btn.disabled = count === 0;
                }
            });
        }

        // ============ DATA LOADING FUNCTIONS ============
        
        async function loadDashboard() {
            try {
                const data = await apiCall('/api/dashboard');
                
                document.getElementById('memberCount').textContent = data.member_count || 0;
                document.getElementById('productCount').textContent = data.available_products || 0;
                document.getElementById('transactionCount').textContent = data.today_transactions || 0;
                document.getElementById('todayRevenue').textContent = `${(data.today_revenue || 0).toFixed(0)}`;
                
            } catch (error) {
                console.error('Fehler beim Laden der Dashboard-Daten:', error);
                showAlert('Fehler beim Laden der Dashboard-Statistiken', 'error');
            }
        }

        // ============ USER FUNCTIONS ============

        function openUserModal(userId = null) {
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const form = document.getElementById('userForm');
            
            form.reset();
            document.getElementById('userId').value = '';
            
            if (userId) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    title.textContent = 'Mitglied bearbeiten';
                    
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userFirstName').value = user.first_name;
                    document.getElementById('userLastName').value = user.last_name;
                    document.getElementById('userBarcodes').value = (user.barcodes || []).join('\n');
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userBalance').value = user.balance.toFixed(2);
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userSepaActive').checked = user.sepa_active || false;
                    document.getElementById('userIban').value = user.iban || '';
                    
                    toggleIbanField();
                }
            } else {
                title.textContent = 'Neues Mitglied hinzuf√ºgen';
                document.getElementById('userBalance').value = '0.00';
                document.getElementById('userRole').value = 'member';
            }
            
            modal.style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('userFirstName').focus();
            }, 150);
        }

        function editSelectedUser() {
            if (selectedUsers.length !== 1) return;
            openUserModal(selectedUsers[0]);
        }

        async function saveUser() {
            const saveBtn = document.getElementById('saveUserBtn');
            const userId = document.getElementById('userId').value;
            
            const barcodes = document.getElementById('userBarcodes').value
                .split('\n')
                .map(b => b.trim().toUpperCase())
                .filter(b => b.length > 0);
            
            const userData = {
                first_name: document.getElementById('userFirstName').value.trim(),
                last_name: document.getElementById('userLastName').value.trim(),
                barcodes: barcodes,
                role: document.getElementById('userRole').value,
                balance: parseFloat(document.getElementById('userBalance').value) || 0,
                email: document.getElementById('userEmail').value.trim() || null,
                sepa_active: document.getElementById('userSepaActive').checked,
                iban: document.getElementById('userIban').value.trim() || null
            };
            
            if (!userData.first_name || !userData.last_name || barcodes.length === 0) {
                showAlert('Bitte alle Pflichtfelder ausf√ºllen (mind. 1 Barcode)', 'error');
                return;
            }
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Speichere...';
                
                if (userId) {
                    await apiCall(`/api/users/${userId}`, {
                        method: 'PUT',
                        body: JSON.stringify(userData)
                    });
                    showAlert('Mitglied erfolgreich aktualisiert', 'success');
                } else {
                    await apiCall('/api/users', {
                        method: 'POST',
                        body: JSON.stringify(userData)
                    });
                    showAlert('Neues Mitglied erfolgreich hinzugef√ºgt', 'success');
                }
                
                closeModal('userModal');
                loadUsers();
                loadDashboard();
                
            } catch (error) {
                showAlert(error.message || 'Fehler beim Speichern des Mitglieds', 'error');
                console.error('Save user error:', error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Speichern';
            }
        }

        async function deleteSelectedUsers() {
            if (selectedUsers.length === 0) return;
            
            const userNames = selectedUsers.map(id => {
                const user = users.find(u => u.id === id);
                return user ? `${user.first_name} ${user.last_name}` : 'Unbekannt';
            }).join(', ');
            
            if (confirm(`M√∂chten Sie diese ${selectedUsers.length} Mitglieder wirklich l√∂schen?\n\n${userNames}\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                try {
                    for (const userId of selectedUsers) {
                        await apiCall(`/api/users/${userId}`, { method: 'DELETE' });
                    }
                    showAlert(`${selectedUsers.length} Mitglieder erfolgreich gel√∂scht`, 'success');
                    loadUsers();
                    loadDashboard();
                } catch (error) {
                    showAlert('Fehler beim L√∂schen der Mitglieder', 'error');
                }
            }
        }

        function toggleIbanField() {
            const sepaCheckbox = document.getElementById('userSepaActive');
            const ibanGroup = document.getElementById('ibanGroup');
            
            if (sepaCheckbox.checked) {
                ibanGroup.style.display = 'block';
            } else {
                ibanGroup.style.display = 'none';
            }
        }
        
        async function loadUsers() {
            try {
                const loadBtn = document.getElementById('loadUsersBtn');
                loadBtn.disabled = true;
                loadBtn.textContent = '‚è≥ Lade...';
                
                users = await apiCall('/api/users');
                renderUsers();
                showAlert(`${users.length} Mitglieder erfolgreich geladen`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der Benutzer:', error);
                showAlert('Fehler beim Laden der Mitgliederdaten', 'error');
            } finally {
                const loadBtn = document.getElementById('loadUsersBtn');
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ Neu laden';
            }
        }

        function renderUsers() {
            const tbody = document.querySelector('#userTable tbody');
            selectedUsers = [];
            updateSelectionInfo('users');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #666;">Keine Mitgliederdaten verf√ºgbar</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const balanceColor = user.balance >= 0 ? '#38a169' : '#e53e3e';
                const roleIcon = getRoleIcon(user.role);
                const sepaStatus = user.sepa_active ? '‚úÖ' : '‚ùå';
                
                return `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" value="${user.id}" onchange="toggleRowSelection(this, 'users')">
                        </td>
                        <td>${user.first_name} ${user.last_name}</td>
                        <td>${roleIcon} ${getRoleText(user.role)}</td>
                        <td><code style="font-size: 0.8em;">${user.barcodes ? user.barcodes.join(', ') : '-'}</code></td>
                        <td style="color: ${balanceColor}; font-weight: bold;">${user.balance.toFixed(2)}‚Ç¨</td>
                        <td>${sepaStatus}</td>
                        <td style="font-size: 0.8em;">${user.email || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============ PRODUCT FUNCTIONS ============

        async function loadProducts() {
            try {
                const loadBtn = document.getElementById('loadProductsBtn');
                loadBtn.disabled = true;
                loadBtn.textContent = '‚è≥ Lade...';
                
                products = await apiCall('/api/products');
                renderProducts();
                showAlert(`${products.length} Produkte erfolgreich geladen`, 'success');
                
            } catch (error) {
                console.error('Fehler beim Laden der Produkte:', error);
                showAlert('Fehler beim Laden der Produktdaten', 'error');
            } finally {
                const loadBtn = document.getElementById('loadProductsBtn');
                loadBtn.disabled = false;
                loadBtn.textContent = 'üîÑ Neu laden';
            }
        }

        function renderProducts() {
            const tbody = document.querySelector('#productTable tbody');
            selectedProducts = [];
            updateSelectionInfo('products');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">Keine Produktdaten verf√ºgbar</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => {
                const stockColor = product.stock > 0 ? '#38a169' : '#e53e3e';
                
                let imageHtml;
                if (product.image_url) {
                    imageHtml = `<img src="${product.image_url}" class="product-image-preview" alt="${product.name}" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="product-emoji-fallback" style="display: none;">${product.image || 'üì¶'}</div>`;
                } else if (product.image) {
                    imageHtml = `<div class="product-emoji-fallback">${product.image}</div>`;
                } else {
                    imageHtml = `<div class="product-emoji-fallback">üì¶</div>`;
                }
                
                return `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" value="${product.id}" onchange="toggleRowSelection(this, 'products')">
                        </td>
                        <td class="product-image-cell">${imageHtml}</td>
                        <td>${product.name}</td>
                        <td>${getCategoryText(product.category)}</td>
                        <td>${product.member_price.toFixed(2)}‚Ç¨</td>
                        <td>${product.guest_price.toFixed(2)}‚Ç¨</td>
                        <td style="color: ${stockColor}; font-weight: bold;">${product.stock}</td>
                        <td><code style="font-size: 0.8em;">${product.barcodes ? product.barcodes.join(', ') : '-'}</code></td>
                    </tr>
                `;
            }).join('');
        }

        function openProductModal(productId = null) {
            try {
                const modal = document.getElementById('productModal');
                const title = document.getElementById('productModalTitle');
                const form = document.getElementById('productForm');
                
                if (!modal || !title || !form) {
                    console.error('Modal-Elemente nicht gefunden');
                    showAlert('Fehler: Modal nicht verf√ºgbar', 'error');
                    return;
                }
                
                form.reset();
                document.getElementById('productId').value = '';
                document.getElementById('currentImageUrl').value = '';
                document.getElementById('currentImagePath').value = '';
                
                try {
                    resetPhotoPreview();
                } catch (resetError) {
                    console.warn('Photo reset warning:', resetError);
                    const container = document.getElementById('photoPreviewContainer');
                    if (container) {
                        container.innerHTML = `
                            <div id="photoPlaceholder">
                                <p style="margin: 10px 0;">üì∑ Klicken oder Bild hierher ziehen</p>
                                <p style="font-size: 0.8em; color: #666;">JPG, PNG bis 2MB</p>
                            </div>
                        `;
                        container.classList.remove('has-image');
                    }
                }
                
                if (productId) {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        title.textContent = 'Produkt bearbeiten';
                        
                        document.getElementById('productId').value = product.id || '';
                        document.getElementById('productName').value = product.name || '';
                        document.getElementById('productCategory').value = product.category || 'sonstiges';
                        document.getElementById('productEmoji').value = product.image || '';
                        document.getElementById('productMemberPrice').value = (product.member_price || 0).toFixed(2);
                        document.getElementById('productGuestPrice').value = (product.guest_price || 0).toFixed(2);
                        document.getElementById('productStock').value = product.stock || 0;
                        document.getElementById('productMinStock').value = product.min_stock || 5;
                        
                        const barcodesValue = product.barcodes 
                            ? (Array.isArray(product.barcodes) ? product.barcodes : [product.barcodes]) 
                            : (product.barcode ? [product.barcode] : []);
                        document.getElementById('productBarcodes').value = barcodesValue.join('\n');
                        
                        document.getElementById('productAvailable').checked = product.available !== false;
                        
                        if (product.image_url && typeof product.image_url === 'string') {
                            try {
                                document.getElementById('currentImageUrl').value = product.image_url;
                                document.getElementById('currentImagePath').value = product.image_file_path || '';
                                
                                const img = new Image();
                                img.onload = function() {
                                    try {
                                        showPhotoPreview(product.image_url, true);
                                    } catch (showError) {
                                        console.warn('Error showing existing image:', showError);
                                    }
                                };
                                img.onerror = function() {
                                    console.warn('Existing image could not be loaded:', product.image_url);
                                };
                                img.src = product.image_url;
                                
                            } catch (imageError) {
                                console.warn('Fehler beim Verarbeiten des Produktbildes:', imageError);
                            }
                        }
                    } else {
                        console.error('Produkt nicht gefunden:', productId);
                        showAlert('Produkt nicht gefunden', 'error');
                        return;
                    }
                } else {
                    title.textContent = 'Neues Produkt hinzuf√ºgen';
                    document.getElementById('productStock').value = '0';
                    document.getElementById('productMinStock').value = '5';
                    document.getElementById('productAvailable').checked = true;
                }
                
                modal.style.display = 'block';
                
                setTimeout(() => {
                    const firstInput = form.querySelector('input[type="text"]');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 150);
                
                console.log('‚úÖ Product modal opened successfully');
                
            } catch (error) {
                console.error('‚ùå Fehler beim √ñffnen des Produkt-Modals:', error);
                showAlert('Fehler beim √ñffnen des Bearbeiten-Dialogs', 'error');
            }
        }

        function editSelectedProduct() {
            if (selectedProducts.length !== 1) return;
            openProductModal(selectedProducts[0]);
        }

        async function saveProduct() {
            const saveBtn = document.getElementById('saveProductBtn');
            const productId = document.getElementById('productId').value;
            
            const barcodes = document.getElementById('productBarcodes').value
                .split('\n')
                .map(b => b.trim())
                .filter(b => b.length > 0);
            
            const productData = {
                name: document.getElementById('productName').value.trim(),
                category: document.getElementById('productCategory').value,
                image: document.getElementById('productEmoji').value.trim() || 'üì¶',
                member_price: parseFloat(document.getElementById('productMemberPrice').value) || 0,
                guest_price: parseFloat(document.getElementById('productGuestPrice').value) || 0,
                stock: parseInt(document.getElementById('productStock').value) || 0,
                min_stock: parseInt(document.getElementById('productMinStock').value) || 0,
                barcodes: barcodes,
                available: document.getElementById('productAvailable').checked
            };
            
            if (!productData.name || productData.member_price <= 0 || productData.guest_price <= 0) {
                showAlert('Bitte alle Pflichtfelder korrekt ausf√ºllen', 'error');
                return;
            }

            try {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Speichere...';

                if (currentImageFile) {
                    showAlert('Lade Produktbild hoch...', 'info');
                    const uploadResult = await uploadImageToAPI(currentImageFile, productId || 'new');
                    productData.image_url = uploadResult.imageUrl;
                    productData.image_file_path = uploadResult.filePath;
                    
                    if (productId && document.getElementById('currentImagePath').value) {
                        productData.deleteOldImage = true;
                    }
                } else if (uploadedImageUrl) {
                    productData.image_url = uploadedImageUrl;
                    productData.image_file_path = document.getElementById('currentImagePath').value;
                }
                
                if (productId) {
                    await apiCall(`/api/products/${productId}`, {
                        method: 'PUT',
                        body: JSON.stringify(productData)
                    });
                    showAlert('Produkt erfolgreich aktualisiert', 'success');
                } else {
                    await apiCall('/api/products', {
                        method: 'POST',
                        body: JSON.stringify(productData)
                    });
                    showAlert('Neues Produkt erfolgreich hinzugef√ºgt', 'success');
                }
                
                closeModal('productModal');
                loadProducts();
                loadDashboard();
                
            } catch (error) {
                showAlert('Fehler beim Speichern des Produkts', 'error');
                console.error('Save product error:', error);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'üíæ Speichern';
            }
        }

        async function deleteSelectedProducts() {
            if (selectedProducts.length === 0) return;
            
            const productNames = selectedProducts.map(id => {
                const product = products.find(p => p.id === id);
                return product ? product.name : 'Unbekannt';
            }).join(', ');
            
            if (confirm(`M√∂chten Sie diese ${selectedProducts.length} Produkte wirklich l√∂schen?\n\n${productNames}\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden.`)) {
                try {
                    for (const productId of selectedProducts) {
                        await apiCall(`/api/products/${productId}`, { method: 'DELETE' });
                    }
                    showAlert(`${selectedProducts.length} Produkte erfolgreich gel√∂scht`, 'success');
                    loadProducts();
                    loadDashboard();
                } catch (error) {
                    showAlert('Fehler beim L√∂schen der Produkte', 'error');
                }
            }
        }

        // ============ TRANSACTIONS FUNCTIONS ============

        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions');
                const data = await response.json();
                allTransactions = data;
                transactions = data;
                renderTransactions();
                updateTransactionSummary();
            } catch (error) {
                console.error('Fehler beim Laden der Transaktionen:', error);
                alert('Fehler beim Laden der Transaktionen');
            }
        }

        function renderTransactions() {
            const tbody = document.querySelector('#transactionTable tbody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #666;">Keine Transaktionen gefunden</td></tr>';
                return;
            }
            
            tbody.innerHTML = transactions.map(t => {
                const date = new Date(t.created_at);
                const formattedDate = date.toLocaleDateString('de-DE');
                const formattedTime = date.toLocaleTimeString('de-DE');
                
                return `
                    <tr>
                        <td>${formattedDate}<br><small>${formattedTime}</small></td>
                        <td>${t.user_name}</td>
                        <td>${t.product_name}</td>
                        <td>${t.quantity}</td>
                        <td>${t.price.toFixed(2)}‚Ç¨</td>
                        <td><strong>${t.total.toFixed(2)}‚Ç¨</strong></td>
                        <td>${t.payment_method === 'balance' ? 'Saldo' : t.payment_method}</td>
                    </tr>
                `;
            }).join('');
        }

        function filterTransactions() {
            const filter = document.getElementById('transactionFilter').value;
            const now = new Date();
            
            if (filter === 'all') {
                transactions = allTransactions;
            } else if (filter === 'today') {
                const today = now.toISOString().split('T')[0];
                transactions = allTransactions.filter(t => t.created_at.startsWith(today));
            } else if (filter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                transactions = allTransactions.filter(t => new Date(t.created_at) >= weekAgo);
            } else if (filter === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                transactions = allTransactions.filter(t => new Date(t.created_at) >= monthAgo);
            }
            
            renderTransactions();
            updateTransactionSummary();
        }

        function updateTransactionSummary() {
            const summary = document.getElementById('transactionSummary');
            const totalRevenue = transactions.reduce((sum, t) => sum + t.total, 0);
            
            document.getElementById('transactionCountSpan').textContent = transactions.length;
            document.getElementById('totalRevenue').textContent = totalRevenue.toFixed(2);
            
            summary.style.display = 'block';
        }

        function exportTransactions() {
            if (transactions.length === 0) {
                alert('Keine Transaktionen zum Exportieren');
                return;
            }
            
            const csv = [
                ['Datum', 'Zeit', 'Mitglied', 'Produkt', 'Menge', 'Preis', 'Gesamt', 'Zahlungsart'].join(';'),
                ...transactions.map(t => {
                    const date = new Date(t.created_at);
                    return [
                        date.toLocaleDateString('de-DE'),
                        date.toLocaleTimeString('de-DE'),
                        t.user_name,
                        t.product_name,
                        t.quantity,
                        t.price.toFixed(2),
                        t.total.toFixed(2),
                        t.payment_method
                    ].join(';');
                })
            ].join('\n');
            
            downloadFile(csv, 'transaktionen.csv', 'text/csv');
        }

        // ============ SETTINGS FUNCTIONS (vorher BARCODES) ============

        async function loadAllSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                // Barcode-Einstellungen
                if (settings.checkout_barcode) {
                    document.getElementById('checkoutBarcode').value = settings.checkout_barcode;
                }
                if (settings.cancel_barcode) {
                    document.getElementById('cancelBarcode').value = settings.cancel_barcode;
                }
                if (settings.reset_barcode) {
                    document.getElementById('resetBarcode').value = settings.reset_barcode;
                }

                // SEPA-Einstellungen
                if (settings.creditor_name) {
                    document.getElementById('creditorName').value = settings.creditor_name;
                }
                if (settings.creditor_id) {
                    document.getElementById('creditorId').value = settings.creditor_id;
                }
                if (settings.creditor_iban) {
                    document.getElementById('creditorIban').value = settings.creditor_iban;
                }
                if (settings.creditor_bic) {
                    document.getElementById('creditorBic').value = settings.creditor_bic;
                }
                if (settings.sepa_reference) {
                    document.getElementById('sepaReference').value = settings.sepa_reference;
                }
                if (settings.sepa_sequence_type) {
                    document.getElementById('sepaSequenceType').value = settings.sepa_sequence_type;
                }
            } catch (error) {
                console.log('Keine gespeicherten Einstellungen gefunden, verwende Standardwerte');
            }
        }

        async function saveAllSettings() {
            const settings = {
                // Barcode-Einstellungen
                checkout_barcode: document.getElementById('checkoutBarcode').value,
                cancel_barcode: document.getElementById('cancelBarcode').value,
                reset_barcode: document.getElementById('resetBarcode').value,
                
                // SEPA-Einstellungen
                creditor_name: document.getElementById('creditorName').value,
                creditor_id: document.getElementById('creditorId').value,
                creditor_iban: document.getElementById('creditorIban').value.replace(/\s/g, ''),
                creditor_bic: document.getElementById('creditorBic').value,
                sepa_reference: document.getElementById('sepaReference').value,
                sepa_sequence_type: document.getElementById('sepaSequenceType').value
            };

            // Validierung der Pflichtfelder
            if (!settings.creditor_name || !settings.creditor_id || !settings.creditor_iban) {
                alert('‚ö†Ô∏è Bitte f√ºlle alle SEPA-Pflichtfelder aus:\n- Vereinsname\n- Gl√§ubiger-ID\n- Vereins-IBAN');
                return;
            }
            
            try {
                await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                showAlert('Alle Einstellungen erfolgreich gespeichert', 'success');
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                showAlert('Fehler beim Speichern der Einstellungen', 'error');
            }
        }

        // ============ BILLING FUNCTIONS (vorher SEPA) ============

        let billings = [];
        let currentBillingData = null;
        let currentUserBillingData = null;
        let selectedBillingUsers = [];  // NEU
        let usersWithDebt = [];          // NEU

        async function loadOpenBalances() {
            try {
                const allUsers = await apiCall('/api/users');
                usersWithDebt = allUsers.filter(u => u.balance < 0);
                selectedBillingUsers = [];
                
                const tbody = document.querySelector('#openBalancesTable tbody');
                
                if (usersWithDebt.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #666;">Keine offenen Betr√§ge - alle Mitglieder haben positiven oder ausgeglichenen Saldo</td></tr>';
                    document.getElementById('totalOpenAmount').textContent = '0.00‚Ç¨';
                    document.getElementById('openUsersCount').textContent = '0';
                    document.getElementById('selectAllBilling').checked = false;
                    updateBillingSelection();
                    return;
                }
                
                const totalOpen = usersWithDebt.reduce((sum, u) => sum + Math.abs(u.balance), 0);
                
                document.getElementById('totalOpenAmount').textContent = totalOpen.toFixed(2) + '‚Ç¨';
                document.getElementById('openUsersCount').textContent = usersWithDebt.length;
                document.getElementById('selectAllBilling').checked = false;
                
                tbody.innerHTML = usersWithDebt.map(user => `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" value="${user.id}" onchange="toggleBillingUser(this)">
                        </td>
                        <td>${user.first_name} ${user.last_name}</td>
                        <td style="color: #e53e3e; font-weight: bold;">${Math.abs(user.balance).toFixed(2)}‚Ç¨</td>
                        <td>${user.sepa_active && user.iban ? '‚úÖ SEPA' : '‚ùå Manuell'}</td>
                        <td style="font-size: 0.85em;">${user.email || '-'}</td>
                    </tr>
                `).join('');
                
                updateBillingSelection();
                
            } catch (error) {
                console.error('Fehler beim Laden der offenen Betr√§ge:', error);
                showAlert('Fehler beim Laden der offenen Betr√§ge', 'error');
            }
        }

        function toggleSelectAllBilling() {
            const checkbox = document.getElementById('selectAllBilling');
            const checkboxes = document.querySelectorAll('#openBalancesTable tbody input[type="checkbox"]');
            
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const userId = parseInt(cb.value);
                if (checkbox.checked) {
                    if (!selectedBillingUsers.includes(userId)) {
                        selectedBillingUsers.push(userId);
                    }
                } else {
                    selectedBillingUsers = selectedBillingUsers.filter(id => id !== userId);
                }
            });
            
            updateBillingSelection();
        }

        function toggleBillingUser(checkbox) {
            const userId = parseInt(checkbox.value);
            
            if (checkbox.checked) {
                if (!selectedBillingUsers.includes(userId)) {
                    selectedBillingUsers.push(userId);
                }
            } else {
                selectedBillingUsers = selectedBillingUsers.filter(id => id !== userId);
            }
            
            updateBillingSelection();
        }

        function updateBillingSelection() {
            const selectedUsers = usersWithDebt.filter(u => selectedBillingUsers.includes(u.id));
            const selectedAmount = selectedUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
            
            document.getElementById('selectedOpenAmount').textContent = selectedAmount.toFixed(2) + '‚Ç¨';
            document.getElementById('selectedBillingCount').textContent = selectedUsers.length;
            document.getElementById('selectedBillingCount2').textContent = selectedUsers.length;
            
            const createBtn = document.getElementById('createBillingBtn');
            createBtn.disabled = selectedUsers.length === 0;
        }
        
        async function createBillingFromSelection() {
            if (selectedBillingUsers.length === 0) {
                showAlert('Bitte w√§hle mindestens ein Mitglied aus', 'error');
                return;
            }

            const selectedUsers = usersWithDebt.filter(u => selectedBillingUsers.includes(u.id));
            const totalAmount = selectedUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
            const sepaCount = selectedUsers.filter(u => u.sepa_active && u.iban).length;
            const nonSepaCount = selectedUsers.length - sepaCount;

            const confirmMessage = `M√∂chtest du wirklich ${selectedUsers.length} Mitglieder abrechnen?

Gesamtbetrag: ${totalAmount.toFixed(2)}‚Ç¨
- SEPA-Lastschrift: ${sepaCount} Mitglieder
- Manuelle Abrechnung: ${nonSepaCount} Mitglieder

Nach der Abrechnung werden die Salden auf 0‚Ç¨ gesetzt.`;

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showLoading(true);
                
                const sepaUsers = selectedUsers.filter(u => u.sepa_active && u.iban);
                const nonSepaUsers = selectedUsers.filter(u => !u.sepa_active || !u.iban);
                
                const now = new Date();
                const billingNumber = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
                
                const sepaAmount = sepaUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
                const nonSepaAmount = nonSepaUsers.reduce((sum, u) => sum + Math.abs(u.balance), 0);
                
                const billingData = {
                    billing_number: billingNumber,
                    total_amount: totalAmount,
                    sepa_amount: sepaAmount,
                    non_sepa_amount: nonSepaAmount,
                    sepa_user_count: sepaUsers.length,
                    non_sepa_user_count: nonSepaUsers.length,
                    status: 'completed'
                };
                
                const billing = await apiCall('/api/billings', {
                    method: 'POST',
                    body: JSON.stringify(billingData)
                });
                
                if (selectedBillingUsers.length > 0) {
                    await apiCall('/api/transactions/mark-billed', {
                        method: 'POST',
                        body: JSON.stringify({
                            billing_id: billing.id,
                            user_ids: selectedBillingUsers
                        })
                    });
                }
                
                for (const user of selectedUsers) {
                    await apiCall(`/api/users/${user.id}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            ...user,
                            balance: 0
                        })
                    });
                }
                
                showAlert(`‚úÖ Abrechnung ${billingNumber} erfolgreich erstellt!\n\nSEPA: ${sepaUsers.length} Benutzer (${sepaAmount.toFixed(2)}‚Ç¨)\nManuell: ${nonSepaUsers.length} Benutzer (${nonSepaAmount.toFixed(2)}‚Ç¨)`, 'success');
                
                const sepaUsersWithAmount = sepaUsers.map(u => ({
                    ...u,
                    billing_amount: Math.abs(u.balance)
                }));
                
                const nonSepaUsersWithAmount = nonSepaUsers.map(u => ({
                    ...u,
                    billing_amount: Math.abs(u.balance)
                }));
                
                showBillingDetails(billing, sepaUsersWithAmount, nonSepaUsersWithAmount);
                
                await loadOpenBalances();
                await loadBillingHistory();
                await loadDashboard();
                
            } catch (error) {
                console.error('Fehler beim Erstellen der Abrechnung:', error);
                showAlert('Fehler beim Erstellen der Abrechnung: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function loadBillingHistory() {
            try {
                billings = await apiCall('/api/billings');
                renderBillingHistory();
            } catch (error) {
                console.error('Fehler beim Laden der Abrechnungshistorie:', error);
                showAlert('Fehler beim Laden der Abrechnungshistorie', 'error');
            }
        }

        function renderBillingHistory() {
            const tbody = document.querySelector('#billingHistoryTable tbody');
            
            if (billings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #666;">Noch keine Abrechnungen erstellt</td></tr>';
                return;
            }
            
            // Sortiere nach Datum absteigend
            billings.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            tbody.innerHTML = billings.map(billing => {
                const date = new Date(billing.created_at);
                const formattedDate = date.toLocaleDateString('de-DE') + ' ' + date.toLocaleTimeString('de-DE');
                
                return `
                    <tr>
                        <td><strong>${billing.billing_number}</strong></td>
                        <td>${formattedDate}</td>
                        <td><strong>${billing.total_amount.toFixed(2)}‚Ç¨</strong></td>
                        <td>${billing.sepa_user_count} (${billing.sepa_amount.toFixed(2)}‚Ç¨)</td>
                        <td>${billing.non_sepa_user_count} (${billing.non_sepa_amount.toFixed(2)}‚Ç¨)</td>
                        <td>
                            <button class="btn" onclick="viewBillingDetails(${billing.id})" style="padding: 5px 10px; font-size: 0.8em;">
                                üëÅÔ∏è Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function viewBillingDetails(billingId) {
            try {
                showLoading(true);
                
                // Lade Abrechnungs-Details
                const billing = billings.find(b => b.id === billingId);
                if (!billing) {
                    showAlert('Abrechnung nicht gefunden', 'error');
                    return;
                }
                
                // Lade alle Transaktionen dieser Abrechnung
                const transactions = await apiCall(`/api/billings/${billingId}/transactions`);
                
                // Lade alle betroffenen Benutzer
                const userIds = [...new Set(transactions.map(t => t.user_id))];
                const usersData = await Promise.all(
                    userIds.map(id => apiCall(`/api/users/${id}`).catch(() => null))
                );
                const usersMap = {};
                usersData.filter(u => u).forEach(u => usersMap[u.id] = u);
                
                // Gruppiere nach SEPA/Nicht-SEPA
                const sepaUsers = [];
                const nonSepaUsers = [];
                
                userIds.forEach(userId => {
                    const user = usersMap[userId];
                    if (!user) return;
                    
                    const userTransactions = transactions.filter(t => t.user_id === userId);
                    const userTotal = userTransactions.reduce((sum, t) => sum + t.total, 0);
                    
                    const userData = {
                        ...user,
                        billing_amount: userTotal,
                        transaction_count: userTransactions.length
                    };
                    
                    if (user.sepa_active && user.iban) {
                        sepaUsers.push(userData);
                    } else {
                        nonSepaUsers.push(userData);
                    }
                });
                
                showBillingDetails(billing, sepaUsers, nonSepaUsers);
                
            } catch (error) {
                console.error('Fehler beim Laden der Details:', error);
                showAlert('Fehler beim Laden der Abrechnungs-Details', 'error');
            } finally {
                showLoading(false);
            }
        }

        function showBillingDetails(billing, sepaUsers, nonSepaUsers) {
            const modal = document.getElementById('billingDetailsModal');
            const title = document.getElementById('billingDetailsTitle');
            const content = document.getElementById('billingDetailsContent');
            
            title.textContent = `Abrechnung ${billing.billing_number}`;
            
            const sepaTotal = sepaUsers.reduce((sum, u) => sum + (u.billing_amount || Math.abs(u.balance) || 0), 0);
            const nonSepaTotal = nonSepaUsers.reduce((sum, u) => sum + (u.billing_amount || Math.abs(u.balance) || 0), 0);
            
            let html = `
                <div style="margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px;">
                    <p><strong>Datum:</strong> ${new Date(billing.created_at).toLocaleString('de-DE')}</p>
                    <p><strong>Gesamtbetrag:</strong> ${billing.total_amount.toFixed(2)}‚Ç¨</p>
                    <p><strong>Status:</strong> ${billing.status === 'completed' ? '‚úÖ Abgeschlossen' : billing.status}</p>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #e2e8f0;">
                
                <h3 style="color: #38a169; margin-bottom: 15px;">üí≥ SEPA-Lastschrift (${sepaUsers.length} Mitglieder - ${sepaTotal.toFixed(2)}‚Ç¨)</h3>
            `;
            
            if (sepaUsers.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="exportSepaForBilling(${billing.id})">
                            üìÑ SEPA-XML exportieren
                        </button>
                        <button class="btn btn-success" onclick="exportSepaCSVForBilling(${billing.id})">
                            üìä CSV exportieren
                        </button>
                    </div>
                    <table class="data-table" style="font-size: 0.85em;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>IBAN</th>
                                <th>E-Mail</th>
                                <th>Betrag</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sepaUsers.map(u => {
                                const amount = u.billing_amount || Math.abs(u.balance) || 0;
                                return `
                                    <tr>
                                        <td>${u.first_name} ${u.last_name}</td>
                                        <td><code style="font-size: 0.85em;">${u.iban || '-'}</code></td>
                                        <td style="font-size: 0.85em;">${u.email || '-'}</td>
                                        <td><strong>${amount.toFixed(2)}‚Ç¨</strong></td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="background: #e6f3ff; font-weight: bold;">
                                <td colspan="3" style="text-align: right;">Summe SEPA:</td>
                                <td>${sepaTotal.toFixed(2)}‚Ç¨</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } else {
                html += '<p style="color: #666; padding: 15px; background: #f8fafc; border-radius: 6px;">Keine SEPA-Nutzer in dieser Abrechnung</p>';
            }
            
            html += `
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #e2e8f0;">
                
                <h3 style="color: #ed8936; margin-bottom: 15px;">üìã Manuelle Abrechnung (${nonSepaUsers.length} Mitglieder - ${nonSepaTotal.toFixed(2)}‚Ç¨)</h3>
            `;
            
            if (nonSepaUsers.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-warning" onclick="exportNonSepaList(${billing.id})">
                            üìÑ Liste exportieren
                        </button>
                    </div>
                    <table class="data-table" style="font-size: 0.85em;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>E-Mail</th>
                                <th>SEPA-Status</th>
                                <th>Betrag</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${nonSepaUsers.map(u => {
                                const amount = u.billing_amount || Math.abs(u.balance) || 0;
                                const sepaStatus = !u.sepa_active ? '‚ùå Nicht aktiviert' : (!u.iban ? '‚ö†Ô∏è IBAN fehlt' : '?');
                                return `
                                    <tr>
                                        <td>${u.first_name} ${u.last_name}</td>
                                        <td style="font-size: 0.85em;">${u.email || '-'}</td>
                                        <td style="font-size: 0.85em;">${sepaStatus}</td>
                                        <td><strong>${amount.toFixed(2)}‚Ç¨</strong></td>
                                    </tr>
                                `;
                            }).join('')}
                            <tr style="background: #fff5e6; font-weight: bold;">
                                <td colspan="3" style="text-align: right;">Summe Manuell:</td>
                                <td>${nonSepaTotal.toFixed(2)}‚Ç¨</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } else {
                html += '<p style="color: #666; padding: 15px; background: #f8fafc; border-radius: 6px;">Keine Nicht-SEPA-Nutzer in dieser Abrechnung</p>';
            }
            
            content.innerHTML = html;
            currentBillingData = { billing, sepaUsers, nonSepaUsers };
            modal.style.display = 'block';
        }
        async function exportSepaForBilling(billingId) {
            if (!currentBillingData || !currentBillingData.sepaUsers) {
                showAlert('Keine SEPA-Daten verf√ºgbar', 'error');
                return;
            }

            const { billing, sepaUsers } = currentBillingData;

            if (sepaUsers.length === 0) {
                alert('Keine SEPA-Benutzer in dieser Abrechnung');
                return;
            }

            // Lade SEPA-Einstellungen
            let settings = {};
            try {
                const response = await fetch('/api/settings');
                settings = await response.json();
            } catch (error) {
                alert('‚ö†Ô∏è SEPA-Einstellungen konnten nicht geladen werden.\n\nBitte konfiguriere zuerst die SEPA-Daten im Einstellungen-Tab.');
                return;
            }

            if (!settings.creditor_id || !settings.creditor_iban || !settings.creditor_name) {
                alert('‚ö†Ô∏è SEPA-Einstellungen unvollst√§ndig! Bitte im Einstellungen-Tab konfigurieren.');
                return;
            }
            
            const now = new Date();
            const msgId = `${billing.billing_number}`;
            const totalAmount = sepaUsers.reduce((sum, u) => sum + u.billing_amount, 0).toFixed(2);
            
            const executionDate = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            const formattedDate = executionDate.toISOString().split('T')[0];
            
            const sequenceType = settings.sepa_sequence_type || 'RCUR';
            const reference = settings.sepa_reference || 'Saarcade Getraenkeabrechnung';
            
            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<Document xmlns="urn:iso:std:iso:20022:tech:xsd:pain.008.001.02" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <CstmrDrctDbtInitn>
        <GrpHdr>
            <MsgId>${msgId}</MsgId>
            <CreDtTm>${now.toISOString()}</CreDtTm>
            <NbOfTxs>${sepaUsers.length}</NbOfTxs>
            <CtrlSum>${totalAmount}</CtrlSum>
            <InitgPty>
                <Nm>${settings.creditor_name}</Nm>
            </InitgPty>
        </GrpHdr>
        <PmtInf>
            <PmtInfId>PMT-${billing.billing_number}</PmtInfId>
            <PmtMtd>DD</PmtMtd>
            <NbOfTxs>${sepaUsers.length}</NbOfTxs>
            <CtrlSum>${totalAmount}</CtrlSum>
            <PmtTpInf>
                <SvcLvl>
                    <Cd>SEPA</Cd>
                </SvcLvl>
                <LclInstrm>
                    <Cd>CORE</Cd>
                </LclInstrm>
                <SeqTp>${sequenceType}</SeqTp>
            </PmtTpInf>
            <ReqdColltnDt>${formattedDate}</ReqdColltnDt>
            <Cdtr>
                <Nm>${settings.creditor_name}</Nm>
            </Cdtr>
            <CdtrAcct>
                <Id>
                    <IBAN>${settings.creditor_iban.replace(/\s/g, '')}</IBAN>
                </Id>
            </CdtrAcct>
            <CdtrAgt>
                <FinInstnId>${settings.creditor_bic ? `<BIC>${settings.creditor_bic}</BIC>` : '<Othr><Id>NOTPROVIDED</Id></Othr>'}</FinInstnId>
            </CdtrAgt>
            <CdtrSchmeId>
                <Id>
                    <PrvtId>
                        <Othr>
                            <Id>${settings.creditor_id}</Id>
                            <SchmeNm>
                                <Prtry>SEPA</Prtry>
                            </SchmeNm>
                        </Othr>
                    </PrvtId>
                </Id>
            </CdtrSchmeId>
`;

            sepaUsers.forEach((user) => {
                const endToEndId = `${billing.billing_number}-${user.id}`;
                const mandateId = `MANDATE-${user.id}`;
                
                xml += `
            <DrctDbtTxInf>
                <PmtId>
                    <EndToEndId>${endToEndId}</EndToEndId>
                </PmtId>
                <InstdAmt Ccy="EUR">${user.billing_amount.toFixed(2)}</InstdAmt>
                <DrctDbtTx>
                    <MndtRltdInf>
                        <MndtId>${mandateId}</MndtId>
                        <DtOfSgntr>2024-01-01</DtOfSgntr>
                    </MndtRltdInf>
                </DrctDbtTx>
                <DbtrAgt>
                    <FinInstnId>
                        <Othr>
                            <Id>NOTPROVIDED</Id>
                        </Othr>
                    </FinInstnId>
                </DbtrAgt>
                <Dbtr>
                    <Nm>${user.first_name} ${user.last_name}</Nm>
                </Dbtr>
                <DbtrAcct>
                    <Id>
                        <IBAN>${user.iban.replace(/\s/g, '')}</IBAN>
                    </Id>
                </DbtrAcct>
                <RmtInf>
                    <Ustrd>${reference} - ${billing.billing_number}</Ustrd>
                </RmtInf>
            </DrctDbtTxInf>
`;
            });

            xml += `
        </PmtInf>
    </CstmrDrctDbtInitn>
</Document>`;

            downloadFile(xml, `sepa_${billing.billing_number}.xml`, 'application/xml');
            showAlert(`SEPA-XML f√ºr Abrechnung ${billing.billing_number} exportiert`, 'success');
        }

        function exportSepaCSVForBilling(billingId) {
            if (!currentBillingData || !currentBillingData.sepaUsers) {
                showAlert('Keine SEPA-Daten verf√ºgbar', 'error');
                return;
            }

            const { billing, sepaUsers } = currentBillingData;
            
            if (sepaUsers.length === 0) {
                alert('Keine SEPA-Benutzer in dieser Abrechnung');
                return;
            }
            
            const csv = [
                ['Rechnungsnummer', 'Name', 'Vorname', 'E-Mail', 'IBAN', 'Betrag'].join(';'),
                ...sepaUsers.map(u => [
                    billing.billing_number,
                    u.last_name,
                    u.first_name,
                    u.email || '',
                    u.iban,
                    u.billing_amount.toFixed(2)
                ].join(';'))
            ].join('\n');
            
            downloadFile(csv, `sepa_${billing.billing_number}.csv`, 'text/csv');
        }

        function exportNonSepaList(billingId) {
            if (!currentBillingData || !currentBillingData.nonSepaUsers) {
                showAlert('Keine Nicht-SEPA-Daten verf√ºgbar', 'error');
                return;
            }

            const { billing, nonSepaUsers } = currentBillingData;
            
            if (nonSepaUsers.length === 0) {
                alert('Keine Nicht-SEPA-Benutzer in dieser Abrechnung');
                return;
            }
            
            // Erstelle formatierte Textdatei f√ºr Druck
            let text = `ZAHLUNGSAUFFORDERUNG - ${billing.billing_number}\n`;
            text += `Datum: ${new Date(billing.created_at).toLocaleDateString('de-DE')}\n`;
            text += `\n${'='.repeat(60)}\n\n`;
            text += `Folgende Mitglieder haben offene Betr√§ge zu begleichen:\n\n`;
            
            nonSepaUsers.forEach((user, index) => {
                text += `${index + 1}. ${user.first_name} ${user.last_name}\n`;
                text += `   E-Mail: ${user.email || 'nicht angegeben'}\n`;
                text += `   Betrag: ${user.billing_amount.toFixed(2)}‚Ç¨\n\n`;
            });
            
            text += `${'='.repeat(60)}\n`;
            text += `GESAMT: ${nonSepaUsers.reduce((sum, u) => sum + u.billing_amount, 0).toFixed(2)}‚Ç¨\n`;
            text += `\nBitte √ºberweisen Sie den Betrag auf das Vereinskonto.\n`;
            
            downloadFile(text, `nicht_sepa_${billing.billing_number}.txt`, 'text/plain');
            showAlert('Liste f√ºr Nicht-SEPA-Nutzer exportiert', 'success');
        }

        // ============ HELPER FUNCTIONS ============
        
        function getRoleIcon(role) {
            const icons = { member: 'üë•', guest: 'üë§', bartender: 'üç∫', admin: '‚öôÔ∏è' };
            return icons[role] || 'üë§';
        }

        function getRoleText(role) {
            const texts = { member: 'Mitglied', guest: 'Gast', bartender: 'Barkeeper', admin: 'Administrator' };
            return texts[role] || role;
        }

        function getCategoryText(category) {
            const categories = {
                bier: 'üç∫',
                softdrinks: 'ü•§',
                schnaps: 'ü•É',
                snacks: 'üçø',
                heissgetraenke: '‚òï',
                sonstiges: 'üì¶'
            };
            return categories[category] || category;
        }

        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
                
                currentImageFile = null;
                uploadedImageUrl = null;
                
                console.log('‚úÖ Modal closed successfully');
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ============ DRAG & DROP ============
        
        function initDragAndDrop() {
            const photoUpload = document.getElementById('photoUpload');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                photoUpload.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                photoUpload.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                photoUpload.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                photoUpload.classList.add('dragover');
            }

            function unhighlight(e) {
                photoUpload.classList.remove('dragover');
            }

            photoUpload.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    document.getElementById('photoInput').files = files;
                    handlePhotoUpload({ target: { files: files } });
                }
            }
        }

        // ============ INITIALIZATION ============
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Admin-Dashboard mit Bildupload startet...');
            
            try {
                await loadDashboard();
                await loadProducts();
                
                initDragAndDrop();
                loadAllSettings();
                loadOpenBalances(); // Lade offene Betr√§ge f√ºr Abrechnungs-Tab
                loadBillingHistory(); // Lade Abrechnungshistorie
                
                const sepaCheckbox = document.getElementById('userSepaActive');
                if (sepaCheckbox) {
                    sepaCheckbox.addEventListener('change', toggleIbanField);
                }
                
                console.log('‚úÖ Admin-Dashboard erfolgreich initialisiert');
                showAlert('Dashboard mit Abrechnungs-System geladen', 'success');
                
            } catch (error) {
                console.error('‚ùå Fehler bei der Initialisierung:', error);
                showAlert('Fehler beim Laden des Dashboards. Pr√ºfe die API-Verbindung.', 'error');
            }
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
